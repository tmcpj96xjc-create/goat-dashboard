<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Dashboard — MK3</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --fs: 16px;
      --bg: #e8eaee;
      --card: #ffffff;
      --ink: #111;
      --muted: #444;
      --line: #d4d7dd;
      --soft: rgba(0,0,0,.06);
      --good: rgba(0,140,0,.10);
      --warn: rgba(200,150,0,.12);
      --bad: rgba(180,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.92rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.25fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.05rem;font-weight:950;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{border-color:rgba(0,140,0,.35);background:var(--good)}
    .warn{border-color:rgba(200,150,0,.35);background:var(--warn)}
    .bad{border-color:rgba(180,0,0,.35);background:var(--bad)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .canvasBox{margin-top:10px}
    canvas{
      display:block;
      width:100% !important;
      height:290px !important;
      max-height:290px !important;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
    }
    .pillGroup{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .pill{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:8px 12px;font-weight:900;
    }
    .pill input{width:auto;padding:0;margin:0}
    .hint{font-size:.9rem;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* spinner overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(255,255,255,.65);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
    }
    .spinner{
      width:56px; height:56px;
      border:6px solid rgba(0,0,0,.14);
      border-top-color:rgba(0,0,0,.65);
      border-radius:50%;
      animation:spin 1s linear infinite;
      background:transparent;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
<div class="overlay" id="overlay"><div class="spinner" aria-label="Running"></div></div>

<div class="wrap">
  <h1>Goat Farm Dashboard — MK3 <span class="small">• Monte Carlo bands • P50/P90 • cull + mortality • batch vs rolling • sales freeze</span></h1>

  <!-- Global Controls -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops when herd on-farm reaches this size.">Target herd size</label>
          <input id="target" type="number" value="200" min="10" />
        </div>
        <div class="row">
          <label title="Comparison milestone used in Snapshot and Monte Carlo confidence.">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6" />
        </div>
        <div class="row">
          <label title="Hard cap for simulation length.">Max months (safety cap)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12" />
        </div>
      </div>
      <div>
        <div class="row">
          <label title="Adjust readability.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16" />
        </div>
        <div class="row">
          <label title="Compute and refresh all tabs.">Run model</label>
          <button id="runBtn">Run</button>
        </div>
        <div class="banner small" id="runNote">
          Charts remain static until you click <b>Run</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabSales">Sales Cycle</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
    <button class="tabBtn" data-tab="tabAdv">Advisory</button>
    <button class="tabBtn" data-tab="tabSave">Save / Load</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (goats bought at the start)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Young starting goats are treated as ~3 months old.">Start: Young does (3 months old)</label>
            <input id="startYoungDoes" type="number" value="4" min="0" />
          </div>
          <div class="row">
            <label title="Young starting goats are treated as ~3 months old.">Start: Young bucks (3 months old)</label>
            <input id="startYoungBucks" type="number" value="1" min="0" />
          </div>
        </div>
        <div>
          <div class="row">
            <label title="Adult starters become eligible after a short buffer.">Start: Adult ready does</label>
            <input id="startAdultDoes" type="number" value="0" min="0" />
          </div>
          <div class="row">
            <label title="Adult starters become eligible after a short buffer.">Start: Adult ready bucks</label>
            <input id="startAdultBucks" type="number" value="0" min="0" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Expansion purchases (months 4, 8, 12, 16, 20, 24, 28)</b>
      <div class="small">Expansion purchases are treated as “young” by default and follow the same maturity path as young starters.</div>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p4d" type="number" value="0" min="0" />
              <input id="p4b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 8: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p8d" type="number" value="0" min="0" />
              <input id="p8b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 12: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p12d" type="number" value="0" min="0" />
              <input id="p12b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 16: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p16d" type="number" value="0" min="0" />
              <input id="p16b" type="number" value="0" min="0" />
            </div>
          </div>
        </div>
        <div>
          <div class="row"><label>Month 20: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p20d" type="number" value="0" min="0" />
              <input id="p20b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 24: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p24d" type="number" value="0" min="0" />
              <input id="p24b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 28: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p28d" type="number" value="0" min="0" />
              <input id="p28b" type="number" value="0" min="0" />
            </div>
          </div>

          <div class="banner small" style="margin-top:10px">
            Purchases KPI shows total bought (does + bucks).
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total bought (does+bucks)</small><div class="v" id="k_buy_total">—</div></div>
        <div class="kpi"><small>Total bought does</small><div class="v" id="k_buy_does">—</div></div>
        <div class="kpi"><small>Total bought bucks</small><div class="v" id="k_buy_bucks">—</div></div>
        <div class="kpi"><small>First purchase month</small><div class="v" id="k_buy_first">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartPurchTotal"></canvas>
        <div class="small">Cumulative goats purchased over time.</div>
      </div>
    </div>
  </div>

  <!-- Goat Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Breeding + herd dynamics</b>

      <div class="pillGroup" aria-label="Growth presets">
        <label class="pill" title="Faster herd build.">
          <input type="radio" name="growthMode" id="modeAgg" />
          Aggressive growth
        </label>
        <label class="pill" title="Planning-safe baseline.">
          <input type="radio" name="growthMode" id="modeCon" checked />
          Conservative growth
        </label>

        <label class="pill" title="Monte Carlo adds uncertainty and confidence bands.">
          <input type="checkbox" id="mcOn" />
          Monte Carlo
        </label>

        <label class="pill" title="Show/hide P10–P90 band when Monte Carlo is ON.">
          <input type="checkbox" id="bandOn" checked />
          Confidence band (P10–P90)
        </label>

        <span class="pill" title="Fixed by design.">Retained doe first-try age: <b>8 months</b></span>
        <span class="pill" title="Fixed by design.">Gestation: <b>5 months</b></span>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Breeding cadence.">Kidding interval (months)</label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18" />
          </div>
          <div class="row">
            <label title="Pregnancy success probability per attempt.">Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label title="Average kids per birth.">Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1" />
          </div>
          <div class="row">
            <label title="After kidding, delay before a doe can conceive again.">Re-breed delay (months)</label>
            <input id="rebreedDelay" type="number" value="3" min="0" max="12" />
          </div>
        </div>

        <div>
          <div class="row">
            <label title="Female share of kids at birth.">Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60" />
          </div>
          <div class="row">
            <label title="Survival from birth through early life (baseline).">Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label title="Buck capacity definition: bucks × does-per-buck.">Does per buck</label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="50" />
          </div>
          <div class="row">
            <label title="Female kids retained to grow herd (rest are sold at 6 months unless sales frozen).">Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Mortality + replacement</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Cull breeding does (% per year). Removes a share of breeding does over time.">Cull rate (breeding does) % / year</label>
            <input id="cullYr" type="number" value="0" min="0" max="60" />
          </div>
          <div class="row">
            <label title="Adult mortality (% per year), applied monthly.">Death rate (adults) % / year</label>
            <input id="deathAdultYr" type="number" value="0" min="0" max="60" />
          </div>
        </div>
        <div>
          <div class="row">
            <label title="Kids/young mortality (% per year), applied monthly.">Death rate (kids/young) % / year</label>
            <input id="deathKidYr" type="number" value="0" min="0" max="60" />
          </div>
          <div class="row">
            <label title="Extra mortality applied only to newly purchased goats during their first N months on the farm (limited to their early pipeline in this model).">Purchase-stress mortality % / year</label>
            <div style="display:flex;gap:10px">
              <input id="deathStressYr" type="number" value="0" min="0" max="60" />
              <input id="deathStressN" type="number" value="3" min="0" max="12" title="Months stress applies (first N months after purchase)"/>
            </div>
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Breeding style</b>
      <div class="grid" style="margin-top:10px">
        <div class="row">
          <label title="Batch = all eligible does attempt on breeding month. Rolling = smoothed across months.">Breeding mode</label>
          <select id="breedMode">
            <option value="batch">Batch breeding</option>
            <option value="rolling">Rolling breeding</option>
          </select>
        </div>
        <div class="row">
          <label title="How many Monte Carlo simulations when enabled.">Monte Carlo sims (N)</label>
          <input id="mcN" type="number" value="200" min="50" max="2000" />
        </div>
      </div>

      <hr/>

      <b class="small">Sales assumptions (used for Sales Cycle + Money)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Male kids are sold at this age (unless sales frozen).">Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12" />
          </div>
          <div class="banner small">
            Rule: Male kids are always intended to sell at sale age. Female kids are retained % vs sold for breeding at 6 months. A sales freeze pauses both.
          </div>
        </div>
        <div>
          <div class="banner small">
            Fixed biology:<br/>
            • Retained females first try at <b>8 months</b><br/>
            • Gestation fixed at <b>5 months</b><br/>
            • Re-breed delay controls the post-kidding wait
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (deterministic)</small><div class="v" id="g_time">—</div></div>
        <div class="kpi"><small>P50 time to target (MC)</small><div class="v" id="g_p50">—</div></div>
        <div class="kpi"><small>P90 time to target (MC)</small><div class="v" id="g_p90">—</div></div>
        <div class="kpi"><small>Buck capacity status</small><div class="v" id="g_buck">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartTotalHerd"></canvas>
        <div class="small">Total herd on-farm over time. If Monte Carlo is ON, shows confidence band (P10–P90) plus deterministic line.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">Constraint: eligible does vs buck capacity, with bucks count shown on 2nd axis.</div>
      </div>
    </div>
  </div>

  <!-- Sales Cycle -->
  <div id="tabSales" class="tab">
    <div class="card">
      <b class="small">Sales Cycle</b>
      <div class="small">This tab shows when goats are sold (or held if sales are frozen).</div>

      <div class="grid" style="margin-top:10px">
        <div class="row">
          <label title="Freeze all sales for the first N months to prioritize herd growth.">Freeze sales (months)</label>
          <input id="freezeSalesMo" type="number" value="0" min="0" max="120" />
        </div>
        <div class="banner small">
          Freeze means: goats that reach sale age stay on the farm until sales resume.
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total goats sold (lifetime)</small><div class="v" id="s_totalSold">—</div></div>
        <div class="kpi"><small>Male goats sold</small><div class="v" id="s_maleSold">—</div></div>
        <div class="kpi"><small>Female goats sold</small><div class="v" id="s_femaleSold">—</div></div>
        <div class="kpi"><small>First sale month</small><div class="v" id="s_firstSale">—</div></div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><small>Total sales revenue (lifetime)</small><div class="v" id="s_revTot">—</div></div>
        <div class="kpi"><small>Sales by target month</small><div class="v" id="s_byTarget">—</div></div>
        <div class="kpi"><small>Sales by timeframe month</small><div class="v" id="s_byTimeframe">—</div></div>
        <div class="kpi"><small>Avg monthly sales (to horizon)</small><div class="v" id="s_avgSales">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartSales"></canvas>
        <div class="small">Monthly goats sold: males vs females (breeding sales). Whole numbers.</div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Currency label</label><input id="cur" value="UGX" /></div>

          <div class="row">
            <label title="Young goat purchase prices (starting young + expansion purchases).">Buy price: young doe / young buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyYoungDoe" type="number" value="400000" min="0" />
              <input id="buyYoungBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label title="Adult starter purchase prices (if you input adult starts).">Buy price: adult doe / adult buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyAdultDoe" type="number" value="400000" min="0" />
              <input id="buyAdultBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label title="Sale prices used for sales events.">Sale price: male / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellMale" type="number" value="250000" min="0" />
              <input id="sellFemale" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="banner small">
            Revenue is created only by sales. Purchases are costs (startup is month 0).
          </div>
        </div>

        <div>
          <div class="row"><label>Feed per goat / month</label><input id="feed" type="number" value="2500" min="0" /></div>
          <div class="row"><label>Medication per goat / month</label><input id="med" type="number" value="0" min="0" /></div>
          <div class="row"><label>Other variable per goat / month</label><input id="othVar" type="number" value="0" min="0" /></div>

          <div class="row"><label>Property / year</label><input id="propYr" type="number" value="1500000" min="0" /></div>
          <div class="row"><label>Labor / month</label><input id="laborMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Vet / month</label><input id="vetMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Security / month</label><input id="secMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Transport / month</label><input id="trMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Admin / month</label><input id="adMo" type="number" value="0" min="0" /></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Operational positive (month)</small><div class="v" id="m_opBE">—</div></div>
        <div class="kpi"><small>Farm break-even (month)</small><div class="v" id="m_fullBE">—</div></div>
        <div class="kpi"><small>Total revenue (to horizon)</small><div class="v" id="m_revTot">—</div></div>
        <div class="kpi"><small>Total costs (to horizon)</small><div class="v" id="m_costTot">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">Cumulative revenue vs cumulative costs (operating + purchases + startup). Whole numbers.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyNet"></canvas>
        <div class="small">Monthly net (all-in). Line turns green when net is positive, red when negative.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyRevCost"></canvas>
        <div class="small">Monthly revenue vs monthly operating cost (excludes purchase spend).</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Snapshot</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (deterministic)</small><div class="v" id="x_time">—</div></div>
        <div class="kpi"><small>P50 / P90 time to target (MC)</small><div class="v" id="x_p5090">—</div></div>
        <div class="kpi"><small>Target confidence by Month X (MC)</small><div class="v" id="x_conf">—</div></div>
        <div class="kpi"><small>Net position at target/horizon</small><div class="v" id="x_netTarget">—</div></div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><small>Total purchases spend (lifetime)</small><div class="v" id="x_purchSpend">—</div></div>
        <div class="kpi"><small>Total revenue to date (at horizon)</small><div class="v" id="x_revH">—</div></div>
        <div class="kpi"><small>Total costs to date (at horizon)</small><div class="v" id="x_costH">—</div></div>
        <div class="kpi"><small>Herd composition at target/horizon</small><div class="v" id="x_compTarget">—</div></div>
      </div>

      <div class="banner small" id="x_assump" style="margin-top:12px">
        <b>Assumptions used by this model (plain English):</b><br/>
        • Gestation is fixed at 5 months (≈150 days).<br/>
        • Retained female kids can first try to conceive at 8 months.<br/>
        • After a doe gives birth, she waits the re-breed delay before she can conceive again.<br/>
        • Breeding is limited by buck capacity = bucks × does-per-buck.<br/>
        • Male kids sell at your chosen age; female kids are retained % vs sold for breeding at 6 months (unless sales frozen).<br/>
        • Cull rate removes a % of breeding does per year (modeled monthly).<br/>
        • Mortality is split into kids/young vs adults (modeled monthly). Purchase-stress mortality applies only early on-farm (pipeline period).<br/>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">By horizon: Total Revenue vs Total Costs → Net position.</div>
      </div>
    </div>
  </div>

  <!-- Advisory -->
  <div id="tabAdv" class="tab">
    <div class="card">
      <b class="small">Advisory (simple)</b>
      <div class="banner small" id="advBox">
        Run the model to get advice.
      </div>
    </div>
  </div>

  <!-- Save / Load -->
  <div id="tabSave" class="tab">
    <div class="card">
      <b class="small">Save / Load scenario</b>
      <div class="small">Save inputs as JSON and reload later.</div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Scenario name</label><input id="scName" value="MK3-scenario" /></div>
          <button id="btnSave">Save scenario (download JSON)</button>
          <div class="hint">Tip: Keep your MK1 baseline file separately.</div>
        </div>
        <div>
          <div class="row"><label>Load scenario JSON</label><input id="fileLoad" type="file" accept=".json" /></div>
          <button id="btnApplyLoad">Apply loaded scenario</button>
          <div class="hint">After loading, click <b>Run</b> to refresh charts.</div>
        </div>
      </div>

      <div class="banner small" id="saveMsg" style="display:none;margin-top:10px"></div>
      <div class="banner small" id="loadMsg" style="display:none;margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/* -------------------- helpers -------------------- */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id).value||0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtInt=(n)=>Math.round(n).toLocaleString();
const money=(n)=>{
  const cur = ($("cur")?.value || "UGX").trim();
  return `${cur} ${Math.round(n).toLocaleString()}`;
};
function moFmt(mo){
  if(mo===null || mo===undefined) return "Never";
  if(!isFinite(mo)) return "Never";
  const y=Math.floor(mo/12), m=mo%12;
  return y?`${y}y ${m}m`:`${m} months`;
}
function randn(){
  // Box-Muller
  let u=0,v=0;
  while(u===0) u=Math.random();
  while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function jitterPct(base, sdPct, minVal, maxVal){
  const v = base * (1 + randn() * sdPct);
  return clamp(v, minVal, maxVal);
}
function percentile(sorted, p){
  if(sorted.length===0) return null;
  const idx = (sorted.length-1) * p;
  const lo = Math.floor(idx);
  const hi = Math.ceil(idx);
  if(lo===hi) return sorted[lo];
  const w = idx - lo;
  return sorted[lo]*(1-w) + sorted[hi]*w;
}

/* -------------------- tabs -------------------- */
(function initTabs(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $(b.dataset.tab).classList.add("active");
    });
  });
})();

/* -------------------- presets -------------------- */
const PRESET = {
  aggressive: {
    kiddingInt: 8,
    breedSuccess: 93,
    kidsPerBirth: 2.1,
    rebreedDelay: 3,
    retainF: 95
  },
  conservative: {
    kiddingInt: 12,
    breedSuccess: 90,
    kidsPerBirth: 1.8,
    rebreedDelay: 3,
    retainF: 85
  }
};
function applyPreset(name){
  const p = PRESET[name];
  $("kiddingInt").value = p.kiddingInt;
  $("breedSuccess").value = p.breedSuccess;
  $("kidsPerBirth").value = p.kidsPerBirth;
  $("rebreedDelay").value = p.rebreedDelay;
  $("retainF").value = p.retainF;
}
$("modeAgg").addEventListener("change", ()=>{ if($("modeAgg").checked) applyPreset("aggressive"); });
$("modeCon").addEventListener("change", ()=>{ if($("modeCon").checked) applyPreset("conservative"); });

/* -------------------- fixed biology -------------------- */
const FIX_GEST = 5;          // months
const FIX_FIRST_TRY = 8;     // months
const FIX_FEMALE_SALE_AGE = 6;

/* -------------------- purchases schedule -------------------- */
function purchAtMonth(m){
  let d=0,b=0;
  if(m===4){ d=N("p4d"); b=N("p4b"); }
  else if(m===8){ d=N("p8d"); b=N("p8b"); }
  else if(m===12){ d=N("p12d"); b=N("p12b"); }
  else if(m===16){ d=N("p16d"); b=N("p16b"); }
  else if(m===20){ d=N("p20d"); b=N("p20b"); }
  else if(m===24){ d=N("p24d"); b=N("p24b"); }
  else if(m===28){ d=N("p28d"); b=N("p28b"); }
  return {d,b};
}

/* -------------------- params -------------------- */
function getParams(){
  const target = clamp(N("target"), 10, 100000);
  const timeframe = clamp(N("timeframe"), 6, 240);
  const maxMonths = clamp(N("maxMonths"), 24, 360);

  const kiddingInt = clamp(N("kiddingInt"), 6, 18);
  const rebreedDelay = clamp(N("rebreedDelay"), 0, 12);
  const breedMode = ($("breedMode").value || "batch");

  const breedSuccess = clamp(N("breedSuccess"), 40, 100) / 100;
  const kidsPerBirth = clamp(Number($("kidsPerBirth").value||1.8), 1, 3.5);

  const pctFemale = clamp(N("pctFemale"), 40, 60) / 100;
  const kidSurvival = clamp(N("kidSurvival"), 40, 100) / 100;

  const doesPerBuck = clamp(N("doesPerBuck"), 5, 50);
  const retainF = clamp(N("retainF"), 0, 100) / 100;
  const maleSaleAge = clamp(N("maleSaleAge"), 1, 12);

  // mortality / replacement (annual)
  const cullYr = clamp(N("cullYr"), 0, 60) / 100;
  const deathAdultYr = clamp(N("deathAdultYr"), 0, 60) / 100;
  const deathKidYr = clamp(N("deathKidYr"), 0, 60) / 100;
  const deathStressYr = clamp(N("deathStressYr"), 0, 60) / 100;
  const deathStressN = clamp(N("deathStressN"), 0, 12);

  // sales freeze
  const freezeSalesMo = clamp(N("freezeSalesMo"), 0, maxMonths);

  // starting herd
  const startYoungDoes = clamp(N("startYoungDoes"), 0, 999999);
  const startYoungBucks = clamp(N("startYoungBucks"), 0, 999999);
  const startAdultDoes = clamp(N("startAdultDoes"), 0, 999999);
  const startAdultBucks = clamp(N("startAdultBucks"), 0, 999999);

  // money
  const buyYoungDoe = N("buyYoungDoe"), buyYoungBuck=N("buyYoungBuck");
  const buyAdultDoe = N("buyAdultDoe"), buyAdultBuck=N("buyAdultBuck");
  const sellMale=N("sellMale"), sellFemale=N("sellFemale");

  const feed=N("feed"), med=N("med"), othVar=N("othVar");
  const fixedMo=(N("propYr")/12)+N("laborMo")+N("vetMo")+N("secMo")+N("trMo")+N("adMo");

  return {
    target, timeframe, maxMonths,
    kiddingInt, rebreedDelay, breedMode,
    breedSuccess, kidsPerBirth,
    pctFemale, kidSurvival,
    doesPerBuck, retainF, maleSaleAge,
    cullYr, deathAdultYr, deathKidYr, deathStressYr, deathStressN,
    freezeSalesMo,
    startYoungDoes, startYoungBucks, startAdultDoes, startAdultBucks,
    buyYoungDoe, buyYoungBuck, buyAdultDoe, buyAdultBuck,
    sellMale, sellFemale,
    feed, med, othVar, fixedMo
  };
}

function annualToMonthlyRate(annual){
  // convert annual proportion (0..1) to equivalent monthly rate
  // (1 - r_m)^12 = (1 - r_y)
  if(annual<=0) return 0;
  return 1 - Math.pow(1-annual, 1/12);
}

/* -------------------- simulation -------------------- */
function simulate(p, stopAtMonth=null){
  const rows=[];

  // cohorts (can be fractional internally)
  const fRetCoh = Array(FIX_FIRST_TRY).fill(0);             // retained females 0..7 months
  const mCoh = Array(p.maleSaleAge).fill(0);                // male kids 0..saleAge-1
  const fSaleCoh = Array(FIX_FEMALE_SALE_AGE).fill(0);      // female-for-sale 0..5

  const preg = Array(FIX_GEST).fill(0);                     // pregnant months remaining buckets
  const rest = Array(p.rebreedDelay).fill(0);               // rest buckets

  // young starters: bought at 3 months; need 5 months on farm to reach 8 months
  const youngStarterF = Array(5).fill(0);
  const youngStarterM = Array(5).fill(0);
  youngStarterF[0] = p.startYoungDoes;
  youngStarterM[0] = p.startYoungBucks;

  // adult starters: 1-month buffer
  let adultBufferDoes = p.startAdultDoes;
  let adultBufferBucks = p.startAdultBucks;

  let breedingDoes = 0;
  let bucksActive = 0;

  // monthly rates
  const cullMo = annualToMonthlyRate(p.cullYr);
  const deathAdultMo = annualToMonthlyRate(p.deathAdultYr);
  const deathKidMo = annualToMonthlyRate(p.deathKidYr);
  const deathStressMo = annualToMonthlyRate(p.deathStressYr);

  // purchase stress tracking (first N months only)
  const stressN = p.deathStressN;
  const stressF = Array(stressN).fill(0);
  const stressM = Array(stressN).fill(0);
  const stressAdultD = Array(Math.min(1, stressN)).fill(0);
  const stressAdultB = Array(Math.min(1, stressN)).fill(0);

  // purchases tracking
  let cumBoughtDoes = p.startYoungDoes + p.startAdultDoes;
  let cumBoughtBucks = p.startYoungBucks + p.startAdultBucks;

  // money
  const startupSpend =
    p.startYoungDoes*p.buyYoungDoe +
    p.startYoungBucks*p.buyYoungBuck +
    p.startAdultDoes*p.buyAdultDoe +
    p.startAdultBucks*p.buyAdultBuck;

  let cumRev=0, cumCost=0;
  let cumNet = -startupSpend; // month 0 startup

  let opPosMonth = null;
  let farmBEMonth = null;

  // sales totals
  let totalMaleSold=0, totalFemaleSold=0;
  let firstSaleMonth = null;

  // monthly helper: herd inventory
  function sum(a){ return a.reduce((x,y)=>x+y,0); }

  function herdTotal(){
    const youngF = sum(fRetCoh);
    const maleKids = sum(mCoh);
    const femaleForSale = sum(fSaleCoh);
    const startersF = sum(youngStarterF);
    const startersM = sum(youngStarterM);
    const adultsWaiting = adultBufferDoes + adultBufferBucks;
    // breedingDoes includes pregnant/resting implicitly (we track state counts separately, but avoid double-counting)
    return (breedingDoes + bucksActive + youngF + maleKids + femaleForSale + startersF + startersM + adultsWaiting);
  }

  function eligibleDoes(){
    return Math.max(0, breedingDoes - sum(preg) - sum(rest));
  }

  function monthlyOperatingCost(inv){
    return inv * (p.feed + p.med + p.othVar) + p.fixedMo;
  }

  function applyCull(){
    if(cullMo<=0 || breedingDoes<=0) return;
    const before = breedingDoes;
    const removed = before * cullMo;
    breedingDoes = Math.max(0, breedingDoes - removed);
    const after = breedingDoes;

    // scale doe-state arrays to keep them consistent
    if(before>0 && after<before){
      const scale = after / before;
      for(let i=0;i<preg.length;i++) preg[i]*=scale;
      for(let i=0;i<rest.length;i++) rest[i]*=scale;
    }
  }

  function applyMortality(){
    // adults
    if(deathAdultMo>0){
      breedingDoes *= (1 - deathAdultMo);
      bucksActive  *= (1 - deathAdultMo);
      // also scale preg/rest since they’re subsets of does
      for(let i=0;i<preg.length;i++) preg[i] *= (1 - deathAdultMo);
      for(let i=0;i<rest.length;i++) rest[i] *= (1 - deathAdultMo);
    }

    // kids/young
    if(deathKidMo>0){
      for(let i=0;i<fRetCoh.length;i++) fRetCoh[i] *= (1 - deathKidMo);
      for(let i=0;i<mCoh.length;i++) mCoh[i] *= (1 - deathKidMo);
      for(let i=0;i<fSaleCoh.length;i++) fSaleCoh[i] *= (1 - deathKidMo);
      for(let i=0;i<youngStarterF.length;i++) youngStarterF[i] *= (1 - deathKidMo);
      for(let i=0;i<youngStarterM.length;i++) youngStarterM[i] *= (1 - deathKidMo);
    }

    // purchase stress (applies only to goats in stress buckets; we remove from their early pipelines proportionally)
    if(deathStressMo>0 && stressN>0){
      // We treat stress buckets as a “shadow” of newly purchased goats that should experience extra loss.
      // We apply extra loss to the first few pipeline months (youngStarter arrays) by subtracting from them, capped at their counts.
      const stressLossF = stressF.reduce((acc, c)=>acc + c*deathStressMo, 0);
      const stressLossM = stressM.reduce((acc, c)=>acc + c*deathStressMo, 0);

      // distribute loss proportionally across youngStarter pipelines
      const totYSF = sum(youngStarterF);
      const totYSM = sum(youngStarterM);
      if(totYSF>0 && stressLossF>0){
        const loss = Math.min(stressLossF, totYSF);
        for(let i=0;i<youngStarterF.length;i++){
          const share = youngStarterF[i]/totYSF;
          youngStarterF[i] = Math.max(0, youngStarterF[i] - loss*share);
        }
      }
      if(totYSM>0 && stressLossM>0){
        const loss = Math.min(stressLossM, totYSM);
        for(let i=0;i<youngStarterM.length;i++){
          const share = youngStarterM[i]/totYSM;
          youngStarterM[i] = Math.max(0, youngStarterM[i] - loss*share);
        }
      }

      // adult buffer stress (1 month)
      const adultLossD = stressAdultD.reduce((acc,c)=>acc + c*deathStressMo,0);
      const adultLossB = stressAdultB.reduce((acc,c)=>acc + c*deathStressMo,0);
      if(adultBufferDoes>0 && adultLossD>0) adultBufferDoes = Math.max(0, adultBufferDoes - Math.min(adultLossD, adultBufferDoes));
      if(adultBufferBucks>0 && adultLossB>0) adultBufferBucks = Math.max(0, adultBufferBucks - Math.min(adultLossB, adultBufferBucks));
    }

    // advance stress buckets
    if(stressN>0){
      for(let i=stressF.length-1;i>=1;i--) stressF[i]=stressF[i-1];
      stressF[0]=0;
      for(let i=stressM.length-1;i>=1;i--) stressM[i]=stressM[i-1];
      stressM[0]=0;
    }
    if(stressAdultD.length){
      stressAdultD[0]=0;
      stressAdultB[0]=0;
    }
  }

  // reached target?
  let reachedMonth = null;
  let targetIndex = null;

  // month loop
  for(let m=0; m<=p.maxMonths; m++){
    // 0) add adult starters into stress buffer
    if(m===0 && stressAdultD.length){
      stressAdultD[0] += adultBufferDoes;
      stressAdultB[0] += adultBufferBucks;
    }

    // 1) move adult starters from buffer to active after 1 month
    if(m===1){
      breedingDoes += adultBufferDoes;
      bucksActive += adultBufferBucks;
      adultBufferDoes = 0;
      adultBufferBucks = 0;
    }

    // 2) expansion purchases this month
    const pur = purchAtMonth(m);
    if(pur.d || pur.b){
      youngStarterF[0] += pur.d;
      youngStarterM[0] += pur.b;
      cumBoughtDoes += pur.d;
      cumBoughtBucks += pur.b;

      // track purchase stress (first N months)
      if(stressN>0){
        stressF[0] += pur.d;
        stressM[0] += pur.b;
      }
    }

    // 3) apply cull + mortality each month (before breeding and before sales)
    applyCull();
    applyMortality();

    // 4) advance young starter maturity (5 months on farm)
    {
      const outF = youngStarterF[youngStarterF.length-1] || 0;
      for(let i=youngStarterF.length-1;i>=1;i--) youngStarterF[i]=youngStarterF[i-1];
      youngStarterF[0]=0;
      breedingDoes += outF;

      const outM = youngStarterM[youngStarterM.length-1] || 0;
      for(let i=youngStarterM.length-1;i>=1;i--) youngStarterM[i]=youngStarterM[i-1];
      youngStarterM[0]=0;
      bucksActive += outM;
    }

    // 5) breeding: batch vs rolling
    let conceptions = 0;
    const elig = eligibleDoes();
    const capacityDoes = bucksActive * p.doesPerBuck;
    const attempted = Math.min(elig, capacityDoes);

    if(p.breedMode==="batch"){
      if(m>0 && (m % p.kiddingInt === 0)){
        conceptions = attempted * p.breedSuccess;
      }
    } else { // rolling
      // smoothed monthly conception fraction based on kidding interval
      const frac = 1 / Math.max(1, p.kiddingInt);
      conceptions = attempted * p.breedSuccess * frac;
    }

    // 6) pregnancy progression
    const birthsFrom = preg[preg.length-1] || 0;
    for(let i=preg.length-1;i>=1;i--) preg[i]=preg[i-1];
    preg[0] = conceptions;

    // 7) births
    let birthsKids = 0;
    if(birthsFrom>0){
      birthsKids = birthsFrom * p.kidsPerBirth * p.kidSurvival;
    }
    const fBorn = birthsKids * p.pctFemale;
    const mBorn = birthsKids - fBorn;

    // 8) rest after kidding
    if(p.rebreedDelay>0){
      // advance rest first
      for(let i=rest.length-1;i>=1;i--) rest[i]=rest[i-1];
      rest[0] = birthsFrom; // does that kidded go into rest month 0
    }

    // 9) allocate female kids to retain vs sell pipeline
    const fRet = fBorn * p.retainF;
    const fSale = fBorn - fRet;

    fRetCoh[0] += fRet;
    mCoh[0] += mBorn;
    fSaleCoh[0] += fSale;

    // 10) advance retained females; after 8 months they enter breeding pool
    {
      const toBreeding = fRetCoh[fRetCoh.length-1] || 0;
      for(let i=fRetCoh.length-1;i>=1;i--) fRetCoh[i]=fRetCoh[i-1];
      fRetCoh[0]=0;
      breedingDoes += toBreeding;
    }

    // 11) sales events (respect freeze)
    const frozen = (m < p.freezeSalesMo);

    let maleSold = 0;
    if(mCoh.length>0){
      const atSale = mCoh[mCoh.length-1] || 0;
      for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
      mCoh[0]=0;
      if(frozen){
        // keep sale-age males on farm by accumulating in last bucket
        mCoh[mCoh.length-1] += atSale;
        maleSold = 0;
      } else {
        maleSold = atSale;
      }
    }

    let femaleSold = 0;
    if(fSaleCoh.length>0){
      const atSale = fSaleCoh[fSaleCoh.length-1] || 0;
      for(let i=fSaleCoh.length-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
      fSaleCoh[0]=0;
      if(frozen){
        fSaleCoh[fSaleCoh.length-1] += atSale;
        femaleSold = 0;
      } else {
        femaleSold = atSale;
      }
    }

    if((maleSold + femaleSold) > 0 && firstSaleMonth===null){
      firstSaleMonth = m;
    }
    totalMaleSold += maleSold;
    totalFemaleSold += femaleSold;

    // 12) money
    const inv = herdTotal();
    const opCost = monthlyOperatingCost(inv);
    const purchaseSpend = (pur.d*p.buyYoungDoe) + (pur.b*p.buyYoungBuck); // startup handled separately
    const revenue = (maleSold * p.sellMale) + (femaleSold * p.sellFemale);

    cumRev += revenue;
    cumCost += (opCost + purchaseSpend);

    const net = revenue - opCost - purchaseSpend;
    cumNet += net;

    if(opPosMonth===null && revenue >= opCost) opPosMonth = m;
    if(farmBEMonth===null && cumNet >= 0) farmBEMonth = m;

    // 13) record row
    rows.push({
      m,
      herd: inv,
      breedingDoes,
      bucksActive,
      eligible: elig,
      capacityDoes,
      maleSold,
      femaleSold,
      revenue,
      opCost,
      purchaseSpend,
      net,
      cumRev,
      cumCost,
      cumNet,
      cumBought: cumBoughtDoes + cumBoughtBucks,
      cumBoughtDoes,
      cumBoughtBucks
    });

    // stop at requested month for bands collection
    if(stopAtMonth!==null && m>=stopAtMonth) break;

    // stop at target for deterministic / sim run
    if(reachedMonth===null && inv >= p.target){
      reachedMonth = m;
      targetIndex = rows.length-1;
      break;
    }
  }

  const horizonIndex = (targetIndex!==null) ? targetIndex : (rows.length-1);
  const horizonRow = rows[horizonIndex];

  return {
    rows,
    reachedMonth,
    horizonIndex,
    startupSpend,
    opPosMonth,
    farmBEMonth,
    totals: {
      totalMaleSold,
      totalFemaleSold,
      firstSaleMonth,
      cumRev: horizonRow?.cumRev ?? 0,
      cumCost: horizonRow?.cumCost ?? 0,
      cumNet: horizonRow?.cumNet ?? (-startupSpend),
      cumBoughtDoes,
      cumBoughtBucks
    }
  };
}

/* -------------------- Monte Carlo -------------------- */
function runMonteCarlo(baseP, detHorizonMonth){
  const Nsim = clamp(N("mcN"), 50, 2000);
  const reachMonths = [];
  const herdSeries = []; // array of arrays [m0..detHorizonMonth]
  const reachByTimeframe = [];

  for(let i=0;i<Nsim;i++){
    const p = structuredClone(baseP);

    // jitter biological rates (tight ranges)
    p.breedSuccess = jitterPct(baseP.breedSuccess, 0.04, 0.4, 0.995);
    p.kidsPerBirth = jitterPct(baseP.kidsPerBirth, 0.06, 1.0, 3.5);
    p.kidSurvival  = jitterPct(baseP.kidSurvival, 0.04, 0.4, 1.0);
    p.pctFemale    = clamp(baseP.pctFemale + randn()*0.02, 0.40, 0.60);
    // mortality + cull (small jitter, but keep >=0)
    p.deathAdultYr = clamp(baseP.deathAdultYr * (1 + randn()*0.15), 0, 0.60);
    p.deathKidYr   = clamp(baseP.deathKidYr   * (1 + randn()*0.15), 0, 0.60);
    p.cullYr       = clamp(baseP.cullYr       * (1 + randn()*0.15), 0, 0.60);
    p.deathStressYr = clamp(baseP.deathStressYr * (1 + randn()*0.20), 0, 0.60);

    // run until target or max (for time-to-target)
    const sim = simulate(p, null);
    const rm = (sim.reachedMonth===null) ? Infinity : sim.reachedMonth;
    reachMonths.push(rm);

    // reach by timeframe
    reachByTimeframe.push(rm <= baseP.timeframe ? 1 : 0);

    // run fixed horizon length for bands
    const simH = simulate(p, detHorizonMonth);
    const series = [];
    for(let m=0;m<=detHorizonMonth;m++){
      const r = simH.rows[m];
      series.push(r ? r.herd : (series.length?series[series.length-1]:0));
    }
    herdSeries.push(series);
  }

  // percentiles per month
  const p10=[], p50=[], p90=[];
  for(let m=0;m<=detHorizonMonth;m++){
    const vals = herdSeries.map(s=>s[m]).slice().sort((a,b)=>a-b);
    p10.push(percentile(vals, 0.10));
    p50.push(percentile(vals, 0.50));
    p90.push(percentile(vals, 0.90));
  }

  // time-to-target percentiles (Infinity => Never)
  const tt = reachMonths.slice().sort((a,b)=>a-b);
  const t50 = percentile(tt, 0.50);
  const t90 = percentile(tt, 0.90);

  const conf = reachByTimeframe.reduce((a,b)=>a+b,0) / reachByTimeframe.length;

  return { p10, p50, p90, t50, t90, conf };
}

/* -------------------- charts -------------------- */
let chPurch=null, chTotal=null, chCons=null, chSales=null, chCum=null, chNet=null, chMo=null, chWF=null;

function makeChart(canvasId, type, labels, datasets, options={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{labels:{color:"#111", font:{weight:"800"}}},
        tooltip:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}}
      },
      ...options
    }
  });
}

/* -------------------- advisory -------------------- */
function buildAdvice(p, sim){
  const rows = sim.rows;
  const last = rows[sim.horizonIndex] || rows[rows.length-1];
  if(!last) return "Run the model to get advice.";

  let limiter = "";
  if(last.capacityDoes===0 && last.bucksActive===0 && last.breedingDoes>0) limiter = "You have does but no active bucks. Add bucks or buy adult buck(s).";
  else if(last.eligible > last.capacityDoes) limiter = "Buck capacity is limiting. Add bucks or reduce does-per-buck.";
  else limiter = "Buck capacity looks OK. Main levers: kidding interval, re-breed delay, retention, mortality, and costs.";

  const mode = p.breedMode==="batch" ? "Batch breeding" : "Rolling breeding";
  const freeze = p.freezeSalesMo>0 ? `Sales frozen for first ${p.freezeSalesMo} months.` : "No sales freeze.";

  const moneyNote = (sim.farmBEMonth===null)
    ? "Farm break-even not reached within the simulated horizon. Improve net position by increasing sale prices, reducing costs, or slowing purchases."
    : `Farm break-even reached around ${moFmt(sim.farmBEMonth)}.`;

  return `
    <b>Limiting factor:</b> ${limiter}<br/><br/>
    <b>Breeding style:</b> ${mode}. Kidding interval ${p.kiddingInt}m, re-breed delay ${p.rebreedDelay}m.<br/>
    <b>Sales:</b> ${freeze}<br/>
    <b>Replacement / mortality:</b> Cull ${Math.round(p.cullYr*100)}%/yr, Adult death ${Math.round(p.deathAdultYr*100)}%/yr, Kid death ${Math.round(p.deathKidYr*100)}%/yr.<br/><br/>
    <b>Money:</b> ${moneyNote}
  `;
}

/* -------------------- save / load -------------------- */
let loadedScenario=null;

function getAllInputs(){
  const ids=[
    "target","timeframe","maxMonths","fontSize",
    "startYoungDoes","startYoungBucks","startAdultDoes","startAdultBucks",
    "p4d","p4b","p8d","p8b","p12d","p12b","p16d","p16b","p20d","p20b","p24d","p24b","p28d","p28b",
    "kiddingInt","breedSuccess","kidsPerBirth","rebreedDelay","pctFemale","kidSurvival","doesPerBuck","retainF","maleSaleAge",
    "cullYr","deathAdultYr","deathKidYr","deathStressYr","deathStressN",
    "breedMode","mcN","mcOn","bandOn",
    "freezeSalesMo",
    "cur","buyYoungDoe","buyYoungBuck","buyAdultDoe","buyAdultBuck","sellMale","sellFemale",
    "feed","med","othVar","propYr","laborMo","vetMo","secMo","trMo","adMo",
    "modeAgg","modeCon"
  ];
  const out={};
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio" || el.type==="checkbox") out[id]=el.checked;
    else out[id]=el.value;
  });
  return out;
}
function applyAllInputs(obj){
  Object.entries(obj||{}).forEach(([id,val])=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio" || el.type==="checkbox") el.checked=!!val;
    else el.value=val;
  });
}

/* -------------------- render -------------------- */
function runCore(){
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");

  const p = getParams();

  // Deterministic run
  const sim = simulate(p, null);
  const rows = sim.rows;
  if(!rows.length) return;

  const horizonIndex = sim.horizonIndex;
  const slice = rows.slice(0, horizonIndex+1);
  const labels = slice.map(r=>r.m);

  // Purchases KPIs
  const totB = sim.totals.cumBoughtDoes + sim.totals.cumBoughtBucks;
  $("k_buy_total").textContent = fmtInt(totB);
  $("k_buy_does").textContent = fmtInt(sim.totals.cumBoughtDoes);
  $("k_buy_bucks").textContent = fmtInt(sim.totals.cumBoughtBucks);

  let firstPur = null;
  for(const r of rows){
    if(r.purchaseSpend>0){ firstPur = r.m; break; }
  }
  $("k_buy_first").textContent = firstPur===null ? "None" : `Month ${firstPur}`;

  /// Purchases chart (purchases vs actual herd growth)
chPurch?.destroy();
chPurch = makeChart("chartPurchTotal","line",labels,[
  {
    label:"Cumulative goats bought",
    data:slice.map(r=>Math.round(r.cumBought)),
    borderWidth:3,
    tension:.25,
    pointRadius:0
  },
  {
    label:"Total herd on farm",
    data:slice.map(r=>Math.round(r.herd)),
    borderWidth:3,
    tension:.25,
    pointRadius:0,
    borderDash:[6,4]
  }
 {
    label:"Target herd size",
    data:labels.map(()=>Math.round(p.target)),
    borderWidth:2,
    pointRadius:0,
    borderDash:[2,6]
  }
  
],{
  scales:{ y:{beginAtZero:true} }
});

  // Constraint chart
  chCons?.destroy();
  chCons = makeChart("chartConstraint","line",labels,[
    {label:"Eligible does", data:slice.map(r=>Math.round(r.eligible)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y"},
    {label:"Buck capacity", data:slice.map(r=>Math.round(r.capacityDoes)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4], yAxisID:"y"},
    {label:"Bucks (count)", data:slice.map(r=>Math.round(r.bucksActive)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y2"}
  ],{
    scales:{
      y:{type:"linear", position:"left", beginAtZero:true, grid:{color:"rgba(0,0,0,.08)"}},
      y2:{type:"linear", position:"right", beginAtZero:true, grid:{drawOnChartArea:false}}
    }
  });

  // Goat Growth KPIs
  $("g_time").textContent = sim.reachedMonth===null ? `Not reached by ${p.maxMonths} months` : moFmt(sim.reachedMonth);

  const last = slice[slice.length-1];
  const util = (last.capacityDoes>0) ? last.eligible/last.capacityDoes : 0;
  $("g_buck").textContent =
    (last.capacityDoes===0 && last.breedingDoes>0) ? "No bucks"
    : (last.eligible > last.capacityDoes) ? "Limiting (add bucks)"
    : (util>0.85) ? "Tight"
    : "Healthy";

  // Monte Carlo (optional) for total herd chart + P50/P90
  const mcEnabled = $("mcOn").checked;
  let mc = null;
  if(mcEnabled){
    const detHorizonMonth = slice[slice.length-1].m; // align band horizon to deterministic horizon
    mc = runMonteCarlo(p, detHorizonMonth);
  }

  // Total herd chart (deterministic + optional band)
  chTotal?.destroy();
  const herdDet = slice.map(r=>Math.round(r.herd));

  // Build datasets
  const ds = [];
  if(mcEnabled && $("bandOn").checked){
    const p10 = mc.p10.map(x=>Math.round(x));
    const p90 = mc.p90.map(x=>Math.round(x));
    const p50 = mc.p50.map(x=>Math.round(x));

    // band via two lines with fill between
    ds.push({
      label:"P90",
      data:p90,
      borderWidth:2,
      tension:.25,
      pointRadius:0,
      fill:false
    });
    ds.push({
      label:"P10",
      data:p10,
      borderWidth:2,
      tension:.25,
      pointRadius:0,
      fill:{target:0} // fill to previous dataset (P90)
    });
    ds.push({
      label:"P50",
      data:p50,
      borderWidth:3,
      tension:.25,
      pointRadius:0
    });
  }

  ds.push({
    label:"Deterministic",
    data:herdDet,
    borderWidth:4,
    tension:.25,
    pointRadius:0
  });

  chTotal = makeChart("chartTotalHerd","line",labels,ds,{ scales:{ y:{beginAtZero:true} } });

  // P50/P90 KPIs
  if(mcEnabled){
    $("g_p50").textContent = moFmt(isFinite(mc.t50)?Math.round(mc.t50):Infinity);
    $("g_p90").textContent = moFmt(isFinite(mc.t90)?Math.round(mc.t90):Infinity);
  } else {
    $("g_p50").textContent = "—";
    $("g_p90").textContent = "—";
  }

  // Sales Cycle
  const maleSoldTot = Math.round(sim.totals.totalMaleSold);
  const femSoldTot = Math.round(sim.totals.totalFemaleSold);
  $("s_totalSold").textContent = fmtInt(maleSoldTot + femSoldTot);
  $("s_maleSold").textContent = fmtInt(maleSoldTot);
  $("s_femaleSold").textContent = fmtInt(femSoldTot);
  $("s_firstSale").textContent = sim.totals.firstSaleMonth===null ? "Never" : `Month ${sim.totals.firstSaleMonth}`;

  // total sales revenue (lifetime)
  $("s_revTot").textContent = money(sim.totals.cumRev);

  const idxTarget = sim.horizonIndex;
  const idxTimeframe = Math.min(rows.length-1, p.timeframe);
  const sumUpTo = (arrIdx, key)=> rows.slice(0, arrIdx+1).reduce((a,r)=>a + (r[key]||0),0);

  const soldByTarget = Math.round(sumUpTo(idxTarget,"maleSold") + sumUpTo(idxTarget,"femaleSold"));
  const soldByTime = Math.round(sumUpTo(idxTimeframe,"maleSold") + sumUpTo(idxTimeframe,"femaleSold"));
  $("s_byTarget").textContent = fmtInt(soldByTarget);
  $("s_byTimeframe").textContent = fmtInt(soldByTime);

  const avgSales = (idxTarget>0) ? (soldByTarget/(idxTarget+1)) : 0;
  $("s_avgSales").textContent = `${Math.round(avgSales)} / mo`;

  // Sales chart
  chSales?.destroy();
  chSales = makeChart("chartSales","bar",labels,[
    {label:"Male sold", data:slice.map(r=>Math.round(r.maleSold)), borderWidth:1},
    {label:"Female sold", data:slice.map(r=>Math.round(r.femaleSold)), borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Money KPIs
  const horizonRow = rows[sim.horizonIndex];
  $("m_revTot").textContent = money(horizonRow.cumRev);
  $("m_costTot").textContent = money(horizonRow.cumCost);
  $("m_opBE").textContent = sim.opPosMonth===null ? "Never" : moFmt(sim.opPosMonth);
  $("m_fullBE").textContent = sim.farmBEMonth===null ? "Never" : moFmt(sim.farmBEMonth);

  // Money charts
  chCum?.destroy();
  chCum = makeChart("chartCumRevCost","line",labels,[
    {label:"Cumulative revenue", data:slice.map(r=>Math.round(r.cumRev)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Cumulative costs", data:slice.map(r=>Math.round(r.cumCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[5,4]}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Monthly net: green when positive
  chNet?.destroy();
  chNet = makeChart("chartMonthlyNet","line",labels,[
    {
      label:"Monthly net (all-in)",
      data:slice.map(r=>Math.round(r.net)),
      borderWidth:4,
      tension:.25,
      pointRadius:0,
      segment:{
        borderColor: ctx => (ctx.p0.parsed.y>=0 && ctx.p1.parsed.y>=0) ? "rgba(0,140,0,.95)" : "rgba(180,0,0,.95)"
      }
    }
  ],{ scales:{ y:{beginAtZero:false} } });

  chMo?.destroy();
  chMo = makeChart("chartMonthlyRevCost","line",labels,[
    {label:"Monthly revenue", data:slice.map(r=>Math.round(r.revenue)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Operating cost", data:slice.map(r=>Math.round(r.opCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4]}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Snapshot
  $("x_time").textContent = sim.reachedMonth===null ? "Not reached" : moFmt(sim.reachedMonth);
  if(mcEnabled){
    const t50 = isFinite(mc.t50)?Math.round(mc.t50):Infinity;
    const t90 = isFinite(mc.t90)?Math.round(mc.t90):Infinity;
    $("x_p5090").textContent = `${moFmt(t50)} / ${moFmt(t90)}`;
    $("x_conf").textContent = `${Math.round(mc.conf*100)}% by Month ${p.timeframe}`;
  } else {
    $("x_p5090").textContent = "—";
    $("x_conf").textContent = "—";
  }

  $("x_netTarget").textContent = money(horizonRow.cumNet);

  // Purchase spend (startup + expansion)
  const expansionSpend = rows.reduce((a,r)=>a + (r.purchaseSpend||0),0);
  const totalPurchaseSpend = sim.startupSpend + expansionSpend;
  $("x_purchSpend").textContent = money(totalPurchaseSpend);
  $("x_revH").textContent = money(horizonRow.cumRev);
  $("x_costH").textContent = money(horizonRow.cumCost);

  const compText =
    `Total ${fmtInt(horizonRow.herd)} | Does ${fmtInt(horizonRow.breedingDoes)} | Bucks ${fmtInt(horizonRow.bucksActive)}`;
  $("x_compTarget").textContent = compText;

  // Waterfall summary
  const totalRev = horizonRow.cumRev;
  const totalCost = horizonRow.cumCost;
  const netPos = horizonRow.cumNet;

  chWF?.destroy();
  chWF = makeChart("chartWaterfall","bar",["Horizon"],[
    {label:"Total Revenue", data:[Math.round(totalRev)], borderWidth:1},
    {label:"Total Costs", data:[Math.round(totalCost)], borderWidth:1},
    {label:"Net Position", data:[Math.round(netPos)], borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Advisory
  $("advBox").innerHTML = buildAdvice(p, sim);

  // Save/load messages reset
  $("saveMsg").style.display="none";
  $("loadMsg").style.display="none";
}

/* -------------------- Run button with 1.5s spinner -------------------- */
$("runBtn").addEventListener("click", ()=>{
  const btn = $("runBtn");
  btn.disabled = true;
  $("overlay").style.display = "flex";
  setTimeout(()=>{
    try{ runCore(); }
    finally{
      $("overlay").style.display = "none";
      btn.disabled = false;
    }
  }, 1500);
});

/* font size live */
$("fontSize").addEventListener("input", ()=>{
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});

/* -------------------- save / load handlers -------------------- */
$("btnSave").addEventListener("click", ()=>{
  const name = ($("scName").value || "scenario").trim().replace(/[^\w\-]+/g,"_");
  const data = getAllInputs();
  const blob = new Blob([JSON.stringify({name, data}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.json`;
  a.click();
  URL.revokeObjectURL(a.href);

  const box = $("saveMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Saved: ${name}.json (downloaded).`;
});

$("fileLoad").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    loadedScenario = JSON.parse(txt);
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small warn";
    box.textContent = `Loaded file: ${(loadedScenario.name||file.name)}. Click “Apply loaded scenario”.`;
  }catch(err){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `Could not read JSON.`;
    loadedScenario = null;
  }
});

$("btnApplyLoad").addEventListener("click", ()=>{
  if(!loadedScenario?.data){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `No scenario loaded yet.`;
    return;
  }
  applyAllInputs(loadedScenario.data);

  const box = $("loadMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Applied scenario inputs. Now click Run.`;
});

/* -------------------- initial render -------------------- */
runCore();
</script>
</body>
</html>
