<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Dashboard — MK2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --fs: 16px;
      --bg: #e8eaee;
      --card: #ffffff;
      --ink: #111;
      --muted: #444;
      --line: #d4d7dd;
      --soft: rgba(0,0,0,.06);
      --good: rgba(0,140,0,.10);
      --warn: rgba(200,150,0,.12);
      --bad: rgba(180,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.92rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.25fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.1rem;font-weight:950;margin-top:6px}
    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{border-color:rgba(0,140,0,.35);background:var(--good)}
    .warn{border-color:rgba(200,150,0,.35);background:var(--warn)}
    .bad{border-color:rgba(180,0,0,.35);background:var(--bad)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .canvasBox{margin-top:10px}
    canvas{
      display:block;
      width:100% !important;
      height:290px !important;
      max-height:290px !important;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
    }
    .pillGroup{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .pill{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:8px 12px;font-weight:900;
    }
    .pill input{width:auto;padding:0;margin:0}
    .hint{font-size:.9rem;color:var(--muted);margin-top:6px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Goat Farm Dashboard — MK2 <span class="small">• fixed gestation • retained doe first-try age 8 months • Sales Cycle tab</span></h1>

  <!-- Global Controls -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops when herd on-farm reaches this size.">Target herd size</label>
          <input id="target" type="number" value="200" min="10" />
        </div>
        <div class="row">
          <label title="Used for Target confidence (Monte Carlo).">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6" />
        </div>
        <div class="row">
          <label title="Hard cap for simulation length.">Max months (safety cap)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12" />
        </div>
      </div>
      <div>
        <div class="row">
          <label title="Adjust readability.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16" />
        </div>

        <!-- Monte Carlo controls (A) -->
        <div class="row">
          <label title="Enable Monte Carlo to estimate P50/P90 and confidence.">Monte Carlo</label>
          <select id="mcOn">
            <option value="0" selected>OFF</option>
            <option value="1">ON</option>
          </select>
        </div>
        <div class="row">
          <label title="Number of Monte Carlo runs when ON.">MC iterations</label>
          <input id="mcIters" type="number" value="200" min="50" max="5000" />
        </div>

        <div class="row">
          <label title="Click to compute and refresh all tabs.">Run model</label>
          <button id="runBtn">Run</button>
        </div>
        <div class="banner small" id="runNote">
          Charts remain static until you click <b>Run</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabSales">Sales Cycle</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
    <button class="tabBtn" data-tab="tabAdv">Advisory</button>
    <button class="tabBtn" data-tab="tabSave">Save / Load</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (goats bought at the start)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Young starters are treated as ~3 months old and need 5 months on-farm to reach 8 months.">Start: Young does (3 months old)</label>
            <input id="startYoungDoes" type="number" value="4" min="0" />
          </div>
          <div class="row">
            <label title="Young starters need 5 months on-farm before active.">Start: Young bucks (3 months old)</label>
            <input id="startYoungBucks" type="number" value="1" min="0" />
          </div>
        </div>
        <div>
          <div class="row">
            <label title="Adults become active after 1-month buffer.">Start: Adult ready does</label>
            <input id="startAdultDoes" type="number" value="0" min="0" />
          </div>
          <div class="row">
            <label title="Adults become active after 1-month buffer.">Start: Adult ready bucks</label>
            <input id="startAdultBucks" type="number" value="0" min="0" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Expansion purchases (months 4, 8, 12, 16, 20, 24, 28)</b>
      <div class="small">Purchased goats are assumed “young” and take time before they become active (same maturity logic as young starters).</div>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p4d" type="number" value="0" min="0" />
              <input id="p4b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 8: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p8d" type="number" value="0" min="0" />
              <input id="p8b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 12: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p12d" type="number" value="0" min="0" />
              <input id="p12b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 16: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p16d" type="number" value="0" min="0" />
              <input id="p16b" type="number" value="0" min="0" />
            </div>
          </div>
        </div>
        <div>
          <div class="row"><label>Month 20: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p20d" type="number" value="0" min="0" />
              <input id="p20b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 24: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p24d" type="number" value="0" min="0" />
              <input id="p24b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 28: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p28d" type="number" value="0" min="0" />
              <input id="p28b" type="number" value="0" min="0" />
            </div>
          </div>

          <div class="banner small" style="margin-top:10px">
            Purchases KPI will show <b>total bought</b> over time (does + bucks).
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total bought (does+bucks)</small><div class="v" id="k_buy_total">—</div></div>
        <div class="kpi"><small>Total bought does</small><div class="v" id="k_buy_does">—</div></div>
        <div class="kpi"><small>Total bought bucks</small><div class="v" id="k_buy_bucks">—</div></div>
        <div class="kpi"><small>First purchase month</small><div class="v" id="k_buy_first">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartPurchTotal"></canvas>
        <div class="small">Total goats purchased on-farm (cumulative) over time.</div>
      </div>
    </div>
  </div>

  <!-- Goat Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Breeding settings</b>

      <div class="pillGroup" aria-label="Growth presets">
        <label class="pill" title="Faster herd build; tighter cycles; higher retention.">
          <input type="radio" name="growthMode" id="modeAgg" />
          Aggressive growth
        </label>
        <label class="pill" title="More conservative, planning-safe assumptions.">
          <input type="radio" name="growthMode" id="modeCon" checked />
          Conservative growth
        </label>
        <span class="pill" title="Fixed by design.">Retained doe first-try age: <b>8 months</b></span>
        <span class="pill" title="Fixed by design.">Gestation: <b>5 months</b></span>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="How often breeding attempts happen.">Kidding interval (months)</label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18" />
          </div>
          <div class="row">
            <label title="Probability that a breeding attempt results in pregnancy.">Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label title="Average kids per birth event.">Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1" />
          </div>

          <div class="row">
            <label title="After a doe gives birth, she must wait this many months before she can conceive again.">Re-breed delay (months)</label>
            <input id="rebreedDelay" type="number" value="3" min="0" max="12" />
          </div>
        </div>

        <div>
          <div class="row">
            <label title="Female share of newborn kids.">Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60" />
          </div>
          <div class="row">
            <label title="Survival from birth to counted inventory age.">Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label title="Buck capacity = bucks × does-per-buck.">Does per buck</label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="50" />
          </div>
          <div class="row">
            <label title="Share of female kids you keep to grow the herd.">Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Sales assumptions (used for Sales Cycle + Money)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Male kids are sold at this age (unless sales are frozen).">Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12" />
          </div>
          <div class="banner small">
            Rule: Male kids are always sold. Female kids are either retained for breeding or sold for breeding at 6 months (based on Retain %).
          </div>
        </div>
        <div>
          <div class="banner small">
            <b>Fixed biology:</b><br/>
            • Retained females can first attempt pregnancy at <b>8 months</b>.<br/>
            • Gestation is fixed at <b>5 months</b>.<br/>
            • Re-breed delay controls how long after kidding a doe can conceive again.
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target</small><div class="v" id="g_time">—</div></div>
        <div class="kpi"><small>Reached target?</small><div class="v" id="g_reach">—</div></div>
        <div class="kpi"><small>Buck capacity status</small><div class="v" id="g_buck">—</div></div>
        <div class="kpi"><small>Herd at horizon (total)</small><div class="v" id="g_herd_target_total">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartHerd"></canvas>
        <div class="small">Herd composition over time (whole numbers): breeding does, bucks, young females, young males.</div>
      </div>
      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">Constraint: breedable does vs buck capacity, with bucks count shown as a line (2nd axis).</div>
      </div>
    </div>
  </div>

  <!-- Sales Cycle -->
  <div id="tabSales" class="tab">
    <div class="card">
      <b class="small">Sales Cycle</b>
      <div class="small">This tab shows <b>when goats are sold</b> and how many leave the farm each month.</div>

      <!-- C: Freeze sales control -->
      <div class="row" style="margin-top:10px">
        <label title="If you freeze sales, goats that would sell are stockpiled and sold once the freeze ends.">Freeze sales for first (months)</label>
        <input id="freezeSales" type="number" value="0" min="0" max="120" />
      </div>
      <div class="banner small">
        Freeze sales is your “vary first sale month” lever. It delays first cash-in while growing inventory.
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total goats sold (lifetime)</small><div class="v" id="s_totalSold">—</div></div>
        <div class="kpi"><small>Male goats sold</small><div class="v" id="s_maleSold">—</div></div>
        <div class="kpi"><small>Female goats sold</small><div class="v" id="s_femaleSold">—</div></div>
        <div class="kpi"><small>First sale month</small><div class="v" id="s_firstSale">—</div></div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><small>Total revenue (to horizon)</small><div class="v" id="s_totalRev">—</div></div>
        <div class="kpi"><small>Sales by target month</small><div class="v" id="s_byTarget">—</div></div>
        <div class="kpi"><small>Sales by timeframe month</small><div class="v" id="s_byTimeframe">—</div></div>
        <div class="kpi"><small>Avg monthly sales (to horizon)</small><div class="v" id="s_avgSales">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartSales"></canvas>
        <div class="small">Monthly goats sold (whole numbers): male kids vs female goats sold for breeding.</div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Currency label</label><input id="cur" value="UGX" /></div>

          <div class="row">
            <label title="Young goat purchase prices (starting young + expansion purchases).">Buy price: young doe / young buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyYoungDoe" type="number" value="400000" min="0" />
              <input id="buyYoungBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label title="Adult starter purchase prices (if you input adult starts).">Buy price: adult doe / adult buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyAdultDoe" type="number" value="400000" min="0" />
              <input id="buyAdultBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label title="Sale prices used for sales events.">Sale price: male / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellMale" type="number" value="250000" min="0" />
              <input id="sellFemale" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="banner small">
            Sales are recorded in the Sales Cycle tab and then reflected here as revenue.
          </div>
        </div>

        <div>
          <div class="row"><label>Feed per goat / month</label><input id="feed" type="number" value="2500" min="0" /></div>
          <div class="row"><label>Medication per goat / month</label><input id="med" type="number" value="0" min="0" /></div>
          <div class="row"><label>Other variable per goat / month</label><input id="othVar" type="number" value="0" min="0" /></div>

          <div class="row"><label>Property / year</label><input id="propYr" type="number" value="1500000" min="0" /></div>
          <div class="row"><label>Labor / month</label><input id="laborMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Vet / month</label><input id="vetMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Security / month</label><input id="secMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Transport / month</label><input id="trMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Admin / month</label><input id="adMo" type="number" value="0" min="0" /></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Operational positive</small><div class="v" id="m_opBE">—</div></div>
        <div class="kpi"><small>Payback</small><div class="v" id="m_fullBE">—</div></div>
        <div class="kpi"><small>Total revenue (to horizon)</small><div class="v" id="m_revTot">—</div></div>
        <div class="kpi"><small>Total costs (to horizon)</small><div class="v" id="m_costTot">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">Cumulative revenue vs cumulative costs (operating + purchases + startup).</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyNet"></canvas>
        <div class="small">Monthly net (all-in). Includes month 0 startup purchases. Turns green after it becomes positive.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyRevCost"></canvas>
        <div class="small">Monthly revenue vs monthly operating costs (month-to-month “is it working?” view).</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Snapshot</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (deterministic)</small><div class="v" id="x_time">—</div></div>
        <div class="kpi"><small>P50 / P90 time to target</small><div class="v" id="x_p50p90">—</div></div>
        <div class="kpi"><small>Target confidence by Month X</small><div class="v" id="x_conf">—</div></div>
        <div class="kpi"><small>Net position at horizon</small><div class="v" id="x_netTarget">—</div></div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi" style="grid-column:1 / -1"><small>Herd composition at horizon</small><div class="v" id="x_compTarget">—</div></div>
      </div>

      <div class="banner small" id="x_assump" style="margin-top:12px">
        <b>Assumptions used by this model:</b><br/>
        • Gestation is fixed at 5 months (150 days).<br/>
        • Retained female kids can first try to conceive at 8 months.<br/>
        • After a doe gives birth, she waits the re-breed delay before she can conceive again.<br/>
        • Breeding is limited by buck capacity = bucks × does-per-buck.<br/>
        • Male kids are sold at your chosen age; female kids are retained % vs sold for breeding at 6 months (unless sales freeze).<br/>
        • Costs are variable (per goat per month) + fixed (monthly).<br/>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">By horizon: Total Revenue vs Total Costs → Net position.</div>
      </div>
    </div>
  </div>

  <!-- Advisory -->
  <div id="tabAdv" class="tab">
    <div class="card">
      <b class="small">Advisory (simple)</b>
      <div class="banner small" id="advBox">
        Run the model to get advice.
      </div>
    </div>
  </div>

  <!-- Save / Load -->
  <div id="tabSave" class="tab">
    <div class="card">
      <b class="small">Save / Load scenario</b>
      <div class="small">This saves your inputs as a JSON file on your computer and lets you reload them later.</div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Scenario name</label><input id="scName" value="MK2-scenario" /></div>
          <button id="btnSave">Save scenario (download JSON)</button>
          <div class="hint">Tip: Keep your MK1 baseline file separately.</div>
        </div>
        <div>
          <div class="row"><label>Load scenario JSON</label><input id="fileLoad" type="file" accept=".json" /></div>
          <button id="btnApplyLoad">Apply loaded scenario</button>
          <div class="hint">After loading, click <b>Run</b> to refresh charts.</div>
        </div>
      </div>

      <div class="banner small" id="saveMsg" style="display:none;margin-top:10px"></div>
      <div class="banner small" id="loadMsg" style="display:none;margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/* -------------------- helpers -------------------- */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id).value||0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtInt=(n)=>Math.round(n).toLocaleString();
const money=(n)=>{
  const cur = ($("cur")?.value || "UGX").trim();
  return `${cur} ${Math.round(n).toLocaleString()}`;
};
function moFmt(mo){
  if(mo===null || mo===undefined) return "Never";
  const y=Math.floor(mo/12), m=mo%12;
  return y?`${y}y ${m}m`:`${m} months`;
}
function percentile(sortedArr, p){
  if(!sortedArr.length) return null;
  const idx = (sortedArr.length - 1) * p;
  const lo = Math.floor(idx);
  const hi = Math.ceil(idx);
  if(lo === hi) return sortedArr[lo];
  return sortedArr[lo] + (sortedArr[hi] - sortedArr[lo]) * (idx - lo);
}

/* -------------------- tabs -------------------- */
(function initTabs(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $(b.dataset.tab).classList.add("active");
    });
  });
})();

/* -------------------- Action 1: presets -------------------- */
const PRESET = {
  aggressive: { kiddingInt: 9,  breedSuccess: 93, kidsPerBirth: 1.9, rebreedDelay: 2, retainF: 95 },
  conservative:{ kiddingInt: 12, breedSuccess: 90, kidsPerBirth: 1.8, rebreedDelay: 3, retainF: 85 }
};
function applyPreset(name){
  const p = PRESET[name];
  $("kiddingInt").value = p.kiddingInt;
  $("breedSuccess").value = p.breedSuccess;
  $("kidsPerBirth").value = p.kidsPerBirth;
  $("rebreedDelay").value = p.rebreedDelay;
  $("retainF").value = p.retainF;
}
$("modeAgg").addEventListener("change", ()=>{ if($("modeAgg").checked) applyPreset("aggressive"); });
$("modeCon").addEventListener("change", ()=>{ if($("modeCon").checked) applyPreset("conservative"); });

/* -------------------- fixed biology -------------------- */
const FIX_GEST = 5;
const FIX_FIRST_TRY = 8;
const FIX_FEMALE_SALE_AGE = 6;

/* -------------------- purchases schedule -------------------- */
function purchAtMonth(m){
  let d=0,b=0;
  if(m===4){ d=N("p4d"); b=N("p4b"); }
  else if(m===8){ d=N("p8d"); b=N("p8b"); }
  else if(m===12){ d=N("p12d"); b=N("p12b"); }
  else if(m===16){ d=N("p16d"); b=N("p16b"); }
  else if(m===20){ d=N("p20d"); b=N("p20b"); }
  else if(m===24){ d=N("p24d"); b=N("p24b"); }
  else if(m===28){ d=N("p28d"); b=N("p28b"); }
  return {d,b};
}

/* -------------------- model params -------------------- */
function getParams(){
  const target = clamp(N("target"), 10, 100000);
  const timeframe = clamp(N("timeframe"), 6, 240);
  const maxMonths = clamp(N("maxMonths"), 24, 360);

  const kiddingInt = clamp(N("kiddingInt"), 6, 18);
  const rebreedDelay = clamp(N("rebreedDelay"), 0, 12);

  const breedSuccess = clamp(N("breedSuccess"), 40, 100) / 100;
  const kidsPerBirth = clamp(Number($("kidsPerBirth").value||1.8), 1, 3.5);

  const pctFemale = clamp(N("pctFemale"), 40, 60) / 100;
  const kidSurvival = clamp(N("kidSurvival"), 40, 100) / 100;

  const doesPerBuck = clamp(N("doesPerBuck"), 5, 50);
  const retainF = clamp(N("retainF"), 0, 100) / 100;
  const maleSaleAge = clamp(N("maleSaleAge"), 1, 12);

  const startYoungDoes = clamp(N("startYoungDoes"), 0, 999999);
  const startYoungBucks = clamp(N("startYoungBucks"), 0, 999999);
  const startAdultDoes = clamp(N("startAdultDoes"), 0, 999999);
  const startAdultBucks = clamp(N("startAdultBucks"), 0, 999999);

  const buyYoungDoe = N("buyYoungDoe"), buyYoungBuck=N("buyYoungBuck");
  const buyAdultDoe = N("buyAdultDoe"), buyAdultBuck=N("buyAdultBuck");
  const sellMale=N("sellMale"), sellFemale=N("sellFemale");

  const feed=N("feed"), med=N("med"), othVar=N("othVar");
  const fixedMo=(N("propYr")/12)+N("laborMo")+N("vetMo")+N("secMo")+N("trMo")+N("adMo");

  const freezeSales = clamp(N("freezeSales"), 0, 360);

  return {
    target, timeframe, maxMonths,
    kiddingInt, rebreedDelay,
    breedSuccess, kidsPerBirth,
    pctFemale, kidSurvival,
    doesPerBuck, retainF, maleSaleAge,
    startYoungDoes, startYoungBucks, startAdultDoes, startAdultBucks,
    buyYoungDoe, buyYoungBuck, buyAdultDoe, buyAdultBuck,
    sellMale, sellFemale,
    feed, med, othVar, fixedMo,
    freezeSales
  };
}

/* -------------------- simulation -------------------- */
function simulate(p){
  const rows=[];

  const fRetCoh = Array(FIX_FIRST_TRY).fill(0);
  const mCoh = Array(p.maleSaleAge).fill(0);
  const fSaleCoh = Array(FIX_FEMALE_SALE_AGE).fill(0);

  const preg = Array(FIX_GEST).fill(0);
  const rest = Array(p.rebreedDelay).fill(0);

  const youngStarterF = Array(5).fill(0);
  const youngStarterM = Array(5).fill(0);
  youngStarterF[0] = p.startYoungDoes;
  youngStarterM[0] = p.startYoungBucks;

  let adultBufferDoes = p.startAdultDoes;
  let adultBufferBucks = p.startAdultBucks;

  let breedingDoes = 0;
  let bucksActive = 0;

  const startupSpend =
    p.startYoungDoes*p.buyYoungDoe +
    p.startYoungBucks*p.buyYoungBuck +
    p.startAdultDoes*p.buyAdultDoe +
    p.startAdultBucks*p.buyAdultBuck;

  let cumRev=0, cumCost=0;
  let cumNet = -startupSpend;
  let opPos = null, payback = null;

  let totalMaleSold=0, totalFemaleSold=0;
  let firstSaleMonth = null;

  // stockpile sales during freeze
  let stockMale = 0;
  let stockFemale = 0;

  let cumBoughtDoes = p.startYoungDoes + p.startAdultDoes;
  let cumBoughtBucks = p.startYoungBucks + p.startAdultBucks;

  let reachedMonth = null;
  let targetIndex = null;

  function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

  function eligibleDoes(){
    const pregTot = sum(preg);
    const restTot = sum(rest);
    return Math.max(0, breedingDoes - pregTot - restTot);
  }

  function herdTotal(){
    const youngF = sum(fRetCoh);
    const maleKids = sum(mCoh);
    const femaleForSale = sum(fSaleCoh);

    const startersF = sum(youngStarterF);
    const startersM = sum(youngStarterM);
    const adultsWaiting = adultBufferDoes + adultBufferBucks;

    // stockpiled animals are still on farm
    return (breedingDoes + bucksActive + youngF + maleKids + femaleForSale + startersF + startersM + adultsWaiting + stockMale + stockFemale);
  }

  function monthlyOperatingCost(inv){
    return inv * (p.feed + p.med + p.othVar) + p.fixedMo;
  }

  for(let m=0; m<=p.maxMonths; m++){
    if(m===1){
      breedingDoes += adultBufferDoes;
      bucksActive += adultBufferBucks;
      adultBufferDoes = 0;
      adultBufferBucks = 0;
    }

    const starterFOut = youngStarterF[youngStarterF.length-1] || 0;
    for(let i=youngStarterF.length-1;i>=1;i--) youngStarterF[i]=youngStarterF[i-1];
    youngStarterF[0]=0;
    breedingDoes += starterFOut;

    const starterMOut = youngStarterM[youngStarterM.length-1] || 0;
    for(let i=youngStarterM.length-1;i>=1;i--) youngStarterM[i]=youngStarterM[i-1];
    youngStarterM[0]=0;
    bucksActive += starterMOut;

    const pur = purchAtMonth(m);
    if(pur.d || pur.b){
      youngStarterF[0] += pur.d;
      youngStarterM[0] += pur.b;
      cumBoughtDoes += pur.d;
      cumBoughtBucks += pur.b;
    }

    // shift pregnancy
    const birthDoes = preg[preg.length-1] || 0;
    for(let i=preg.length-1;i>=1;i--) preg[i]=preg[i-1];
    preg[0]=0;

    // shift rest
    if(rest.length){
      for(let i=rest.length-1;i>=1;i--) rest[i]=rest[i-1];
      rest[0]=0;
    }

    // births
    let birthsKids = 0;
    if(birthDoes>0){
      birthsKids = birthDoes * p.kidsPerBirth * p.kidSurvival;
      if(rest.length) rest[0] += birthDoes;
    }
    const fBorn = birthsKids * p.pctFemale;
    const mBorn = birthsKids - fBorn;

    const fRet = fBorn * p.retainF;
    const fSale = fBorn - fRet;

    if(fRetCoh.length) fRetCoh[0] += fRet;
    if(mCoh.length) mCoh[0] += mBorn;
    if(fSaleCoh.length) fSaleCoh[0] += fSale;

    // retained females age up into breeding pool
    const toBreeding = fRetCoh[fRetCoh.length-1] || 0;
    for(let i=fRetCoh.length-1;i>=1;i--) fRetCoh[i]=fRetCoh[i-1];
    fRetCoh[0]=0;
    breedingDoes += toBreeding;

    // breeding attempt
    if(m>0 && (m % p.kiddingInt === 0)){
      const elig = eligibleDoes();
      const capacity = bucksActive * p.doesPerBuck;
      const attempted = Math.min(elig, capacity);
      const conceptions = attempted * p.breedSuccess;
      preg[0] += conceptions;
    }

    // age up and "would sell"
    let maleWouldSell = 0;
    if(mCoh.length){
      maleWouldSell = mCoh[mCoh.length-1] || 0;
      for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
      mCoh[0]=0;
    }

    let femaleWouldSell = 0;
    if(fSaleCoh.length){
      femaleWouldSell = fSaleCoh[fSaleCoh.length-1] || 0;
      for(let i=fSaleCoh.length-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
      fSaleCoh[0]=0;
    }

    // C: freeze sales -> stockpile until freeze ends
    let maleSold = 0, femaleSold = 0;
    if(m < p.freezeSales){
      stockMale += maleWouldSell;
      stockFemale += femaleWouldSell;
    } else {
      // once freeze ends, dump stockpile plus current due
      maleSold = stockMale + maleWouldSell;
      femaleSold = stockFemale + femaleWouldSell;
      stockMale = 0;
      stockFemale = 0;
    }

    if((maleSold + femaleSold) > 0 && firstSaleMonth===null){
      firstSaleMonth = m;
    }
    totalMaleSold += maleSold;
    totalFemaleSold += femaleSold;

    // money
    const inv = herdTotal();
    const opCost = monthlyOperatingCost(inv);
    const purchaseSpend = (pur.d*p.buyYoungDoe) + (pur.b*p.buyYoungBuck);
    const revenue = (maleSold * p.sellMale) + (femaleSold * p.sellFemale);
    const net = revenue - opCost - purchaseSpend;

    cumRev += revenue;
    cumCost += (opCost + purchaseSpend);
    cumNet += net;

    if(opPos===null && revenue >= opCost) opPos = m;
    if(payback===null && cumNet >= 0) payback = m;

    const herd = inv;
    const capacityDoes = bucksActive * p.doesPerBuck;

    rows.push({
      m,
      herd,
      breedingDoes,
      bucksActive,
      youngF: sum(fRetCoh),
      youngM: sum(mCoh),
      fForSale: sum(fSaleCoh),
      eligible: eligibleDoes(),
      capacityDoes,
      maleSold,
      femaleSold,
      revenue,
      opCost,
      purchaseSpend,
      net,
      cumRev,
      cumCost,
      cumNet,
      cumBought: cumBoughtDoes + cumBoughtBucks,
      cumBoughtDoes,
      cumBoughtBucks
    });

    if(reachedMonth===null && herd >= p.target){
      reachedMonth = m;
      targetIndex = rows.length-1;
      break;
    }
  }

  const horizonIndex = (targetIndex!==null) ? targetIndex : Math.min(rows.length-1, p.maxMonths);
  return {
    rows,
    reachedMonth,
    horizonIndex,
    startupSpend,
    opPos,
    payback,
    totals: {
      totalMaleSold,
      totalFemaleSold,
      firstSaleMonth,
      cumRev,
      cumCost,
      cumNet,
      cumBoughtDoes,
      cumBoughtBucks
    }
  };
}

/* -------------------- Monte Carlo (A) -------------------- */
function jitter(x, pct){ // pct like 0.05 for ±5%
  const r = (Math.random()*2 - 1) * pct;
  return x * (1 + r);
}
function runMonteCarlo(baseP){
  const iters = clamp(N("mcIters"), 50, 5000);
  const times = [];
  let hitByTimeframe = 0;

  // tight ranges: biological-only (no prices randomized)
  for(let i=0;i<iters;i++){
    const p = {...baseP};

    p.breedSuccess = clamp(jitter(p.breedSuccess, 0.04), 0.30, 0.99);
    p.kidsPerBirth = clamp(jitter(p.kidsPerBirth, 0.06), 1.0, 3.5);
    p.kidSurvival = clamp(jitter(p.kidSurvival, 0.05), 0.30, 1.0);
    p.pctFemale = clamp(jitter(p.pctFemale, 0.02), 0.40, 0.60);
    p.retainF = clamp(jitter(p.retainF, 0.03), 0.0, 1.0);

    const sim = simulate(p);
    const t = sim.reachedMonth;
    if(t!==null) times.push(t);
    if(t!==null && t <= baseP.timeframe) hitByTimeframe++;
  }

  times.sort((a,b)=>a-b);

  const p50 = times.length ? percentile(times, 0.50) : null;
  const p90 = times.length ? percentile(times, 0.90) : null;

  const conf = iters ? Math.round((hitByTimeframe / iters) * 100) : 0;

  return { iters, p50, p90, conf, successes: times.length };
}

/* -------------------- charts -------------------- */
let chPurch=null, chHerd=null, chCons=null, chSales=null, chCum=null, chNet=null, chMo=null, chWF=null;

function makeChart(canvasId, type, labels, datasets, options={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{ legend:{labels:{color:"#111", font:{weight:"800"}}} },
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}}
      },
      ...options
    }
  });
}

/* -------------------- advisory -------------------- */
function buildAdvice(p, sim){
  const rows = sim.rows;
  const last = rows[sim.horizonIndex] || rows[rows.length-1];
  if(!last) return "Run the model to get advice.";

  let limiter = "";
  if(last.capacityDoes===0 && last.bucksActive===0 && last.breedingDoes>0) limiter = "You have does but no active bucks. Add bucks or buy an adult buck.";
  else if(last.eligible > last.capacityDoes) limiter = "Buck capacity is limiting. Add bucks or reduce does-per-buck.";
  else limiter = "Buck capacity looks OK. Your main levers are cycle length, retention, costs, and sale timing (freeze).";

  const moneyNote = (sim.payback===null)
    ? "Payback not reached within the simulated horizon. Improve net position by raising prices, reducing costs, or slowing purchases."
    : `Payback is reached around ${moFmt(sim.payback)}.`;

  return `
    <b>Biggest limiter:</b> ${limiter}<br/><br/>
    <b>Money:</b> ${moneyNote}<br/>
    <b>Tip:</b> If you freeze sales, you grow inventory faster but delay revenue—watch Operating positive and Payback.
  `;
}

/* -------------------- save / load -------------------- */
let loadedScenario=null;

function getAllInputs(){
  const ids=[
    "target","timeframe","maxMonths","fontSize",
    "mcOn","mcIters",
    "startYoungDoes","startYoungBucks","startAdultDoes","startAdultBucks",
    "p4d","p4b","p8d","p8b","p12d","p12b","p16d","p16b","p20d","p20b","p24d","p24b","p28d","p28b",
    "kiddingInt","breedSuccess","kidsPerBirth","rebreedDelay","pctFemale","kidSurvival","doesPerBuck","retainF","maleSaleAge",
    "freezeSales",
    "cur","buyYoungDoe","buyYoungBuck","buyAdultDoe","buyAdultBuck","sellMale","sellFemale",
    "feed","med","othVar","propYr","laborMo","vetMo","secMo","trMo","adMo",
    "modeAgg","modeCon"
  ];
  const out={};
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio") out[id]=el.checked;
    else out[id]=el.value;
  });
  return out;
}
function applyAllInputs(obj){
  Object.entries(obj||{}).forEach(([id,val])=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio") el.checked=!!val;
    else el.value=val;
  });
}

/* -------------------- render -------------------- */
function run(){
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");

  const p = getParams();
  const sim = simulate(p);
  const rows = sim.rows;
  if(!rows.length) return;

  const h = sim.horizonIndex;
  const slice = rows.slice(0, h+1);
  const labels = slice.map(r=>r.m);

  // Purchases KPIs
  const totB = sim.totals.cumBoughtDoes + sim.totals.cumBoughtBucks;
  $("k_buy_total").textContent = fmtInt(totB);
  $("k_buy_does").textContent = fmtInt(sim.totals.cumBoughtDoes);
  $("k_buy_bucks").textContent = fmtInt(sim.totals.cumBoughtBucks);

  let firstPur = null;
  for(const r of rows){ if(r.purchaseSpend>0){ firstPur = r.m; break; } }
  $("k_buy_first").textContent = firstPur===null ? "None" : `Month ${firstPur}`;

  chPurch?.destroy();
  chPurch = makeChart("chartPurchTotal","line",labels,[
    {label:"Cumulative goats bought", data:slice.map(r=>Math.round(r.cumBought)), borderWidth:3, tension:.25, pointRadius:0}
  ]);

  // Growth KPIs
  $("g_reach").textContent = sim.reachedMonth===null ? "No" : "Yes";
  $("g_time").textContent = sim.reachedMonth===null ? `Not reached by ${p.maxMonths} months` : moFmt(sim.reachedMonth);

  const last = slice[slice.length-1];
  const util = (last.capacityDoes>0) ? last.eligible/last.capacityDoes : 0;
  $("g_buck").textContent =
    (last.capacityDoes===0 && last.breedingDoes>0) ? "No bucks"
    : (last.eligible > last.capacityDoes) ? "Limiting (add bucks)"
    : (util>0.85) ? "Tight"
    : "Healthy";

  $("g_herd_target_total").textContent = fmtInt(last.herd);

  // Herd chart
  chHerd?.destroy();
  chHerd = makeChart("chartHerd","line",labels,[
    {label:"Breeding does", data:slice.map(r=>Math.round(r.breedingDoes)), borderWidth:2, tension:.25, pointRadius:0, fill:true},
    {label:"Young females", data:slice.map(r=>Math.round(r.youngF + r.fForSale)), borderWidth:2, tension:.25, pointRadius:0, fill:true},
    {label:"Bucks", data:slice.map(r=>Math.round(r.bucksActive)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Young males", data:slice.map(r=>Math.round(r.youngM)), borderWidth:2, tension:.25, pointRadius:0, fill:true}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Constraint chart
  chCons?.destroy();
  chCons = makeChart("chartConstraint","line",labels,[
    {label:"Breedable does (eligible)", data:slice.map(r=>Math.round(r.eligible)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y"},
    {label:"Buck capacity (bucks×ratio)", data:slice.map(r=>Math.round(r.capacityDoes)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4], yAxisID:"y"},
    {label:"Bucks (count)", data:slice.map(r=>Math.round(r.bucksActive)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y2"}
  ],{
    scales:{
      y:{type:"linear", position:"left", beginAtZero:true},
      y2:{type:"linear", position:"right", beginAtZero:true, grid:{drawOnChartArea:false}}
    }
  });

  // Sales KPIs
  const maleSoldTot = Math.round(sim.totals.totalMaleSold);
  const femSoldTot = Math.round(sim.totals.totalFemaleSold);
  $("s_totalSold").textContent = fmtInt(maleSoldTot + femSoldTot);
  $("s_maleSold").textContent = fmtInt(maleSoldTot);
  $("s_femaleSold").textContent = fmtInt(femSoldTot);
  $("s_firstSale").textContent = sim.totals.firstSaleMonth===null ? "Never" : `Month ${sim.totals.firstSaleMonth}`;

  // Total revenue shown on Sales tab (B)
  const horizonRow = rows[sim.horizonIndex];
  $("s_totalRev").textContent = money(horizonRow.cumRev);

  const idxTarget = sim.horizonIndex;
  const idxTimeframe = Math.min(rows.length-1, p.timeframe);
  const sumUpTo = (arrIdx, key)=> rows.slice(0, arrIdx+1).reduce((a,r)=>a + (r[key]||0),0);

  const soldByTarget = Math.round(sumUpTo(idxTarget,"maleSold") + sumUpTo(idxTarget,"femaleSold"));
  const soldByTime = Math.round(sumUpTo(idxTimeframe,"maleSold") + sumUpTo(idxTimeframe,"femaleSold"));
  $("s_byTarget").textContent = fmtInt(soldByTarget);
  $("s_byTimeframe").textContent = fmtInt(soldByTime);

  const avgSales = (idxTarget>0) ? (soldByTarget/(idxTarget+1)) : 0;
  $("s_avgSales").textContent = `${Math.round(avgSales)} / mo`;

  chSales?.destroy();
  chSales = makeChart("chartSales","bar",labels,[
    {label:"Male sold", data:slice.map(r=>Math.round(r.maleSold)), borderWidth:1},
    {label:"Female sold", data:slice.map(r=>Math.round(r.femaleSold)), borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Money KPIs (D)
  $("m_revTot").textContent = money(horizonRow.cumRev);
  $("m_costTot").textContent = money(horizonRow.cumCost);
  $("m_opBE").textContent = sim.opPos===null ? "Never" : moFmt(sim.opPos);
  $("m_fullBE").textContent = sim.payback===null ? "Never" : moFmt(sim.payback);

  // Cumulative rev vs cost
  chCum?.destroy();
  chCum = makeChart("chartCumRevCost","line",labels,[
    {label:"Cumulative revenue", data:slice.map(r=>Math.round(r.cumRev)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Cumulative costs", data:slice.map(r=>Math.round(r.cumCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[5,4]}
  ]);

  // Monthly net all-in (includes startup at month 0)
  const netAllIn = slice.map(r=>{
    const extra = (r.m===0) ? (-sim.startupSpend) : 0;
    return Math.round(r.net + extra);
  });

  // E: green after positive
  chNet?.destroy();
  chNet = makeChart("chartMonthlyNet","line",labels,[
    {
      label:"Monthly net (all-in)",
      data: netAllIn,
      borderWidth:4,
      tension:.25,
      pointRadius:0,
      segment:{
        borderColor: ctx => {
          const y0 = ctx.p0.parsed.y;
          const y1 = ctx.p1.parsed.y;
          // if segment crosses or is above 0 at the end, treat as green
          if(y1 >= 0) return "rgba(0,140,0,.95)";
          return "rgba(180,0,0,.95)";
        }
      }
    }
  ],{ scales:{ y:{beginAtZero:false} } });

  // Monthly rev vs op cost
  chMo?.destroy();
  chMo = makeChart("chartMonthlyRevCost","line",labels,[
    {label:"Monthly revenue", data:slice.map(r=>Math.round(r.revenue)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Operating cost", data:slice.map(r=>Math.round(r.opCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4]}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Snapshot KPIs + Monte Carlo (A)
  $("x_time").textContent = sim.reachedMonth===null ? "Not reached" : moFmt(sim.reachedMonth);
  $("x_netTarget").textContent = money(horizonRow.cumNet);

  const compText =
    `Total ${fmtInt(horizonRow.herd)} | Does ${fmtInt(horizonRow.breedingDoes)} | Bucks ${fmtInt(horizonRow.bucksActive)} | YoungF ${fmtInt(horizonRow.youngF + horizonRow.fForSale)} | YoungM ${fmtInt(horizonRow.youngM)}`;
  $("x_compTarget").textContent = compText;

  if(($("mcOn").value||"0")==="1"){
    const mc = runMonteCarlo(p);
    const p50 = (mc.p50===null) ? "Never" : moFmt(Math.round(mc.p50));
    const p90 = (mc.p90===null) ? "Never" : moFmt(Math.round(mc.p90));
    $("x_p50p90").textContent = `${p50} / ${p90}`;
    $("x_conf").textContent = `${mc.conf}% (runs: ${mc.iters}, hits: ${mc.successes})`;
  } else {
    $("x_p50p90").textContent = "—";
    $("x_conf").textContent = "—";
  }

  // Waterfall summary
  const totalRev = horizonRow.cumRev;
  const totalCost = horizonRow.cumCost;
  const netPos = horizonRow.cumNet;

  chWF?.destroy();
  chWF = makeChart("chartWaterfall","bar",["Horizon"],[
    {label:"Total Revenue", data:[Math.round(totalRev)], borderWidth:1},
    {label:"Total Costs", data:[Math.round(totalCost)], borderWidth:1},
    {label:"Net Position", data:[Math.round(netPos)], borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  $("advBox").innerHTML = buildAdvice(p, sim);

  $("saveMsg").style.display="none";
  $("loadMsg").style.display="none";
}

/* -------------------- run button -------------------- */
$("runBtn").addEventListener("click", run);
$("fontSize").addEventListener("input", ()=>{
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});

/* -------------------- save / load handlers -------------------- */
$("btnSave").addEventListener("click", ()=>{
  const name = ($("scName").value || "scenario").trim().replace(/[^\w\-]+/g,"_");
  const data = getAllInputs();
  const blob = new Blob([JSON.stringify({name, data}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.json`;
  a.click();
  URL.revokeObjectURL(a.href);

  const box = $("saveMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Saved: ${name}.json (downloaded).`;
});

$("fileLoad").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    loadedScenario = JSON.parse(txt);
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small warn";
    box.textContent = `Loaded file: ${(loadedScenario.name||file.name)}. Click “Apply loaded scenario”.`;
  }catch(err){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `Could not read JSON.`;
    loadedScenario = null;
  }
});

$("btnApplyLoad").addEventListener("click", ()=>{
  if(!loadedScenario?.data){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `No scenario loaded yet.`;
    return;
  }
  applyAllInputs(loadedScenario.data);

  const box = $("loadMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Applied scenario inputs. Now click Run.`;
});

/* -------------------- initial render -------------------- */
run();
</script>
</body>
</html>
