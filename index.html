<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --fs: 16px;
      --bg: #e6e6e6;
      --card:#ffffff;
      --ink:#111;
      --muted:#444;
      --line:#c8c8c8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.92rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.05rem;font-weight:1000;margin-top:6px}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{border-color:rgba(0,140,0,.35);background:rgba(0,140,0,.07)}
    .warn{border-color:rgba(200,150,0,.35);background:rgba(200,150,0,.08)}
    .bad{border-color:rgba(180,0,0,.35);background:rgba(180,0,0,.08)}
    .canvasBox{margin-top:10px}
    canvas{
      display:block;width:100%!important;height:280px!important;max-height:280px!important;
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px;
    }

    /* spinner */
    .runRow{display:flex;gap:10px;align-items:center}
    .runRow button{flex:1}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(0,0,0,.15);
      border-top-color: rgba(0,0,0,.65);
      animation: spin .9s linear infinite;
      display:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Goat Farm Planner <span class="small">— reach your target herd + understand funding & timing</span></h1>

  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops when herd on farm reaches this size.">Target herd size</label>
          <input id="target" type="number" value="200" min="10"/>
        </div>
        <div class="row">
          <label title="Used for Target Confidence (if Monte Carlo is ON).">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6"/>
        </div>
        <div class="row">
          <label title="Safety cap for calculations and break-even checks.">Max months (safety)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12"/>
        </div>
        <div class="row">
          <label title="Make the text bigger/smaller.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16"/>
        </div>
      </div>

      <div>
        <div class="row">
          <label title="Turn Monte Carlo on/off. ON gives confidence + P50/P90.">Monte Carlo</label>
          <select id="mcOn">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="row">
          <label title="How many random runs when Monte Carlo is ON.">Monte Carlo runs</label>
          <input id="mcRuns" type="number" value="200" min="50" step="50"/>
        </div>
        <div class="row">
          <label title="Show/hide percentile shading on charts (when MC is ON).">Confidence bands</label>
          <select id="bandsOn">
            <option value="on">Show</option>
            <option value="off">Hide</option>
          </select>
        </div>

        <div class="runRow">
          <button id="runBtn">Run</button>
          <div class="spinner" id="spin"></div>
        </div>

        <button id="copyPromptBtn" style="margin-top:10px" title="Copies a ready-to-paste analysis prompt + the key results.">
          Copy analysis prompt
        </button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (bought at 3 months old; becomes breeding-active after 5 months)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Starting females on the farm, but not breeding until maturity delay completes.">Starting does</label>
            <input id="startDoes" type="number" value="4" min="0"/>
          </div>
          <div class="row">
            <label title="Starting bucks on the farm, but not active for servicing does until maturity delay completes.">Starting bucks</label>
            <input id="startBucks" type="number" value="1" min="0"/>
          </div>
          <div class="row">
            <label title="Fixed in this model.">Maturity delay</label>
            <input value="5 months (fixed)" disabled/>
          </div>
        </div>

        <div>
          <div class="banner small">
            Purchases schedule is simple and finite: <b>Month 4, 8, 12, 16, 20, 24, 28</b>.
            Purchased goats also take <b>5 months</b> before they can breed/service.
          </div>
          <div class="kpis" style="margin-top:10px">
            <div class="kpi">
              <small>Total goats bought (incl. starting herd)</small>
              <div class="v" id="p_totalBought">—</div>
            </div>
            <div class="kpi">
              <small>Total does bought</small>
              <div class="v" id="p_totalBoughtF">—</div>
            </div>
            <div class="kpi">
              <small>Total bucks bought</small>
              <div class="v" id="p_totalBoughtM">—</div>
            </div>
            <div class="kpi">
              <small>Purchase schedule used</small>
              <div class="v">4, 8, 12, 16, 20, 24, 28</div>
            </div>
          </div>
        </div>
      </div>

      <hr/>
      <b class="small">Expansion purchases (one-time plan)</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p4f" type="number" value="0" min="0"/>
              <input id="p4m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label>Month 8: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p8f" type="number" value="0" min="0"/>
              <input id="p8m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label>Month 12: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p12f" type="number" value="0" min="0"/>
              <input id="p12m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label>Month 16: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p16f" type="number" value="0" min="0"/>
              <input id="p16m" type="number" value="0" min="0"/>
            </div>
          </div>
        </div>

        <div>
          <div class="row"><label>Month 20: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p20f" type="number" value="0" min="0"/>
              <input id="p20m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label>Month 24: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p24f" type="number" value="0" min="0"/>
              <input id="p24m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label>Month 28: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p28f" type="number" value="0" min="0"/>
              <input id="p28m" type="number" value="0" min="0"/>
            </div>
          </div>
          <div class="row"><label title="You chose 20.">Does per buck</label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="50"/>
          </div>
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartPurchHerd"></canvas>
        <div class="small">Herd composition (stacked) shown here under Purchases (whole numbers)</div>
      </div>
    </div>
  </div>

  <!-- Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Growth assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label title="How often breeding happens as a batch (all at once).">Kidding interval (months)</label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18"/>
          </div>
          <div class="row"><label title="Batch breeding: % of eligible does that become pregnant in that breeding month.">Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100"/>
          </div>
          <div class="row"><label title="Average litter size.">Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="2" min="1" max="4" step="1"/>
          </div>
          <div class="row"><label title="Share of newborn kids that are female.">Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60"/>
          </div>
        </div>

        <div>
          <div class="row"><label title="Survival from birth to early life.">Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100"/>
          </div>
          <div class="row"><label title="Annual loss of breeding does, applied monthly.">Breeding doe loss %/year</label>
            <input id="doeLoss" type="number" value="3" min="0" max="25" step="1"/>
          </div>
          <div class="row"><label title="Female kids: % retained to grow the farm; rest sold for breeding at 6 months.">Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100"/>
          </div>
          <div class="row"><label title="All male kids are sold at this age (months).">Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12"/>
          </div>
        </div>
      </div>

      <hr/>
      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">
          Constraint: breedable does vs buck capacity. Buck count shown on 2nd axis.
          <span title="Buck capacity = bucks × does-per-buck. If does exceed this, breeding is capped.">ⓘ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Currency label</label><input id="cur" value="UGX"/></div>
          <div class="row"><label>Buy price: doe / buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyF" type="number" value="400000" min="0"/>
              <input id="buyM" type="number" value="400000" min="0"/>
            </div>
          </div>
          <div class="row"><label>Sale price: male kid / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellM" type="number" value="250000" min="0"/>
              <input id="sellFb" type="number" value="400000" min="0"/>
            </div>
          </div>
          <div class="banner small">
            If you ever saw a weird female sale like “79,999” before: that comes from price-randomization.
            This build does <b>not</b> randomize prices in Monte Carlo.
          </div>
        </div>

        <div>
          <div class="row"><label>Feed / goat / month</label><input id="feed" type="number" value="2500" min="0"/></div>
          <div class="row"><label>Medication / goat / month</label><input id="med" type="number" value="0" min="0"/></div>
          <div class="row"><label>Other variable / goat / month</label><input id="othVar" type="number" value="0" min="0"/></div>

          <div class="row"><label>Property / year</label><input id="propYr" type="number" value="1500000" min="0"/></div>
          <div class="row"><label>Labor / month (fixed)</label><input id="laborMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Vet / month (fixed)</label><input id="vetMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Security / month (fixed)</label><input id="secMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Transport / month (fixed)</label><input id="trMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Admin / month (fixed)</label><input id="adMo" type="number" value="0" min="0"/></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Operating break-even</small><div class="v" id="m_opbe">—</div></div>
        <div class="kpi"><small>Farm break-even</small><div class="v" id="m_fullbe">—</div></div>
        <div class="kpi"><small>Self-sustaining</small><div class="v" id="m_self">—</div></div>
        <div class="kpi"><small>Cash needed to start (6 months)</small><div class="v" id="m_startcash">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">Cumulative revenue vs cumulative costs (costs include operating + purchases + startup herd)</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyNet"></canvas>
        <div class="small">Monthly net (all-in): revenue − (operating + purchases). Whole numbers.</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Outcome KPIs</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (deterministic)</small><div class="v" id="s_det">—</div></div>
        <div class="kpi"><small>P50 time to target (MC)</small><div class="v" id="s_p50">—</div></div>
        <div class="kpi"><small>P90 time to target (MC)</small><div class="v" id="s_p90">—</div></div>
        <div class="kpi"><small>Target confidence by Month X</small><div class="v" id="s_conf">—</div></div>
      </div>

      <hr/>

      <b class="small">Money summary (at target month, or max months if never reached)</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total purchase spend (lifetime)</small><div class="v" id="s_purchSpend">—</div></div>
        <div class="kpi"><small>Total revenue to date</small><div class="v" id="s_rev">—</div></div>
        <div class="kpi"><small>Total costs to date</small><div class="v" id="s_cost">—</div></div>
        <div class="kpi"><small>Net position</small><div class="v" id="s_net">—</div></div>
      </div>

      <hr/>

      <b class="small">Herd composition at target month</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Does</small><div class="v" id="s_does">—</div></div>
        <div class="kpi"><small>Bucks</small><div class="v" id="s_bucks">—</div></div>
        <div class="kpi"><small>Young females</small><div class="v" id="s_yf">—</div></div>
        <div class="kpi"><small>Young males</small><div class="v" id="s_ym">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">Simple stacked bars: Total revenue vs Total operating costs vs Total purchases → net position</div>
      </div>

      <details style="margin-top:12px">
        <summary style="font-weight:900;cursor:pointer">Model assumptions (plain English)</summary>
        <div class="banner small" style="margin-top:10px" id="assumptionsBox"></div>
      </details>
    </div>
  </div>

</div>

<script>
/* ------------------ helpers ------------------ */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id).value||0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const round0=(x)=>Math.round(x);
const money=(n)=>`${(($("cur")?.value)||"UGX").trim()} ${Math.round(n).toLocaleString()}`;
const moFmt=(mo)=>{
  if(mo===null || mo===undefined) return "Never";
  const y=Math.floor(mo/12), m=mo%12;
  return y ? `${y}y ${m}m` : `${m} months`;
};

/* fixed biological constants requested */
const GEST = 5;         // gestation fixed
const MAT_DELAY = 5;    // starting herd + purchases mature after 5 months
const F_SALE_AGE = 6;   // female kids sold for breeding at 6 months

/* ------------------ UI ------------------ */
function tabInit(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $(b.dataset.tab).classList.add("active");
    };
  });
}
tabInit();

$("fontSize").addEventListener("input", ()=> {
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});

/* purchase schedule: one-time (not repeating) */
const PURCHASE_MONTHS = [4,8,12,16,20,24,28];
function purchForMonth(m){
  if(m===4)  return {f:N("p4f"),  m:N("p4m")};
  if(m===8)  return {f:N("p8f"),  m:N("p8m")};
  if(m===12) return {f:N("p12f"), m:N("p12m")};
  if(m===16) return {f:N("p16f"), m:N("p16m")};
  if(m===20) return {f:N("p20f"), m:N("p20m")};
  if(m===24) return {f:N("p24f"), m:N("p24m")};
  if(m===28) return {f:N("p28f"), m:N("p28m")};
  return {f:0,m:0};
}

/* ------------------ params ------------------ */
function getParams(){
  const propMo = N("propYr")/12;
  const fixedMo = propMo + N("laborMo") + N("vetMo") + N("secMo") + N("trMo") + N("adMo");

  return {
    target: N("target"),
    timeframe: N("timeframe"),
    maxMonths: N("maxMonths"),

    // purchased/starting herd
    startDoes: N("startDoes"),
    startBucks: N("startBucks"),
    doesPerBuck: N("doesPerBuck"),

    // growth
    kiddingInt: N("kiddingInt"),
    breedSuccess: N("breedSuccess"),
    kidsPerBirth: Math.round(N("kidsPerBirth")), // whole numbers
    pctFemale: N("pctFemale"),
    kidSurvival: N("kidSurvival"),
    doeLoss: N("doeLoss"),
    retainF: N("retainF"),
    maleSaleAge: clamp(N("maleSaleAge"),1,12),

    // money
    buyF: N("buyF"),
    buyM: N("buyM"),
    sellM: N("sellM"),
    sellFb: N("sellFb"),
    feed: N("feed"),
    med: N("med"),
    othVar: N("othVar"),
    fixedMo,

    // Monte Carlo
    mcOn: $("mcOn").value,
    mcRuns: N("mcRuns"),
    bandsOn: $("bandsOn").value
  };
}

/* ------------------ deterministic simulation ------------------
   IMPORTANT: Batch breeding (all eligible does in same month).
   Starting herd is immature at Month 0 and becomes active after MAT_DELAY.
*/
function simulateDeterministic(p){
  // active breeders
  let does = 0;
  let bucks = 0;

  // maturity pipeline for starting herd + purchases
  let pipeDoes = Array(MAT_DELAY).fill(0);
  let pipeBucks = Array(MAT_DELAY).fill(0);

  // load starting herd into pipeline (bought at 3 months old, active after 5 months)
  pipeDoes[0] = p.startDoes;
  pipeBucks[0] = p.startBucks;

  // female retained cohort until they become breeding does (keep simple: they become does at MAT_DELAY too)
  // (We keep it minimal: retained females are treated as "young females" until MAT_DELAY then become does.)
  let youngF = Array(MAT_DELAY).fill(0);

  // male kids held until sale
  let mCoh = Array(Math.max(p.maleSaleAge,1)).fill(0);

  // female kids sold for breeding at 6 months
  let fSaleCoh = Array(F_SALE_AGE).fill(0);

  // pregnancies recorded at month m; births at m+GEST
  let preg = Array(p.maxMonths + GEST + 2).fill(0);

  // money tracking
  let cumRev = 0;
  let cumCost = 0;
  let cumPurch = 0;

  // for break-evens
  let opBE = null;     // first month revenue >= operating costs
  let fullBE = null;   // first month net position >= 0
  let selfStart = null; // first month of 6 consecutive months net>=0

  // startup cash needed: (startup herd + 6 months operating)
  // cash needed to start = max deficit over time, but user wants "costs for 6 months"
  // We'll compute both: (a) strict: startup herd + 6 months operating at initial herd size
  // and (b) actual deficit over run; show (a) for startup.
  // (Your request: "My cash needed to start will be costs for 6 months.")
  const initialHerd = p.startDoes + p.startBucks;
  const startupHerdCost = p.startDoes*p.buyF + p.startBucks*p.buyM;
  const initialMonthlyOperating = initialHerd*(p.feed+p.med+p.othVar) + p.fixedMo;
  const startCash6 = startupHerdCost + 6*initialMonthlyOperating;

  // month 0 includes startup herd purchase cost
  cumCost += startupHerdCost;
  cumPurch += startupHerdCost;

  const rows = [];
  let reachedMonth = null;

  // track consecutive positive net months for self-sustaining
  let posStreak = 0;

  for(let m=0; m<p.maxMonths; m++){
    // mature pipeline into active
    const toDoes = pipeDoes[MAT_DELAY-1] || 0;
    const toBucks = pipeBucks[MAT_DELAY-1] || 0;
    for(let i=MAT_DELAY-1;i>=1;i--){ pipeDoes[i]=pipeDoes[i-1]; pipeBucks[i]=pipeBucks[i-1]; }
    pipeDoes[0]=0; pipeBucks[0]=0;
    does += toDoes;
    bucks += toBucks;

    // mature young retained females into does
    const yfToDoes = youngF[MAT_DELAY-1] || 0;
    for(let i=MAT_DELAY-1;i>=1;i--) youngF[i]=youngF[i-1];
    youngF[0]=0;
    does += yfToDoes;

    // doe loss (monthly)
    const lossM = (p.doeLoss/100)/12;
    does = Math.max(0, does * (1 - lossM));

    // births from pregnancies GEST months ago (lumps)
    const births = (m - GEST >= 0)
      ? preg[m - GEST] * p.kidsPerBirth * (p.kidSurvival/100)
      : 0;

    const fBorn = births * (p.pctFemale/100);
    const mBorn = births - fBorn;

    // female split: retain vs sold for breeding at 6 months
    const retainPct = clamp(p.retainF/100,0,1);
    const fRet = fBorn * retainPct;
    const fSale = fBorn - fRet;

    // add newborns to cohorts
    youngF[0] += fRet;
    if(mCoh.length>0) mCoh[0] += mBorn;
    fSaleCoh[0] += fSale;

    // sell males at sale age
    const maleSold = mCoh[mCoh.length-1] || 0;
    for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
    mCoh[0]=0;

    // sell females for breeding at 6 months
    const fBreedingSold = fSaleCoh[F_SALE_AGE-1] || 0;
    for(let i=F_SALE_AGE-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
    fSaleCoh[0]=0;

    // purchases this month (one-time schedule), go into maturity pipeline
    const pur = purchForMonth(m);
    pipeDoes[0] += pur.f;
    pipeBucks[0] += pur.m;

    const purchaseSpend = pur.f*p.buyF + pur.m*p.buyM;
    if(purchaseSpend>0){
      cumCost += purchaseSpend;
      cumPurch += purchaseSpend;
    }

    // -------- BATCH BREEDING EVENT (your request) --------
    const capacityDoes = bucks * p.doesPerBuck;
    const eligibleDoes = does;
    const canBreed = Math.min(eligibleDoes, capacityDoes);

    if (m % p.kiddingInt === 0) {
      preg[m] = canBreed * (p.breedSuccess/100);
    } else {
      preg[m] = 0;
    }
    // ------------------------------------------------------

    // herd on farm = active breeders + all young cohorts + pipelines (still on farm)
    const youngFem = youngF.reduce((a,b)=>a+b,0) + pipeDoes.reduce((a,b)=>a+b,0) + fSaleCoh.reduce((a,b)=>a+b,0);
    const youngMale = mCoh.reduce((a,b)=>a+b,0) + pipeBucks.reduce((a,b)=>a+b,0);
    const herdTotal = does + bucks + youngFem + youngMale;

    // operating costs this month
    const varCost = herdTotal * (p.feed + p.med + p.othVar);
    const opCost = varCost + p.fixedMo;
    cumCost += opCost;

    // revenue this month (no price randomization)
    const revenue = maleSold*p.sellM + fBreedingSold*p.sellFb;
    cumRev += revenue;

    // monthly net all-in (includes purchases)
    const netMonth = revenue - opCost - purchaseSpend;

    // operating break-even: revenue >= operating costs (ignore purchases)
    if(opBE===null && revenue >= opCost) opBE = m;

    // farm break-even: cumulative net position >= 0 (rev - cost)
    const netPosition = cumRev - cumCost;
    if(fullBE===null && netPosition >= 0) fullBE = m;

    // self-sustaining: monthly net >= 0 for 6 consecutive months
    if(netMonth >= 0){
      posStreak++;
      if(selfStart===null && posStreak>=6){
        selfStart = m - 5;
      }
    } else {
      posStreak = 0;
    }

    rows.push({
      m,
      does: round0(does),
      bucks: round0(bucks),
      youngFem: round0(youngFem),
      youngMale: round0(youngMale),
      herdTotal: round0(herdTotal),
      capacityDoes: round0(capacityDoes),
      revenue: round0(revenue),
      opCost: round0(opCost),
      purchaseSpend: round0(purchaseSpend),
      netMonth: round0(netMonth),
      cumRev: round0(cumRev),
      cumCost: round0(cumCost),
      netPosition: round0(netPosition)
    });

    if(reachedMonth===null && herdTotal >= p.target){
      reachedMonth = m;
      break;
    }
  }

  return {
    rows,
    reachedMonth,
    opBE,
    fullBE,
    selfStart,
    startCash6,
    startupHerdCost,
    cumRev: rows.length ? rows[rows.length-1].cumRev : round0(cumRev),
    cumCost: rows.length ? rows[rows.length-1].cumCost : round0(cumCost),
    cumPurch
  };
}

/* ------------------ Monte Carlo ------------------ */
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function jitter(r, base, pct){ return base*(1+((r()-0.5)*2*pct)); }

function simRand(p, seed){
  const r = rng(seed);
  const q = {...p};

  // randomize only biological rates (NOT prices)
  q.kidsPerBirth  = Math.round(clamp(jitter(r, p.kidsPerBirth, 0.12), 1, 4));
  q.kidSurvival   = clamp(jitter(r, p.kidSurvival, 0.10), 40, 100);
  q.breedSuccess  = clamp(jitter(r, p.breedSuccess, 0.08), 40, 100);
  q.doeLoss       = clamp(jitter(r, p.doeLoss, 0.15), 0, 25);

  const det = simulateDeterministic(q);
  return det.reachedMonth;
}

function monteCarlo(p){
  const runs = Math.max(50, Math.floor(p.mcRuns));
  const reached = [];
  let hitTF = 0;

  for(let i=0;i<runs;i++){
    const rm = simRand(p, 123456 + i*99991);
    if(rm!==null && rm!==undefined){
      reached.push(rm);
      if(rm <= p.timeframe) hitTF++;
    }
  }

  reached.sort((a,b)=>a-b);

  const pct = Math.round((hitTF / runs) * 100);
  const pctile=(q)=>{
    if(!reached.length) return null;
    const idx = Math.floor(q*(reached.length-1));
    return reached[idx];
  };

  return {
    runs,
    pct,
    p50: pctile(0.50),
    p90: pctile(0.90),
    best: reached.length ? reached[0] : null,
    reachedCount: reached.length
  };
}

/* ------------------ charts ------------------ */
let chPurchHerd=null, chCons=null, chCum=null, chNet=null, chWater=null;

function makeLine(canvasId, labels, datasets, extra={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type:"line",
    data:{labels,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:3.2,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{labels:{color:"#111",font:{weight:"800"}}},
        tooltip:{
          callbacks:{
            label:(ctx)=> {
              const v = ctx.parsed.y;
              return `${ctx.dataset.label}: ${Math.round(v).toLocaleString()}`;
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"},beginAtZero:true}
      },
      ...extra
    }
  });
}

function makeBar(canvasId, labels, datasets, extra={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type:"bar",
    data:{labels,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:3.2,
      plugins:{
        legend:{labels:{color:"#111",font:{weight:"800"}}},
        tooltip:{
          callbacks:{
            label:(ctx)=> `${ctx.dataset.label}: ${Math.round(ctx.parsed.y).toLocaleString()}`
          }
        }
      },
      scales:{
        x:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"},beginAtZero:true}
      },
      ...extra
    }
  });
}

/* ------------------ render ------------------ */
let lastPayload = null;

function renderAll(p, det, mc){
  const rows = det.rows;
  if(!rows.length) return;

  // horizon: end at target month if reached, else end at last row
  const lastIdx = rows.length - 1;
  const h = lastIdx;
  const slice = rows.slice(0, h+1);
  const labels = slice.map(r=>r.m);

  // Purchases KPIs
  const totalBoughtF = p.startDoes + PURCHASE_MONTHS.reduce((a,mm)=>a + (mm===4?N("p4f"):mm===8?N("p8f"):mm===12?N("p12f"):mm===16?N("p16f"):mm===20?N("p20f"):mm===24?N("p24f"):mm===28?N("p28f"):0),0);
  const totalBoughtM = p.startBucks + PURCHASE_MONTHS.reduce((a,mm)=>a + (mm===4?N("p4m"):mm===8?N("p8m"):mm===12?N("p12m"):mm===16?N("p16m"):mm===20?N("p20m"):mm===24?N("p24m"):mm===28?N("p28m"):0),0);
  $("p_totalBought").textContent  = (totalBoughtF + totalBoughtM).toLocaleString();
  $("p_totalBoughtF").textContent = totalBoughtF.toLocaleString();
  $("p_totalBoughtM").textContent = totalBoughtM.toLocaleString();

  // Charts: Purchases herd composition (stacked-ish lines)
  chPurchHerd?.destroy();
  chPurchHerd = makeLine("chartPurchHerd", labels, [
    {label:"Does", data:slice.map(r=>r.does), borderWidth:2, tension:.25, pointRadius:0, fill:true,
      borderColor:"rgba(0,140,0,.95)", backgroundColor:"rgba(0,140,0,.15)"},
    {label:"Young females", data:slice.map(r=>r.youngFem), borderWidth:2, tension:.25, pointRadius:0, fill:true,
      borderColor:"rgba(0,0,0,.55)", backgroundColor:"rgba(0,0,0,.08)"},
    {label:"Bucks", data:slice.map(r=>r.bucks), borderWidth:2, tension:.25, pointRadius:0, fill:true,
      borderColor:"rgba(0,90,180,.95)", backgroundColor:"rgba(0,90,180,.10)"},
    {label:"Young males", data:slice.map(r=>r.youngMale), borderWidth:2, tension:.25, pointRadius:0, fill:true,
      borderColor:"rgba(180,0,0,.8)", backgroundColor:"rgba(180,0,0,.08)"}
  ]);

  // Growth constraint chart with bucks on 2nd axis
  chCons?.destroy();
  chCons = new Chart($("chartConstraint").getContext("2d"), {
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Breedable does", data:slice.map(r=>r.does), yAxisID:"y",
          borderWidth:2, tension:.25, pointRadius:0, borderColor:"rgba(180,0,0,.95)"},
        {label:"Buck capacity (bucks×ratio)", data:slice.map(r=>r.capacityDoes), yAxisID:"y",
          borderWidth:2, tension:.25, pointRadius:0, borderDash:[6,4], borderColor:"rgba(0,140,0,.95)"},
        {label:"Bucks", data:slice.map(r=>r.bucks), yAxisID:"y2",
          borderWidth:2, tension:.25, pointRadius:0, borderColor:"rgba(0,90,180,.95)"}
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:3.2,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{labels:{color:"#111",font:{weight:"800"}}},
        tooltip:{callbacks:{label:(ctx)=> `${ctx.dataset.label}: ${Math.round(ctx.parsed.y).toLocaleString()}`}}
      },
      scales:{
        x:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"}},
        y:{position:"left",ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"},beginAtZero:true},
        y2:{position:"right",ticks:{color:"#111"},grid:{display:false},beginAtZero:true}
      }
    }
  });

  // Money KPIs
  $("m_opbe").textContent   = det.opBE===null ? "Never" : `Month ${det.opBE}`;
  $("m_fullbe").textContent = det.fullBE===null ? "Never" : `Month ${det.fullBE}`;
  $("m_self").textContent   = det.selfStart===null ? "Never" : `Month ${det.selfStart}`;
  $("m_startcash").textContent = money(det.startCash6);

  // Cumulative rev vs cost chart
  chCum?.destroy();
  chCum = makeLine("chartCumRevCost", labels, [
    {label:"Cumulative revenue", data:slice.map(r=>r.cumRev), borderWidth:2, tension:.25, pointRadius:0,
      borderColor:"rgba(0,140,0,.95)"},
    {label:"Cumulative costs", data:slice.map(r=>r.cumCost), borderWidth:2, tension:.25, pointRadius:0,
      borderColor:"rgba(180,0,0,.95)"}
  ]);

  // Monthly net chart
  chNet?.destroy();
  chNet = makeLine("chartMonthlyNet", labels, [
    {label:"Monthly net (all-in)", data:slice.map(r=>r.netMonth), borderWidth:3, tension:.25, pointRadius:0,
      borderColor:"rgba(0,0,0,.75)"}
  ], { scales:{ y:{ beginAtZero:false }}});

  // Snapshot outcomes
  $("s_det").textContent = det.reachedMonth===null ? "Never" : moFmt(det.reachedMonth);

  if(p.mcOn==="on"){
    $("s_p50").textContent  = moFmt(mc.p50);
    $("s_p90").textContent  = moFmt(mc.p90);
    $("s_conf").textContent = `${mc.pct}%`;
  } else {
    $("s_p50").textContent = "—";
    $("s_p90").textContent = "—";
    $("s_conf").textContent = "—";
  }

  // At target month (or last)
  const ref = slice[slice.length-1];
  $("s_purchSpend").textContent = money(det.cumPurch);
  $("s_rev").textContent = money(ref.cumRev);
  $("s_cost").textContent = money(ref.cumCost);
  $("s_net").textContent = money(ref.netPosition);

  $("s_does").textContent = ref.does.toLocaleString();
  $("s_bucks").textContent = ref.bucks.toLocaleString();
  $("s_yf").textContent = ref.youngFem.toLocaleString();
  $("s_ym").textContent = ref.youngMale.toLocaleString();

  // Waterfall-style stacked bars
  chWater?.destroy();
  const totalRev = ref.cumRev;
  const totalCost = ref.cumCost - det.cumPurch; // operating costs portion
  const totalPurch = det.cumPurch;
  const netPos = ref.netPosition;

  chWater = makeBar("chartWaterfall", ["At target/stop month"], [
    {label:"Total revenue", data:[totalRev], backgroundColor:"rgba(0,140,0,.35)", borderColor:"rgba(0,140,0,.8)", borderWidth:1},
    {label:"Total operating costs", data:[totalCost], backgroundColor:"rgba(180,0,0,.25)", borderColor:"rgba(180,0,0,.75)", borderWidth:1},
    {label:"Total purchase spend", data:[totalPurch], backgroundColor:"rgba(80,80,80,.20)", borderColor:"rgba(80,80,80,.60)", borderWidth:1},
    {label:"Net position", data:[netPos], backgroundColor:"rgba(0,0,0,.12)", borderColor:"rgba(0,0,0,.55)", borderWidth:1}
  ], { scales:{ y:{ beginAtZero:true }}});

  // assumptions box
  $("assumptionsBox").innerHTML = `
  <b>Breeding / biology assumptions</b><br/>
  • Gestation is fixed at <b>5 months</b><br/>
  • Starting herd is bought at <b>3 months old</b> and becomes active after <b>5 months</b><br/>
  • Purchased goats also take <b>5 months</b> to become active<br/>
  • Breeding happens as a <b>batch event</b> every <b>${p.kiddingInt}</b> months: all eligible does attempt breeding at once<br/>
  • Breeding is limited by <b>buck capacity = bucks × does-per-buck</b><br/>
  • Kid survival and breeding success are applied as percentages (planning averages)<br/><br/>

  <b>Sales assumptions</b><br/>
  • Male kids sold at <b>${p.maleSaleAge}</b> months<br/>
  • Female kids: <b>${p.retainF}%</b> retained, remainder sold for breeding at <b>6 months</b><br/>
  • No clearance selling rule in this version<br/><br/>

  <b>Money assumptions</b><br/>
  • Variable cost per goat per month is constant: feed + med + other<br/>
  • Fixed costs are constant monthly: property/12 + labor + vet + security + transport + admin<br/>
  • Break-even definitions:<br/>
  &nbsp;&nbsp;– Operating BE: revenue ≥ operating costs (excludes purchases)<br/>
  &nbsp;&nbsp;– Farm BE: cumulative net position ≥ 0 (includes purchases + startup herd)<br/>
  &nbsp;&nbsp;– Self-sustaining: monthly net ≥ 0 for 6 consecutive months<br/><br/>

  <b>Monte Carlo (if ON)</b><br/>
  • Randomizes only biological rates within a tight range<br/>
  • Does <b>not</b> randomize prices (so no weird sale values).
  `;

  // payload for copy prompt
  lastPayload = {
    inputs:{
      target:p.target,timeframe:p.timeframe,maxMonths:p.maxMonths,
      startDoes:p.startDoes,startBucks:p.startBucks,doesPerBuck:p.doesPerBuck,
      kiddingInt:p.kiddingInt,breedSuccess:p.breedSuccess,kidsPerBirth:p.kidsPerBirth,
      pctFemale:p.pctFemale,kidSurvival:p.kidSurvival,doeLoss:p.doeLoss,retainF:p.retainF,maleSaleAge:p.maleSaleAge,
      buyF:p.buyF,buyM:p.buyM,sellM:p.sellM,sellFb:p.sellFb,feed:p.feed,med:p.med,othVar:p.othVar,fixedMo:p.fixedMo,
      purchasePlan:{
        m4:{f:N("p4f"),m:N("p4m")}, m8:{f:N("p8f"),m:N("p8m")}, m12:{f:N("p12f"),m:N("p12m")},
        m16:{f:N("p16f"),m:N("p16m")}, m20:{f:N("p20f"),m:N("p20m")}, m24:{f:N("p24f"),m:N("p24m")}, m28:{f:N("p28f"),m:N("p28m")}
      }
    },
    results:{
      reachedMonth:det.reachedMonth, opBE:det.opBE, fullBE:det.fullBE, selfStart:det.selfStart,
      startCash6:det.startCash6,
      totalsAtStop:{cumRev:ref.cumRev,cumCost:ref.cumCost,netPosition:ref.netPosition, purchaseSpend:det.cumPurch},
      herdAtStop:{does:ref.does,bucks:ref.bucks,youngFem:ref.youngFem,youngMale:ref.youngMale,herdTotal:ref.herdTotal},
      monteCarlo: (p.mcOn==="on") ? mc : null
    }
  };
}

/* ------------------ copy analysis prompt button ------------------ */
$("copyPromptBtn").onclick = async ()=>{
  if(!lastPayload){ alert("Run the model first."); return; }
  const prompt =
`Analyze this goat farm model output and give me 5 practical recommendations to reach target faster WITHOUT breaking cash flow:
- Identify the main constraint (bucks capacity vs maturity delay vs purchase timing).
- Suggest a better mix of does vs bucks in months 4/8/12/16/20/24/28.
- If Monte Carlo exists, comment on risk (P50/P90, confidence).
- Keep answers in simple farmer language, but include exact month recommendations.

DATA:
${JSON.stringify(lastPayload,null,2)}
`;
  try{
    await navigator.clipboard.writeText(prompt);
    alert("Copied. Paste into ChatGPT for analysis.");
  }catch(e){
    alert("Could not copy automatically. Your browser blocked it.");
  }
};

/* ------------------ run with 1.5s spinner ------------------ */
function runNow(){
  const p = getParams();
  const det = simulateDeterministic(p);
  const mc = (p.mcOn==="on") ? monteCarlo(p) : {pct:null,p50:null,p90:null};

  renderAll(p, det, mc);
}

$("runBtn").onclick = ()=>{
  $("spin").style.display = "inline-block";
  setTimeout(()=>{
    runNow();
    $("spin").style.display = "none";
  }, 1500);
};

// initial run
runNow();
</script>
</body>
</html>
