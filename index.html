<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --fs: 16px;
      --bg: #e6e6e6;
      --card: #f7f7f7;
      --ink: #111;
      --muted: #444;
      --line: #c8c8c8;
      --good: rgba(0,140,0,.10);
      --warn: rgba(200,150,0,.12);
      --bad:  rgba(180,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:0.92rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.25fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button,details{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--ink);font-size:1rem
    }
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}.tab.active{display:block}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.1rem;font-weight:950;margin-top:6px}

    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{background:var(--good);border-color:rgba(0,140,0,.35)}
    .warn{background:var(--warn);border-color:rgba(200,150,0,.35)}
    .bad{background:var(--bad);border-color:rgba(180,0,0,.35)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}

    /* fixed chart height (no “growing down”) */
    .canvasBox{margin-top:10px}
    canvas{
      display:block;width:100% !important;height:280px !important;max-height:280px !important;
      background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px
    }

    /* tooltip helper (hover explanations) */
    .tip{position:relative;display:inline-block;border-bottom:1px dotted rgba(0,0,0,.35);cursor:help}
    .tip::after{
      content:attr(data-tip);
      position:absolute;left:0;top:120%;
      min-width:220px;max-width:360px;
      background:#111;color:#fff;
      padding:10px;border-radius:10px;
      font-weight:600;font-size:0.85rem;line-height:1.35;
      opacity:0;pointer-events:none;transform:translateY(-6px);
      transition:opacity .12s ease, transform .12s ease;
      z-index:10;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      white-space:normal;
    }
    .tip:hover::after{opacity:1;transform:translateY(0)}
    details summary{cursor:pointer;font-weight:900}
    details .small{margin-top:8px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>
    Goat Farm Planner
    <span class="small">— reach your target herd size + money planning + snapshot</span>
  </h1>

  <!-- Global controls -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label>
            Target herd size
            <span class="tip" data-tip="Simulation stops as soon as the herd ON FARM reaches this number (includes young animals held).">?</span>
          </label>
          <input id="target" type="number" value="200" min="10"/>
        </div>

        <div class="row">
          <label>
            Timeframe (months)
            <span class="tip" data-tip="Used for Target Confidence: chance you reach your target by this month (only when Monte Carlo is ON). Charts still stop at target month if you reach it earlier.">?</span>
          </label>
          <input id="timeframe" type="number" value="60" min="6"/>
        </div>

        <div class="row">
          <label>
            Max months (safety)
            <span class="tip" data-tip="Hard cap so the model can stop even if the target is never reached. Break-even checks also look up to this cap.">?</span>
          </label>
          <input id="maxMonths" type="number" value="120" min="24" step="12"/>
        </div>

        <div class="row">
          <label>
            Font size
            <span class="tip" data-tip="Just changes readability. Doesn’t affect the model.">?</span>
          </label>
          <input id="fontSize" type="range" min="14" max="22" value="16" />
        </div>
      </div>

      <div>
        <div class="row">
          <label>
            Monte Carlo
            <span class="tip" data-tip="If ON, we run many randomized simulations (only biology varies) to estimate confidence + P50/P90 time-to-target. Prices are NOT randomized.">?</span>
          </label>
          <select id="mcOn">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>

        <div class="row">
          <label>
            Monte Carlo runs
            <span class="tip" data-tip="More runs = smoother confidence results. 150–300 is usually enough.">?</span>
          </label>
          <input id="mcRuns" type="number" value="200" min="50" step="50"/>
        </div>

        <div class="row">
          <label>
            Currency label
          </label>
          <input id="cur" value="UGX"/>
        </div>

        <button id="runBtn">Run</button>
        <div class="small" style="margin-top:8px">
          Charts stay static until you click <b>Run</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs (order requested) -->
  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd + expansion purchases</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>
              Starting does (bought young)
              <span class="tip" data-tip="Your starting animals are bought at ~3 months old. They become breeding-active after 5 months (around 8 months old).">?</span>
            </label>
            <input id="startDoes" type="number" value="4" min="0" />
          </div>

          <div class="row">
            <label>
              Starting bucks (bought young)
              <span class="tip" data-tip="Starting bucks are also bought young and become breeding-active after 5 months (same as does).">?</span>
            </label>
            <input id="startBucks" type="number" value="1" min="0" />
          </div>

          <div class="row">
            <label>
              Purchase maturity delay
              <span class="tip" data-tip="Any goats you buy (starting herd or later purchases) become breeding-active only after this delay.">?</span>
            </label>
            <input value="5 months (fixed)" disabled />
          </div>

          <div class="row">
            <label>
              Starting herd age
              <span class="tip" data-tip="We assume the starting herd is bought at ~3 months of age.">?</span>
            </label>
            <input value="3 months old (fixed)" disabled />
          </div>

          <div class="row">
            <label>
              Total goats purchased (plan)
              <span class="tip" data-tip="This KPI counts starting herd + all expansion purchases you planned (across the months below).">?</span>
            </label>
            <div class="banner small" id="p_totalKpi">—</div>
          </div>
        </div>

        <div>
          <div class="banner small">
            Purchase months (edit quantities): <b>4, 8, 12, 16, 20, 24, 28</b>.
            <br/>Each purchase: <b>does / bucks</b>. Purchased animals become breeding-active after <b>5 months</b>.
          </div>

          <div style="margin-top:10px">
            <div class="row">
              <label>Month 4: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p4f" type="number" value="0" min="0"/>
                <input id="p4m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 8: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p8f" type="number" value="0" min="0"/>
                <input id="p8m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 12: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p12f" type="number" value="0" min="0"/>
                <input id="p12m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 16: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p16f" type="number" value="0" min="0"/>
                <input id="p16m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 20: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p20f" type="number" value="0" min="0"/>
                <input id="p20m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 24: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p24f" type="number" value="0" min="0"/>
                <input id="p24m" type="number" value="0" min="0"/>
              </div>
            </div>
            <div class="row">
              <label>Month 28: buy does / buy bucks</label>
              <div style="display:flex;gap:10px">
                <input id="p28f" type="number" value="0" min="0"/>
                <input id="p28m" type="number" value="0" min="0"/>
              </div>
            </div>
          </div>

          <div class="canvasBox">
            <canvas id="chartHerd"></canvas>
            <div class="small">
              Herd composition (moved under Purchases as requested). Whole numbers only.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Goat growth assumptions</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>
              Kidding interval (months)
              <span class="tip" data-tip="Average time between births per breeding doe. We model breeding as a monthly rate ≈ 1 / interval (not one big breeding event).">?</span>
            </label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18"/>
          </div>

          <div class="row">
            <label>
              Breeding success %
              <span class="tip" data-tip="Chance a breeding attempt results in pregnancy (average).">?</span>
            </label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100"/>
          </div>

          <div class="row">
            <label>
              Kids per birth
              <span class="tip" data-tip="Average litter size (e.g., 1.8 means some singles + some twins).">?</span>
            </label>
            <input id="kidsPerBirth" type="number" value="1.8" step="0.1" min="1" max="3.5"/>
          </div>

          <div class="row">
            <label>
              Kid survival %
              <span class="tip" data-tip="Percent of newborn kids that survive and stay on-farm long enough to be counted for costs/sales.">?</span>
            </label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100"/>
          </div>

          <div class="row">
            <label>
              Female kids %
              <span class="tip" data-tip="Share of newborn kids that are female (average).">?</span>
            </label>
            <input id="pctFemale" type="number" value="50" min="40" max="60"/>
          </div>
        </div>

        <div>
          <div class="row">
            <label>
              First breeding age (months)
              <span class="tip" data-tip="Retained female kids enter the breeding-doe pool at this age. Typical planning default: 9 months.">?</span>
            </label>
            <input id="breedAge" type="number" value="9" min="8" max="12"/>
          </div>

          <div class="row">
            <label>
              Does per buck
              <span class="tip" data-tip="Buck capacity = active bucks × this ratio. If breedable does exceed capacity, growth slows.">?</span>
            </label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="50"/>
          </div>

          <div class="row">
            <label>
              Breeding doe loss % / year
              <span class="tip" data-tip="Annual loss of breeding does (health, accidents). Applied monthly as an average.">?</span>
            </label>
            <input id="doeLoss" type="number" value="3" min="0" max="25" step="0.5"/>
          </div>

          <div class="row">
            <label>
              Retain female kids %
              <span class="tip" data-tip="Female kids retained for growth. The remainder are sold for breeding at 6 months.">?</span>
            </label>
            <input id="retainF" type="number" value="85" min="0" max="100"/>
          </div>

          <div class="row">
            <label>
              Male sale age (months)
              <span class="tip" data-tip="Male kids are held until this age, then sold.">?</span>
            </label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12"/>
          </div>

          <div class="row">
            <label>
              Gestation
              <span class="tip" data-tip="Pregnancy length. Fixed in this model.">?</span>
            </label>
            <input value="5 months (fixed)" disabled />
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target</small><div class="v" id="k_time">—</div></div>
        <div class="kpi"><small>Reached target?</small><div class="v" id="k_reach">—</div></div>
        <div class="kpi"><small>Buck capacity status</small><div class="v" id="k_buck">—</div></div>
        <div class="kpi"><small>Target confidence</small><div class="v" id="k_conf">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">
          Constraint chart: breedable does vs buck capacity. Includes a <b>buck count</b> line on a 2nd axis.
          <span class="tip" data-tip="Buck capacity = active bucks × does-per-buck. If does exceed that, some does can’t be served, and growth slows.">What’s buck capacity?</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>Buy price: doe / buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyF" type="number" value="400000" min="0"/>
              <input id="buyM" type="number" value="400000" min="0"/>
            </div>
          </div>

          <div class="row">
            <label>Sale price: male kid / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellM" type="number" value="250000" min="0"/>
              <input id="sellFb" type="number" value="400000" min="0"/>
            </div>
          </div>

          <div class="row">
            <label>
              Female breeding sale age
              <span class="tip" data-tip="Female kids not retained are sold for breeding at 6 months (fixed rule).">?</span>
            </label>
            <input value="6 months (fixed)" disabled />
          </div>

          <div class="row">
            <label>
              Startup cash runway (months)
              <span class="tip" data-tip="Startup cash here is planned as costs for this many months, plus the starting herd purchase at month 0.">?</span>
            </label>
            <input id="runwayMo" type="number" value="6" min="1" max="24"/>
          </div>
        </div>

        <div>
          <div class="row"><label>Feed / goat / month</label><input id="feed" type="number" value="2500" min="0"/></div>
          <div class="row"><label>Medication / goat / month</label><input id="med" type="number" value="0" min="0"/></div>
          <div class="row"><label>Other variable / goat / month</label><input id="othVar" type="number" value="0" min="0"/></div>

          <hr/>

          <div class="row"><label>Property (per year)</label><input id="propYr" type="number" value="1500000" min="0"/></div>
          <div class="row"><label>Labor (per month)</label><input id="laborMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Vet (per month)</label><input id="vetMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Security (per month)</label><input id="secMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Transport (per month)</label><input id="trMo" type="number" value="0" min="0"/></div>
          <div class="row"><label>Admin (per month)</label><input id="adMo" type="number" value="0" min="0"/></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Cash needed to start</small><div class="v" id="m_startcash">—</div></div>
        <div class="kpi"><small>Operating break-even</small><div class="v" id="m_opbe">—</div></div>
        <div class="kpi"><small>Farm break-even</small><div class="v" id="m_fullbe">—</div></div>
        <div class="kpi"><small>Self-sustaining</small><div class="v" id="m_self">—</div></div>
      </div>

      <div class="banner small" id="m_notes" style="margin-top:12px"></div>

      <div class="canvasBox">
        <canvas id="chartMonthlyRevCost"></canvas>
        <div class="small">
          Monthly revenue vs monthly all-in costs (operating + purchases). Whole numbers only.
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">
          Cumulative revenue vs cumulative all-in costs (running totals by month). Whole numbers only.
        </div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Snapshot (funding-ready summary)</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi">
          <small>Time to target (deterministic)</small>
          <div class="v" id="s_det">—</div>
        </div>
        <div class="kpi">
          <small>P50 time-to-target</small>
          <div class="v" id="s_p50">—</div>
        </div>
        <div class="kpi">
          <small>P90 time-to-target</small>
          <div class="v" id="s_p90">—</div>
        </div>
        <div class="kpi">
          <small>Target confidence by Month X</small>
          <div class="v" id="s_conf">—</div>
        </div>
      </div>

      <hr/>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total purchase spend (lifetime)</small><div class="v" id="s_purchSpend">—</div></div>
        <div class="kpi"><small>Total revenue to date (at target month)</small><div class="v" id="s_revTo">—</div></div>
        <div class="kpi"><small>Total costs to date (at target month)</small><div class="v" id="s_costTo">—</div></div>
        <div class="kpi"><small>Net position (at target month)</small><div class="v" id="s_netTo">—</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <b class="small">Herd composition at target</b>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><small>Does</small><div class="v" id="hc_does">—</div></div>
          <div class="kpi"><small>Bucks</small><div class="v" id="hc_bucks">—</div></div>
          <div class="kpi"><small>Young females</small><div class="v" id="hc_yf">—</div></div>
          <div class="kpi"><small>Young males</small><div class="v" id="hc_ym">—</div></div>
        </div>
        <div class="banner small" id="hc_note" style="margin-top:12px"></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">
          Waterfall-style summary (stacked bars): Total Revenue vs Total Operating Costs vs Total Purchase Spend → Net.
        </div>
      </div>

      <details style="margin-top:12px">
        <summary>Model assumptions (plain English)</summary>
        <div class="small">
          <b>Breeding / biology assumptions</b>
          <ul>
            <li>Gestation is <b>fixed at 5 months</b>.</li>
            <li>Starting herd is bought at <b>3 months old</b> and becomes breeding-active after <b>5 months</b>.</li>
            <li>Purchased goats also take <b>5 months</b> to become breeding-active.</li>
            <li>Breeding is modeled as a <b>monthly rate ≈ 1 / kidding interval</b> (not one big breeding event).</li>
            <li>Breeding is limited by <b>buck capacity = bucks × does-per-buck</b>.</li>
            <li>Kid survival and breeding success are applied as <b>average percentages</b>.</li>
          </ul>

          <b>Sales assumptions</b>
          <ul>
            <li>Male kids are sold at your chosen age.</li>
            <li>Female kids: retained % vs sold for breeding at <b>6 months</b>.</li>
            <li>No “clearance” selling rule unless you add it later.</li>
          </ul>

          <b>Money assumptions</b>
          <ul>
            <li>Variable cost per goat per month is constant (feed + medication + other).</li>
            <li>Fixed costs are constant monthly (property/12 + labor + vet + security + transport + admin).</li>
            <li><b>Operating break-even:</b> Revenue ≥ Operating costs (excludes purchases).</li>
            <li><b>Farm break-even:</b> cumulative net cash ≥ 0 (includes purchases).</li>
            <li><b>Self-sustaining:</b> monthly operating net ≥ 0 for 6 consecutive months.</li>
          </ul>

          <b>Monte Carlo assumptions (if ON)</b>
          <ul>
            <li>We randomize biology rates within a tight range to estimate confidence + P50/P90.</li>
            <li><b>We do not randomize prices</b> (to avoid weird values like 79,999) unless you add market volatility later.</li>
          </ul>
        </div>
      </details>
    </div>
  </div>

</div>

<script>
/* ---------------- helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id)?.value ?? 0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const round0=(x)=>Math.round(x);
const fmtInt=(x)=>round0(x).toLocaleString();
const money=(x)=>{
  const cur = (($("cur")?.value)||"UGX").trim() || "UGX";
  return `${cur} ${fmtInt(x)}`;
};
function moFmt(mo){
  if(mo===null || mo===undefined) return "Never";
  const y=Math.floor(mo/12), m=mo%12;
  return y?`${y}y ${m}m`:`${m} months`;
}
$("fontSize").addEventListener("input", ()=> {
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});
/* tabs */
document.querySelectorAll(".tabBtn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    $(b.dataset.tab).classList.add("active");
  };
});

/* ---------------- model constants ---------------- */
const GEST = 5;          // months
const PUR_MAT = 5;       // months (starting herd and purchased goats become active after this delay)
const F_SALE_AGE = 6;    // months fixed (female breeding sale)

/* ---------------- purchases schedule ---------------- */
function purchasePlanTotal(){
  const startD = N("startDoes"), startB = N("startBucks");
  const months = [4,8,12,16,20,24,28];
  let f=0,m=0;
  for(const mm of months){
    f += N(`p${mm}f`);
    m += N(`p${mm}m`);
  }
  return {startD,startB,f,m,total:startD+startB+f+m};
}
function purchaseForMonth(monthIdx){
  // monthIdx is 0-based month counter. Purchases keyed by month number itself (4,8,...)
  const monthNumber = monthIdx; // 0.. maxMonths
  const map = new Map([
    [4,  {f:N("p4f"),  m:N("p4m")}],
    [8,  {f:N("p8f"),  m:N("p8m")}],
    [12, {f:N("p12f"), m:N("p12m")}],
    [16, {f:N("p16f"), m:N("p16m")}],
    [20, {f:N("p20f"), m:N("p20m")}],
    [24, {f:N("p24f"), m:N("p24m")}],
    [28, {f:N("p28f"), m:N("p28m")}],
  ]);
  return map.get(monthNumber) || {f:0,m:0};
}

/* ---------------- parameters ---------------- */
function getParams(){
  const p = {
    target: N("target"),
    timeframe: Math.max(1, N("timeframe")),
    maxMonths: Math.max(24, N("maxMonths")),
    runwayMo: Math.max(1, N("runwayMo")),

    // Starting herd (young; becomes active after PUR_MAT months)
    startDoes: Math.max(0, N("startDoes")),
    startBucks: Math.max(0, N("startBucks")),

    // Growth
    kiddingInt: clamp(N("kiddingInt"),6,18),
    breedSuccess: clamp(N("breedSuccess"),40,100) / 100,
    kidsPerBirth: clamp(Number($("kidsPerBirth").value||1.8), 1, 3.5),
    kidSurvival: clamp(N("kidSurvival"),40,100) / 100,
    pctFemale: clamp(N("pctFemale"),40,60) / 100,
    breedAge: clamp(N("breedAge"),8,12),
    doesPerBuck: clamp(N("doesPerBuck"),5,50),
    doeLossYr: clamp(Number($("doeLoss").value||0), 0, 25) / 100,

    retainF: clamp(N("retainF"),0,100) / 100,
    maleSaleAge: clamp(N("maleSaleAge"),1,12),

    // Money
    buyF: Math.max(0, N("buyF")),
    buyM: Math.max(0, N("buyM")),
    sellM: Math.max(0, N("sellM")),
    sellFb: Math.max(0, N("sellFb")),

    feed: Math.max(0, N("feed")),
    med: Math.max(0, N("med")),
    othVar: Math.max(0, N("othVar")),

    propYr: Math.max(0, N("propYr")),
    laborMo: Math.max(0, N("laborMo")),
    vetMo: Math.max(0, N("vetMo")),
    secMo: Math.max(0, N("secMo")),
    trMo: Math.max(0, N("trMo")),
    adMo: Math.max(0, N("adMo")),

    mcOn: $("mcOn").value,
    mcRuns: Math.max(50, Math.floor(N("mcRuns")))
  };
  p.fixedMo = (p.propYr/12) + p.laborMo + p.vetMo + p.secMo + p.trMo + p.adMo;
  p.varPerGoatMo = p.feed + p.med + p.othVar;
  return p;
}

/* ---------------- deterministic simulation (whole-number outputs) ----------------
   We simulate in expected values but we DISPLAY whole numbers and chart whole numbers.
*/
function simulateDeterministic(p){
  // Active breeders
  let does = 0;
  let bucks = 0;

  // Starting herd pipelines (young -> active after PUR_MAT months)
  let startDoesPipe = Array(PUR_MAT).fill(0);
  let startBucksPipe = Array(PUR_MAT).fill(0);
  startDoesPipe[0] = p.startDoes;
  startBucksPipe[0] = p.startBucks;

  // Purchased pipelines (young -> active after PUR_MAT months)
  let pF = Array(PUR_MAT).fill(0);
  let pM = Array(PUR_MAT).fill(0);

  // Retained female cohort to breeding age
  let fCoh = Array(Math.max(p.breedAge,1)).fill(0);

  // Male cohort to sale age
  let mCoh = Array(Math.max(p.maleSaleAge,1)).fill(0);

  // Female cohort to breeding-sale age (fixed 6 months)
  let fSaleCoh = Array(F_SALE_AGE).fill(0);

  // Pregnancy queue (births after GEST months)
  let pregQ = Array(GEST).fill(0);

  // Money accumulators
  let cumNet = 0;
  let cumRev = 0;
  let cumOpCost = 0;
  let cumPurchSpend = 0;

  let opBE = null;     // first month rev >= op cost
  let farmBE = null;   // first month cumNet >= 0
  let selfSustain = null; // first month where op net >=0 for 6 consecutive months
  let opNonNegStreak = 0;

  // Record rows
  const rows = [];

  // Month 0 starting herd purchase spend (explicit)
  const startSpend = (p.startDoes*p.buyF) + (p.startBucks*p.buyM);
  cumNet -= startSpend;
  cumPurchSpend += startSpend;

  for(let m=0; m<p.maxMonths; m++){
    // Mature starting herd into active breeders
    const sdTo = startDoesPipe[PUR_MAT-1] || 0;
    const sbTo = startBucksPipe[PUR_MAT-1] || 0;
    for(let i=PUR_MAT-1;i>=1;i--){ startDoesPipe[i]=startDoesPipe[i-1]; startBucksPipe[i]=startBucksPipe[i-1]; }
    startDoesPipe[0]=0; startBucksPipe[0]=0;
    does += sdTo;
    bucks += sbTo;

    // Mature purchased breeders into active breeders
    const pfTo = pF[PUR_MAT-1] || 0;
    const pmTo = pM[PUR_MAT-1] || 0;
    for(let i=PUR_MAT-1;i>=1;i--){ pF[i]=pF[i-1]; pM[i]=pM[i-1]; }
    pF[0]=0; pM[0]=0;
    does += pfTo;
    bucks += pmTo;

    // Apply breeding doe loss (monthly)
    const lossM = p.doeLossYr / 12;
    does = Math.max(0, does * (1 - lossM));

    // Births from pregnancy queue
    const births = (pregQ[GEST-1] || 0) * p.kidsPerBirth * p.kidSurvival;
    // Shift pregnancy queue
    for(let i=GEST-1;i>=1;i--) pregQ[i]=pregQ[i-1];
    pregQ[0]=0;

    const fBorn = births * p.pctFemale;
    const mBorn = births - fBorn;

    // female split: retain vs sell for breeding (at 6 months)
    const fRet = fBorn * p.retainF;
    const fSell = fBorn - fRet;

    // add newborns into cohorts (month 0 bucket)
    if(fCoh.length>0) fCoh[0] += fRet;
    if(mCoh.length>0) mCoh[0] += mBorn;
    fSaleCoh[0] += fSell;

    // Mature retained females into does at breedAge
    const toDoes = fCoh[fCoh.length-1] || 0;
    for(let i=fCoh.length-1;i>=1;i--) fCoh[i]=fCoh[i-1];
    if(fCoh.length>0) fCoh[0]=0;
    does += toDoes;

    // Sell male kids at chosen age
    const maleSold = (mCoh.length>0) ? (mCoh[mCoh.length-1] || 0) : 0;
    for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
    if(mCoh.length>0) mCoh[0]=0;

    // Sell female kids for breeding at 6 months
    const femaleBreedingSold = fSaleCoh[F_SALE_AGE-1] || 0;
    for(let i=F_SALE_AGE-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
    fSaleCoh[0]=0;

    // Expansion purchases this month
    const pur = purchaseForMonth(m);
    pF[0] += pur.f;
    pM[0] += pur.m;
    const purchSpend = (pur.f*p.buyF) + (pur.m*p.buyM);

    // Breeding (monthly rate approx 1/kidding interval), limited by buck capacity
    const capDoes = bucks * p.doesPerBuck;
    const attempted = Math.min(does, capDoes);
    const monthlyRate = 1 / p.kiddingInt;
    const newPreg = attempted * monthlyRate * p.breedSuccess;
    pregQ[0] += newPreg;

    // Herd held on farm this month (for costs)
    const youngF = fCoh.reduce((a,b)=>a+b,0) + fSaleCoh.reduce((a,b)=>a+b,0) + pF.reduce((a,b)=>a+b,0) + startDoesPipe.reduce((a,b)=>a+b,0);
    const youngM = mCoh.reduce((a,b)=>a+b,0) + pM.reduce((a,b)=>a+b,0) + startBucksPipe.reduce((a,b)=>a+b,0);
    const herdTotal = does + bucks + youngF + youngM;

    // Money: revenue and costs
    const revenue = (maleSold * p.sellM) + (femaleBreedingSold * p.sellFb);
    const opCost = (herdTotal * p.varPerGoatMo) + p.fixedMo; // operating
    const allInCost = opCost + purchSpend;

    const net = revenue - allInCost;         // all-in net this month
    const opNet = revenue - opCost;          // operating net this month

    cumNet += net;
    cumRev += revenue;
    cumOpCost += opCost;
    cumPurchSpend += purchSpend;

    // operating BE and farm BE tracked to maxMonths
    if(opBE===null && revenue >= opCost) opBE = m;
    if(farmBE===null && cumNet >= 0) farmBE = m;

    // self-sustaining: opNet >= 0 for 6 consecutive months
    if(opNet >= 0){
      opNonNegStreak++;
      if(selfSustain===null && opNonNegStreak >= 6) selfSustain = m - 5;
    } else {
      opNonNegStreak = 0;
    }

    rows.push({
      m,
      does, bucks,
      youngF, youngM,
      herdTotal,
      capDoes,
      attempted,
      revenue, opCost, purchSpend, allInCost,
      net, opNet,
      cumNet, cumRev, cumOpCost, cumPurchSpend,
      maleSold, femaleBreedingSold
    });

    // Stop when target is reached (chart horizon is target)
    if(herdTotal >= p.target) break;
  }

  const reachedMonth = rows.length ? (rows[rows.length-1].herdTotal >= p.target ? rows[rows.length-1].m : null) : null;

  return {
    rows,
    reachedMonth,
    opBE,
    farmBE,
    selfSustain,
    startSpend
  };
}

/* ---------------- Monte Carlo (biology only; no price jitter) ---------------- */
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function simRandTimeToTarget(p, seed){
  const r = rng(seed);
  const jitter=(base,pct)=>base*(1+((r()-0.5)*2*pct));

  const q = {...p};

  // biology-only jitter (tight)
  q.kidsPerBirth  = clamp(jitter(p.kidsPerBirth, 0.12), 1, 3.5);
  q.kidSurvival   = clamp(jitter(p.kidSurvival, 0.10), 0.40, 1.00);
  q.breedSuccess  = clamp(jitter(p.breedSuccess, 0.08), 0.40, 1.00);
  q.doeLossYr     = clamp(jitter(p.doeLossYr, 0.20), 0.00, 0.25);

  const det = simulateDeterministic(q);
  return det.reachedMonth;
}
function monteCarlo(p){
  if(p.mcOn !== "on"){
    return {pct:null,p50:null,p90:null,runs:0};
  }
  const runs = p.mcRuns;
  const reached = [];
  let hitTF = 0;

  for(let i=0;i<runs;i++){
    const rm = simRandTimeToTarget(p, 123456 + i*99991);
    if(rm !== null){
      reached.push(rm);
      if(rm <= p.timeframe) hitTF++;
    }
  }
  reached.sort((a,b)=>a-b);

  const pct = Math.round((hitTF / runs) * 100);
  const pctile=(q)=>{
    if(!reached.length) return null;
    const idx = Math.floor(q*(reached.length-1));
    return reached[idx];
  };
  return {pct, p50:pctile(0.50), p90:pctile(0.90), runs};
}

/* ---------------- charts ---------------- */
let chHerd=null, chCons=null, chMon=null, chCum=null, chWF=null;

function makeLineChart(canvasId, labels, datasets, extraOptions={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 3.2,
      interaction: { mode:"index", intersect:false },
      plugins: {
        legend: { labels: { color:"#111", font: { weight:"800" } } },
        tooltip: {
          callbacks: {
            label: (ctx)=> `${ctx.dataset.label}: ${fmtInt(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: { ticks: { color:"#111" }, grid: { color:"rgba(0,0,0,.08)" } },
        y: {
          ticks: { color:"#111", callback: (v)=>fmtInt(v) },
          grid: { color:"rgba(0,0,0,.08)" }
        }
      },
      ...extraOptions
    }
  });
}

function makeBarChart(canvasId, labels, datasets, extraOptions={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "bar",
    data: { labels, datasets },
    options: {
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio: 3.2,
      plugins: {
        legend: { labels: { color:"#111", font:{weight:"900"} } },
        tooltip: {
          callbacks: {
            label: (ctx)=> `${ctx.dataset.label}: ${fmtInt(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: { ticks: { color:"#111" }, grid: { color:"rgba(0,0,0,.08)" } },
        y: { ticks: { color:"#111", callback:(v)=>fmtInt(v) }, grid: { color:"rgba(0,0,0,.08)" } }
      },
      ...extraOptions
    }
  });
}

/* ---------------- render ---------------- */
function horizonIndex(rows, reachedMonth, timeframe){
  const last = rows.length-1;
  if(last < 0) return 0;
  if(reachedMonth !== null) return Math.min(reachedMonth, last);
  return Math.min(timeframe, last);
}

function updatePurchasesKpi(){
  const t = purchasePlanTotal();
  $("p_totalKpi").innerHTML =
    `<b>${fmtInt(t.total)}</b> total goats planned (Start: ${fmtInt(t.startD+t.startB)}; Purchases: ${fmtInt(t.f+t.m)}). ` +
    `Breakdown: ${fmtInt(t.startD+t.f)} does, ${fmtInt(t.startB+t.m)} bucks.`;
}

function render(p, det, mc){
  const rows = det.rows;
  if(!rows.length){
    $("k_time").textContent = "—";
    return;
  }
  const h = horizonIndex(rows, det.reachedMonth, p.timeframe);
  const slice = rows.slice(0, h+1);
  const labels = slice.map(r=>r.m);

  // Growth KPIs
  $("k_reach").textContent = (det.reachedMonth===null) ? "No" : "Yes";
  $("k_time").textContent  = (det.reachedMonth===null) ? `Not reached (by ${p.maxMonths} months)` : moFmt(det.reachedMonth);

  const end = slice[slice.length-1];
  const cap = Math.max(1, end.capDoes);
  const util = end.does / cap;
  $("k_buck").textContent = util > 1 ? "Limiting (add bucks)" : util > 0.85 ? "Tight" : "Healthy";

  if(p.mcOn==="on"){
    $("k_conf").textContent = `${mc.pct}% by Month ${p.timeframe}`;
  } else {
    $("k_conf").textContent = "Monte Carlo OFF";
  }

  // Purchases KPI (plan totals)
  updatePurchasesKpi();

  // Charts: Herd (under Purchases)
  chHerd?.destroy();
  chHerd = makeLineChart("chartHerd", labels, [
    { label:"Does", data: slice.map(r=>round0(r.does)), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Bucks", data: slice.map(r=>round0(r.bucks)), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Young females", data: slice.map(r=>round0(r.youngF)), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Young males", data: slice.map(r=>round0(r.youngM)), borderWidth:2, tension:.25, pointRadius:0, fill:true },
  ], { scales: { y: { stacked:true }, x:{ stacked:true } } });

  // Constraint chart: does vs buck capacity + bucks on 2nd axis
  chCons?.destroy();
  chCons = new Chart($("chartConstraint").getContext("2d"), {
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Breedable does", data: slice.map(r=>round0(r.does)), borderWidth:2, tension:.25, pointRadius:0, yAxisID:"y" },
        { label:"Buck capacity (bucks×ratio)", data: slice.map(r=>round0(r.capDoes)), borderWidth:2, tension:.25, pointRadius:0, borderDash:[6,4], yAxisID:"y" },
        { label:"Bucks (count)", data: slice.map(r=>round0(r.bucks)), borderWidth:2, tension:.25, pointRadius:0, yAxisID:"y2" },
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:3.2,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{labels:{color:"#111",font:{weight:"800"}}},
        tooltip:{
          callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${fmtInt(ctx.parsed.y)}` }
        }
      },
      scales:{
        x:{ticks:{color:"#111"},grid:{color:"rgba(0,0,0,.08)"}},
        y:{position:"left",ticks:{color:"#111",callback:(v)=>fmtInt(v)},grid:{color:"rgba(0,0,0,.08)"}},
        y2:{
          position:"right",
          ticks:{color:"#111",callback:(v)=>fmtInt(v)},
          grid:{drawOnChartArea:false}
        }
      }
    }
  });

  // Money KPIs
  const runway = p.runwayMo;

  // startup cash (costs for runway months + starting herd spend)
  // conservative: uses month-0 herd count (starting herd in pipelines) for variable costs
  const month0 = slice[0];
  const herd0 = round0(month0.herdTotal);
  const runwayCost = runway * (p.fixedMo + herd0 * p.varPerGoatMo);
  const startupCash = det.startSpend + runwayCost;

  $("m_startcash").textContent = money(startupCash);

  $("m_opbe").textContent = (det.opBE===null) ? "Never" : `Month ${det.opBE}`;
  $("m_fullbe").textContent = (det.farmBE===null) ? "Never" : `Month ${det.farmBE}`;
  $("m_self").textContent = (det.selfSustain===null) ? "Never" : `Month ${det.selfSustain}`;

  $("m_notes").innerHTML =
    `Month 0 includes the <b>starting herd purchase</b>. ` +
    `Operating BE uses revenue vs operating costs (excludes purchases). Farm BE uses cumulative all-in net (includes purchases). ` +
    `Self-sustaining means operating net stays ≥ 0 for <b>6 months in a row</b>.`;

  // Money charts
  const rev = slice.map(r=>round0(r.revenue));
  const allIn = slice.map(r=>round0(r.allInCost));
  const cumRev = slice.map(r=>round0(r.cumRev));
  const cumAllIn = slice.map(r=>round0(r.cumOpCost + r.cumPurchSpend));

  chMon?.destroy();
  chMon = makeLineChart("chartMonthlyRevCost", labels, [
    { label:"Monthly revenue", data: rev, borderWidth:2, tension:.25, pointRadius:0 },
    { label:"Monthly all-in costs", data: allIn, borderWidth:2, tension:.25, pointRadius:0 },
  ]);

  chCum?.destroy();
  chCum = makeLineChart("chartCumRevCost", labels, [
    { label:"Cumulative revenue", data: cumRev, borderWidth:2, tension:.25, pointRadius:0 },
    { label:"Cumulative all-in costs", data: cumAllIn, borderWidth:2, tension:.25, pointRadius:0 },
  ]);

  // Snapshot outcomes
  $("s_det").textContent = (det.reachedMonth===null) ? "Never" : moFmt(det.reachedMonth);

  if(p.mcOn==="on"){
    $("s_p50").textContent = mc.p50===null ? "Never" : moFmt(mc.p50);
    $("s_p90").textContent = mc.p90===null ? "Never" : moFmt(mc.p90);
    $("s_conf").textContent = `${mc.pct}% by Month ${p.timeframe}`;
  } else {
    $("s_p50").textContent = "Monte Carlo OFF";
    $("s_p90").textContent = "Monte Carlo OFF";
    $("s_conf").textContent = "Monte Carlo OFF";
  }

  // Choose snapshot month: target month if reached, else last simulated month
  const snapRow = slice[slice.length-1];
  const totalPurchSpend = round0(snapRow.cumPurchSpend);
  const totalRevTo = round0(snapRow.cumRev);
  const totalCostsTo = round0(snapRow.cumOpCost + snapRow.cumPurchSpend);
  const netTo = round0(totalRevTo - totalCostsTo);

  $("s_purchSpend").textContent = money(totalPurchSpend);
  $("s_revTo").textContent = money(totalRevTo);
  $("s_costTo").textContent = money(totalCostsTo);
  $("s_netTo").textContent = money(netTo);

  // Herd composition at target month
  $("hc_does").textContent = fmtInt(snapRow.does);
  $("hc_bucks").textContent = fmtInt(snapRow.bucks);
  $("hc_yf").textContent = fmtInt(snapRow.youngF);
  $("hc_ym").textContent = fmtInt(snapRow.youngM);

  const breederShare = (snapRow.does + snapRow.bucks) / Math.max(1, snapRow.herdTotal);
  let shapeMsg = "";
  if(breederShare < 0.35){
    shapeMsg = "Herd shape note: You reached the number, but a lot of the herd is still young. That can slow near-term births and cash flow.";
  } else if(breederShare < 0.55){
    shapeMsg = "Herd shape note: Balanced mix of breeders and young stock.";
  } else {
    shapeMsg = "Herd shape note: Strong breeder-heavy herd (good for continued growth).";
  }
  $("hc_note").className = "banner small " + (breederShare < 0.35 ? "warn" : "good");
  $("hc_note").textContent = shapeMsg;

  // Waterfall-style stacked bar: Revenue vs Op Costs vs Purchase Spend -> Net
  chWF?.destroy();
  const wfLabels = ["At target month"];
  const opCostsTo = round0(snapRow.cumOpCost);
  const purchTo = round0(snapRow.cumPurchSpend);

  chWF = makeBarChart("chartWaterfall", wfLabels, [
    { label:"Total Revenue", data:[totalRevTo], stack:"wf" },
    { label:"Total Operating Costs", data:[-opCostsTo], stack:"wf" },
    { label:"Total Purchase Spend", data:[-purchTo], stack:"wf" },
    { label:"Net Position", data:[netTo], stack:"net" }
  ], {
    scales:{
      y:{
        ticks:{color:"#111",callback:(v)=>fmtInt(v)},
        grid:{color:"rgba(0,0,0,.08)"}
      }
    }
  });
}

/* ---------------- run ---------------- */
function run(){
  // quick guardrails
  $("breedAge").value = clamp(N("breedAge"),8,12);
  $("maleSaleAge").value = clamp(N("maleSaleAge"),1,12);
  $("retainF").value = clamp(N("retainF"),0,100);

  const p = getParams();
  updatePurchasesKpi();

  const det = simulateDeterministic(p);
  const mc = monteCarlo(p);

  render(p, det, mc);
}

$("runBtn").onclick = run;
updatePurchasesKpi();
run();
</script>
</body>
</html>
