<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Goat Farm Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e7eefc}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
h1{font-size:18px;margin:0 0 10px}
.card{background:#121a2b;border:1px solid #223150;border-radius:12px;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:1.3fr 1fr;gap:10px;align-items:center;margin:8px 0}
input,select,button{width:100%;padding:8px;border-radius:10px;border:1px solid #223150;background:#0e1730;color:#e7eefc}
button{cursor:pointer;font-weight:700}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.tabBtn{width:auto;padding:8px 10px}
.tabBtn.active{outline:2px solid rgba(169,184,214,.5)}
.tab{display:none}.tab.active{display:block}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:#0e1730;border:1px solid #223150;border-radius:12px;padding:10px}
.kpi small{color:#a9b8d6;display:block}
.banner{border:1px solid #223150;border-radius:12px;padding:10px;background:rgba(169,184,214,.08)}
.green{border-color:rgba(0,255,0,.35);background:rgba(0,255,0,.08)}
.yellow{border-color:rgba(255,255,0,.35);background:rgba(255,255,0,.08)}
.red{border-color:rgba(255,0,0,.35);background:rgba(255,0,0,.08)}
canvas{background:#0e1730;border:1px solid #223150;border-radius:12px;padding:8px}
.small{color:#a9b8d6;font-size:12px;line-height:1.35}
</style></head><body><div class="wrap">
<h1>Goat Farm Dashboard <span class="small">(Gestation: 5 months • Purchases: Month 4/8/12 yearly • Maturity delay: 5 months • Buck limit: 20 does/buck)</span></h1>

<div class="card">
  <div class="grid">
    <div>
      <div class="row"><label title="Goal herd size to stop the simulation.">Target herd size</label><input id="target" type="number" value="200" min="10"/></div>
      <div class="row"><label title="If target not reached, charts stop here (not at max months).">Timeframe (months)</label><input id="timeframe" type="number" value="48" min="6"/></div>
      <div class="row"><label title="Safety cap. Only used if target not reached.">Max months (safety)</label><input id="maxMonths" type="number" value="120" min="24" step="12"/></div>
    </div>
    <div>
      <div class="row"><label title="How many random simulations for confidence + percentiles. 150–300 is fine.">Monte Carlo runs</label><input id="mcRuns" type="number" value="250" min="50" step="50"/></div>
      <div class="row"><label title="Toggle to reduce breeding success outside peak months.">Seasonality</label>
        <select id="seasonOn"><option value="off">Off</option><option value="on">On</option></select></div>
      <div class="row"><label title="If seasonality ON: breeding success reduced by this % in off-season months.">Off-season penalty %</label><input id="seasonPenalty" type="number" value="15" min="0" max="60"/></div>
      <button id="runBtn">Run</button>
    </div>
  </div>
</div>

<div class="tabs">
  <button class="tabBtn active" data-tab="tGrowth">Goat Growth</button>
  <button class="tabBtn" data-tab="tPurch">Purchases</button>
  <button class="tabBtn" data-tab="tMoney">Money</button>
  <button class="tabBtn" data-tab="tSnap">Snapshot</button>
</div>

<div id="tGrowth" class="tab active">
  <div class="card"><b class="small">Growth inputs</b>
    <div class="grid">
      <div>
        <div class="row"><label title="Breeding females at Month 0.">Starting breeding does</label><input id="startDoes" type="number" value="4" min="0"/></div>
        <div class="row"><label title="Active breeding bucks at Month 0.">Starting active bucks</label><input id="startBucks" type="number" value="1" min="0"/></div>
        <div class="row"><label title="How often breedable does are bred.">Kidding interval (months)</label><input id="kiddingInt" type="number" value="12" min="6" max="18"/></div>
        <div class="row"><label title="Not all breedings result in pregnancy.">Breeding success %</label><input id="breedSuccess" type="number" value="90" min="40" max="100"/></div>
        <div class="row"><label title="Average litter size.">Kids per birth</label><input id="kidsPerBirth" type="number" value="1.8" step="0.1" min="1" max="3.5"/></div>
      </div>
      <div>
        <div class="row"><label title="Female share of newborn kids.">Female kids %</label><input id="pctFemale" type="number" value="50" min="40" max="60"/></div>
        <div class="row"><label title="Applied to newborn kids.">Kid survival %</label><input id="kidSurvival" type="number" value="90" min="40" max="100"/></div>
        <div class="row"><label title="Annual adult loss (mortality etc.), applied monthly.">Adult loss %/year</label><input id="adultLoss" type="number" value="5" min="0" max="25" step="0.5"/></div>
        <div class="row"><label title="Intentional removal of breeding does (old/infertile), applied monthly.">Cull rate %/year</label><input id="cullRate" type="number" value="5" min="0" max="30"/></div>
        <div class="row"><label title="Soft carrying capacity = acres × goats/acre. Exceeding it reduces growth.">Land acres / goats per acre</label>
          <div style="display:flex;gap:8px"><input id="acres" type="number" value="20" min="1"/><input id="goatsPerAcre" type="number" value="10" min="1"/></div></div>
      </div>
    </div>

    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><small>Time to target</small><div id="k_time">—</div></div>
      <div class="kpi"><small>Reached target?</small><div id="k_reach">—</div></div>
      <div class="kpi"><small>Capacity used (end)</small><div id="k_cap">—</div></div>
      <div class="kpi"><small>Stop-buy recommendation</small><div id="k_stop">—</div></div>
    </div>

    <div style="margin-top:10px">
      <canvas id="c1" height="120"></canvas>
      <div class="small">Chart 1: Herd composition (stacked area)</div>
    </div>
    <div style="margin-top:10px">
      <canvas id="c2" height="120"></canvas>
      <div class="small">Chart 2: Breeding constraint (does vs buck capacity)</div>
    </div>
  </div>
</div>

<div id="tPurch" class="tab">
  <div class="card"><b class="small">Purchases (repeat every year at Month 4 / 8 / 12)</b>
    <div class="grid">
      <div>
        <div class="row"><label title="Buck constraint ratio. You chose 20.">Does per buck</label><input id="doesPerBuck" type="number" value="20" min="5" max="50"/></div>
        <div class="banner small">Purchased females & bucks become active breeders after <b>5 months</b>.</div>
      </div>
      <div>
        <div class="row"><label>Month 4: females / bucks</label><div style="display:flex;gap:8px"><input id="p4f" type="number" value="0" min="0"/><input id="p4m" type="number" value="0" min="0"/></div></div>
        <div class="row"><label>Month 8: females / bucks</label><div style="display:flex;gap:8px"><input id="p8f" type="number" value="0" min="0"/><input id="p8m" type="number" value="0" min="0"/></div></div>
        <div class="row"><label>Month 12: females / bucks</label><div style="display:flex;gap:8px"><input id="p12f" type="number" value="0" min="0"/><input id="p12m" type="number" value="0" min="0"/></div></div>
      </div>
    </div>
  </div>
</div>

<div id="tMoney" class="tab">
  <div class="card"><b class="small">Money inputs</b>
    <div class="grid">
      <div>
        <div class="row"><label>Currency label</label><input id="cur" value="UGX"/></div>
        <div class="row"><label>Buy price female / buck</label><div style="display:flex;gap:8px"><input id="buyF" type="number" value="400000" min="0"/><input id="buyM" type="number" value="400000" min="0"/></div></div>
        <div class="row"><label>Sell price male kid / female kid</label><div style="display:flex;gap:8px"><input id="sellM" type="number" value="250000" min="0"/><input id="sellF" type="number" value="400000" min="0"/></div></div>
        <div class="row"><label title="% of male kids sold at birth/weaning for simplicity.">Sell male kids %</label><input id="sellMpct" type="number" value="90" min="0" max="100"/></div>
        <div class="row"><label title="% of female kids sold (0 keeps all to grow).">Sell female kids %</label><input id="sellFpct" type="number" value="0" min="0" max="100"/></div>
      </div>
      <div>
        <div class="row"><label>Feed/goat/month</label><input id="feed" type="number" value="2500" min="0"/></div>
        <div class="row"><label>Med/goat/month</label><input id="med" type="number" value="0" min="0"/></div>
        <div class="row"><label>Other variable/goat/month</label><input id="othVar" type="number" value="0" min="0"/></div>
        <div class="row"><label title="Feed inflation % per year.">Feed escalation %/year</label><input id="feedEsc" type="number" value="8" min="0" max="30"/></div>
        <div class="row"><label>Fixed costs: property/year + labor/mo</label>
          <div style="display:flex;gap:8px"><input id="propYr" type="number" value="1500000" min="0"/><input id="laborMo" type="number" value="0" min="0"/></div></div>
        <div class="row"><label>Security/mo + transport/mo + admin/mo</label>
          <div style="display:flex;gap:8px"><input id="secMo" type="number" value="0" min="0"/><input id="trMo" type="number" value="0" min="0"/><input id="adMo" type="number" value="0" min="0"/></div></div>
      </div>
    </div>

    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><small>Cash buffer required</small><div id="m_buf">—</div></div>
      <div class="kpi"><small>Month cash tightest</small><div id="m_worst">—</div></div>
      <div class="kpi"><small>Avg variable cost/month</small><div id="m_avgvar">—</div></div>
      <div class="kpi"><small>Fixed cost/month</small><div id="m_fixed">—</div></div>
    </div>

    <div style="margin-top:10px">
      <canvas id="cCash" height="120"></canvas>
      <div class="small">Cumulative cash (includes purchases + costs + sales)</div>
    </div>
  </div>
</div>

<div id="tSnap" class="tab">
  <div class="card"><b class="small">Snapshot</b>
    <div class="kpis" style="margin-top:10px">
      <div class="kpi"><small>Deterministic time</small><div id="s_det">—</div></div>
      <div class="kpi"><small>Best-case (MC)</small><div id="s_best">—</div></div>
      <div class="kpi"><small>P50 time (MC)</small><div id="s_p50">—</div></div>
      <div class="kpi"><small>P90 time (MC)</small><div id="s_p90">—</div></div>
    </div>
    <div id="s_conf" class="banner small" style="margin-top:10px;display:none"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const num=id=>Number($(id).value||0);
const fmt=(n)=>Math.round(n).toLocaleString();
const fmt1=(n)=>Math.round(n*10)/10;
const money=(n)=>`${($("cur").value||"UGX").trim()} ${Math.round(n).toLocaleString()}`;
const GEST=5, MAT=5;

function tabInit(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); document.getElementById(b.dataset.tab).classList.add("active");
    };
  });
}
tabInit();

function purchaseForMonth(m){
  const mod=m%12;
  if(mod===4) return {f:num("p4f"),m:num("p4m")};
  if(mod===8) return {f:num("p8f"),m:num("p8m")};
  if(mod===0) return {f:num("p12f"),m:num("p12m")}; // month 12,24,...
  return {f:0,m:0};
}
function capFactor(total,cap){ if(cap<=0||total<=cap) return 1; return cap/total; }
function seasonFactor(m){
  if($("seasonOn").value!=="on") return 1;
  const pen=num("seasonPenalty")/100;
  const mod=m%12; const peak=(mod>=2&&mod<=7);
  return peak?1:(1-pen);
}
function params(){
  const acres=num("acres"), gpa=num("goatsPerAcre");
  const cap=acres*gpa;
  const fixed=(num("propYr")/12)+num("laborMo")+num("secMo")+num("trMo")+num("adMo");
  return {
    target:num("target"), timeframe:num("timeframe"), maxMonths:num("maxMonths"),
    startDoes:num("startDoes"), startBucks:num("startBucks"),
    int:num("kiddingInt"),
    breedSuccess:num("breedSuccess")/100,
    kidsPerBirth:num("kidsPerBirth"),
    pctFemale:num("pctFemale")/100,
    kidSurv:num("kidSurvival")/100,
    adultLoss:num("adultLoss")/100, cull:num("cullRate")/100,
    doesPerBuck:num("doesPerBuck"),
    cap, fixed,
    buyF:num("buyF"), buyM:num("buyM"),
    sellM:num("sellM"), sellF:num("sellF"),
    sellMpct:num("sellMpct")/100, sellFpct:num("sellFpct")/100,
    feed:num("feed"), med:num("med"), othVar:num("othVar"), feedEsc:num("feedEsc")/100
  };
}

function simulate(p, overridePurch=null){
  let does=p.startDoes, bucks=p.startBucks;
  let total=does+bucks;
  const preg=Array(p.maxMonths).fill(0);
  let pf=Array(MAT).fill(0), pm=Array(MAT).fill(0);   // purchased young -> active
  let youngF=Array(10).fill(0); // simple youth pool for kept females (not detailed; just composition)
  let cash=-(p.startDoes*p.buyF + p.startBucks*p.buyM);
  let minCash=cash, minMonth=0;
  let sumVar=0, months=0;
  let reached=null;
  const rows=[];

  for(let m=0;m<p.maxMonths;m++){
    let pur = overridePurch ? overridePurch(m, purchaseForMonth(m)) : purchaseForMonth(m);
    const newPF=pur.f, newPM=pur.m;

    // shift purchased pipelines
    const pfTo=pf[MAT-1]||0; for(let i=MAT-1;i>=1;i--) pf[i]=pf[i-1]; pf[0]=newPF;
    const pmTo=pm[MAT-1]||0; for(let i=MAT-1;i>=1;i--) pm[i]=pm[i-1]; pm[0]=newPM;
    does += pfTo; bucks += pmTo;

    // adult loss + cull on does
    const lossM=(p.adultLoss/12), cullM=(p.cull/12);
    const lost=does*lossM, culled=does*cullM;
    does=Math.max(0, does-lost-culled);

    // births from gestation
    let born=0;
    if(m-GEST>=0){
      const cf=capFactor(total,p.cap);
      born = preg[m-GEST]*p.kidsPerBirth*p.kidSurv*cf;
    }
    const fBorn=born*p.pctFemale, mBorn=born*(1-p.pctFemale);
    const fSold=fBorn*p.sellFpct, mSold=mBorn*p.sellMpct;
    const fKeep=fBorn-fSold, mKeep=mBorn-mSold;

    // simple youth pool for composition only (kept females mature into does after ~10 months)
    const toDoes=youngF[youngF.length-1]||0; for(let i=youngF.length-1;i>=1;i--) youngF[i]=youngF[i-1]; youngF[0]=fKeep;
    does += toDoes;

    // breeding event
    if(m%p.int===0){
      const capDoes=bucks*p.doesPerBuck;
      const attempt=Math.min(does, capDoes);
      const cf=capFactor(total,p.cap);
      preg[m]=attempt*p.breedSuccess*cf*seasonFactor(m);
    }

    // update total herd (approx)
    total=Math.max(0, total - lost - culled + newPF + newPM + fKeep + mKeep);

    // money
    const years=m/12;
    const feedInfl=Math.pow(1+p.feedEsc, years);
    const varPer= (p.feed*feedInfl)+p.med+p.othVar;
    const varCost=total*varPer;
    const purchCost=newPF*p.buyF + newPM*p.buyM;
    const rev=mSold*p.sellM + fSold*p.sellF;
    const net=rev - varCost - p.fixed - purchCost;
    cash += net;
    if(cash<minCash){minCash=cash;minMonth=m;}
    sumVar += varCost; months++;

    rows.push({m,total,does,bucks,youngFem:youngF.reduce((a,b)=>a+b,0)+pf.reduce((a,b)=>a+b,0),youngMale:pm.reduce((a,b)=>a+b,0),cap:p.cap,cash,minCash,minMonth});
    if(reached===null && total>=p.target){reached=m; break;}
  }
  return {rows,reached,minCash,minMonth,avgVar:months?sumVar/months:0,fixed:p.fixed};
}

function pickH(rows,reached,timeframe){
  const last=rows.length-1;
  if(reached!==null) return Math.min(reached,last);
  return Math.min(timeframe,last);
}

function findStop(p){
  // try stopping after each purchase month
  const purchMonths=[];
  for(let m=0;m<p.maxMonths;m++){const mod=m%12; if(mod===4||mod===8||mod===0) purchMonths.push(m);}
  for(const cut of purchMonths){
    const res=simulate(p,(m,orig)=> (m>cut?{f:0,m:0}:orig));
    if(res.reached!==null) return {cut,reach:res.reached};
  }
  return null;
}

// Monte Carlo: perturb key rates
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function simRand(p,seed){
  const r=rng(seed);
  const jitter=(base,pct)=>base*(1+((r()-0.5)*2*pct));
  const q={...p};
  q.kidsPerBirth=Math.max(1,Math.min(3.5,jitter(p.kidsPerBirth,0.12)));
  q.kidSurv=Math.max(0.4,Math.min(1,jitter(p.kidSurv,0.10)));
  q.breedSuccess=Math.max(0.4,Math.min(1,jitter(p.breedSuccess,0.08)));
  q.adultLoss=Math.max(0,Math.min(0.4,jitter(p.adultLoss,0.15)));
  q.cull=Math.max(0,Math.min(0.6,jitter(p.cull,0.15)));
  return simulate(q,null).reached;
}
function confidence(p){
  const runs=num("mcRuns"), tf=p.timeframe;
  const reached=[];
  let hit=0;
  for(let i=0;i<runs;i++){
    const rm=simRand(p,123456+i*99991);
    if(rm!==null){reached.push(rm); if(rm<=tf) hit++;}
  }
  reached.sort((a,b)=>a-b);
  const pct=Math.round(hit/runs*100);
  const pctile=(q)=> reached.length?reached[Math.floor(q*(reached.length-1))]:null;
  return {pct,best:(reached[0]??null),p50:pctile(0.5),p90:pctile(0.9),reachedCount:reached.length};
}

let ch1=null,ch2=null,chCash=null;
function drawCharts(rows,h){
  const s=rows.slice(0,h+1), labels=s.map(x=>x.m);
  const comp=(id,ds,stacked)=>{
    const ctx=$(id).getContext("2d");
    return new Chart(ctx,{type:"line",data:{labels,datasets:ds},options:{
      responsive:true,maintainAspectRatio:false,interaction:{mode:"index",intersect:false},
      plugins:{legend:{labels:{color:"#a9b8d6"}}},
      scales:{x:{stacked, ticks:{color:"#a9b8d6"},grid:{color:"rgba(255,255,255,.05)"}},
              y:{stacked, ticks:{color:"#a9b8d6"},grid:{color:"rgba(255,255,255,.05)"}}}
    }});
  };

  ch1?.destroy(); ch2?.destroy(); chCash?.destroy();
  ch1=comp("c1",[
    {label:"Breeding does",data:s.map(x=>x.does),fill:true,stack:"herd",pointRadius:0,tension:.25,borderWidth:2},
    {label:"Young females",data:s.map(x=>x.youngFem),fill:true,stack:"herd",pointRadius:0,tension:.25,borderWidth:2},
    {label:"Active bucks",data:s.map(x=>x.bucks),fill:true,stack:"herd",pointRadius:0,tension:.25,borderWidth:2},
    {label:"Young males",data:s.map(x=>x.youngMale),fill:true,stack:"herd",pointRadius:0,tension:.25,borderWidth:2}
  ],true);

  ch2=comp("c2",[
    {label:"Breedable does",data:s.map(x=>x.does),pointRadius:0,tension:.25,borderWidth:2},
    {label:"Capacity (bucks×ratio)",data:s.map(x=>x.bucks*num("doesPerBuck")),pointRadius:0,tension:.25,borderWidth:2,borderDash:[6,4]}
  ],false);

  chCash=comp("cCash",[
    {label:"Cumulative cash",data:s.map(x=>x.cash),pointRadius:0,tension:.25,borderWidth:2}
  ],false);
}

function moFmt(mo){
  if(mo===null) return "—";
  const y=Math.floor(mo/12), m=mo%12;
  return y?`${y}y ${m}m`:`${m} months`;
}

function run(){
  const p=params();
  const res=simulate(p,null);
  const h=pickH(res.rows,res.reached,p.timeframe);

  // KPIs
  $("k_reach").textContent = res.reached===null ? "No" : "Yes";
  $("k_time").textContent = res.reached===null ? `Not reached in ${p.maxMonths} months` : moFmt(res.reached);
  const end=res.rows[Math.min(h,res.rows.length-1)];
  $("k_cap").textContent = p.cap>0 ? `${Math.round((end.total/p.cap)*100)}%` : "—";
  const stop=findStop(p);
  $("k_stop").textContent = stop ? `Stop after M${stop.cut}, still hit by M${stop.reach}` : "—";

  // Money KPIs
  $("m_buf").textContent = money(res.minCash);
  $("m_worst").textContent = `${res.minMonth}`;
  $("m_avgvar").textContent = money(res.avgVar);
  $("m_fixed").textContent = money(res.fixed);

  // Snapshot
  $("s_det").textContent = moFmt(res.reached);
  const conf=confidence(p);
  $("s_best").textContent = moFmt(conf.best);
  $("s_p50").textContent = moFmt(conf.p50);
  $("s_p90").textContent = moFmt(conf.p90);

  const confBox=$("s_conf");
  confBox.style.display="block";
  confBox.className="banner small "+(conf.pct>=70?"green":conf.pct>=40?"yellow":"red");
  confBox.textContent = `Target confidence: ${conf.pct}% chance to reach ${p.target} goats by Month ${p.timeframe}. (Reached at all: ${conf.reachedCount}/${num("mcRuns")})`;

  // Charts
  drawCharts(res.rows,h);
}

$("runBtn").onclick=run;
run();
</script></div></body></html>
