<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Dashboard</title>

  <!-- More reliable CDN than jsdelivr in many regions -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --accent:#2563eb;
      --good:#16a34a;
      --warn:#ca8a04;
      --bad:#dc2626;
      --radius:14px;
      --fs:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.9rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.35fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--ink);font-size:1rem
    }
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(37,99,235,.25)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{border:1px solid var(--line);border-radius:var(--radius);padding:12px;background:#fff}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.05rem;font-weight:900;margin-top:6px}
    .banner{border:1px solid var(--line);border-radius:var(--radius);padding:12px;background:#fff}
    .good{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.06)}
    .warn{border-color:rgba(202,138,4,.35);background:rgba(202,138,4,.08)}
    .bad{border-color:rgba(220,38,38,.35);background:rgba(220,38,38,.06)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}

    .canvasBox{margin-top:10px}
    canvas{
      display:block;width:100% !important;height:300px !important;max-height:300px !important;
      background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:8px;
    }

    /* Run button + spinner */
    .runRow{display:flex;gap:10px;align-items:center}
    .runRow button{flex:1}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(37,99,235,.25);
      border-top-color:rgba(37,99,235,.95);
      animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal (save confirmation) */
    .modalBack{
      position:fixed;inset:0;background:rgba(15,23,42,.35);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal{
      width:min(520px,100%);background:#fff;border:1px solid var(--line);border-radius:18px;padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
    }
    .modal h3{margin:0 0 8px}
    .modal .actions{display:flex;gap:10px;margin-top:12px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Goat Farm Dashboard
    <span class="small">— Purchases (M4/8/12/16/20/24/28), breeding + money + target confidence</span>
  </h1>

  <!-- Global controls -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops when you reach this herd size (or max months).">Target herd size</label>
          <input id="target" type="number" value="200" min="10"/>
        </div>
        <div class="row">
          <label title="Used for confidence: chance to hit target by this month.">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6"/>
        </div>
        <div class="row">
          <label title="Hard cap to prevent runaway simulation.">Max months (cap)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12"/>
        </div>
        <div class="row">
          <label title="Font size for readability.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16"/>
        </div>
      </div>

      <div>
        <div class="row">
          <label title="Monte Carlo = many randomized runs to estimate confidence (P50/P90, bands).">Monte Carlo</label>
          <select id="mcOn">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="row">
          <label title="How many runs to estimate confidence. 150–300 is typical.">Monte Carlo runs</label>
          <input id="mcRuns" type="number" value="200" min="50" step="50"/>
        </div>
        <div class="row">
          <label title="Show/hide uncertainty bands on charts (requires Monte Carlo ON).">Confidence bands</label>
          <select id="bandsOn">
            <option value="on">Show</option>
            <option value="off">Hide</option>
          </select>
        </div>

        <div class="runRow">
          <button id="runBtn">Run</button>
          <div id="spin" class="spinner" aria-label="Running"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <label title="Copy a prompt describing this scenario + results for analysis in ChatGPT.">Copy analysis prompt</label>
          <button id="copyBtn">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" data-tab="tPurch">Purchases</button>
    <button class="tabBtn" data-tab="tGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tMoney">Money</button>
    <button class="tabBtn" data-tab="tSnap">Snapshot</button>
    <button class="tabBtn" data-tab="tAdv">Advisory</button>
    <button class="tabBtn" data-tab="tSave">Save/Load</button>
  </div>

  <!-- Purchases TAB -->
  <div id="tPurch" class="tab active">
    <div class="card">
      <b>Starting herd & purchases</b>
      <div class="small" style="margin-top:6px">
        Starting herd is bought at <b>3 months old</b> unless you also add adults. Young goats: become ready after
        <b>5 months on farm</b> + <b>1 month buffer</b> before trying. Adult starters: try after <b>1 month</b>.
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Young goats (3 months old) at Month 0. They mature after 5 months on farm + 1 buffer month.">Start: Young does / Young bucks</label>
            <div style="display:flex;gap:10px">
              <input id="startYoungDoes" type="number" value="4" min="0"/>
              <input id="startYoungBucks" type="number" value="1" min="0"/>
            </div>
          </div>

          <div class="row">
            <label title="Adult goats at Month 0. They can try after 1 month.">Start: Adult does / Adult bucks</label>
            <div style="display:flex;gap:10px">
              <input id="startAdultDoes" type="number" value="0" min="0"/>
              <input id="startAdultBucks" type="number" value="0" min="0"/>
            </div>
          </div>

          <hr/>

          <b class="small">Expansion purchases (each month input does / bucks)</b>
          <div class="row"><label>Month 4 (young)</label><div style="display:flex;gap:10px"><input id="p4f" type="number" value="0" min="0"/><input id="p4m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 8 (young)</label><div style="display:flex;gap:10px"><input id="p8f" type="number" value="0" min="0"/><input id="p8m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 12 (young)</label><div style="display:flex;gap:10px"><input id="p12f" type="number" value="0" min="0"/><input id="p12m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 16 (young)</label><div style="display:flex;gap:10px"><input id="p16f" type="number" value="0" min="0"/><input id="p16m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 20 (young)</label><div style="display:flex;gap:10px"><input id="p20f" type="number" value="0" min="0"/><input id="p20m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 24 (young)</label><div style="display:flex;gap:10px"><input id="p24f" type="number" value="0" min="0"/><input id="p24m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 28 (young)</label><div style="display:flex;gap:10px"><input id="p28f" type="number" value="0" min="0"/><input id="p28m" type="number" value="0" min="0"/></div></div>

          <hr/>
          <b class="small">Adult purchases (optional) — Month 6 and 12</b>
          <div class="row"><label>Month 6 (adult)</label><div style="display:flex;gap:10px"><input id="a6f" type="number" value="0" min="0"/><input id="a6m" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 12 (adult)</label><div style="display:flex;gap:10px"><input id="a12f" type="number" value="0" min="0"/><input id="a12m" type="number" value="0" min="0"/></div></div>
        </div>

        <div>
          <div class="row">
            <label title="Buck capacity = bucks × does-per-buck. If breedable does exceed this, births are limited.">Does per buck</label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="60"/>
          </div>

          <div class="row">
            <label title="Currency label for all money fields.">Currency</label>
            <input id="cur" value="UGX"/>
          </div>

          <div class="banner small">
            KPI shows total goats bought (young + adult) across all purchase months. Month 0 startup purchases are included in Money.
          </div>

          <div class="kpis" style="margin-top:12px">
            <div class="kpi"><small>Total goats bought</small><div class="v" id="k_buyTotal">—</div></div>
            <div class="kpi"><small>Young bought</small><div class="v" id="k_buyYoung">—</div></div>
            <div class="kpi"><small>Adult bought</small><div class="v" id="k_buyAdult">—</div></div>
            <div class="kpi"><small>Startup herd</small><div class="v" id="k_startHerd">—</div></div>
          </div>

          <div class="canvasBox">
            <canvas id="chartHerdComp"></canvas>
            <div class="small">Herd composition over time (shows <b>total</b> on chart via tooltip; whole numbers).</div>
          </div>

          <div class="canvasBox">
            <canvas id="chartPurchMix"></canvas>
            <div class="small">Purchased goats over time (young vs adult). Whole numbers.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Growth TAB -->
  <div id="tGrowth" class="tab">
    <div class="card">
      <b>Growth assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="All breedable does attempt together on the breeding month; 90% means 9/10 succeed on average.">Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100"/>
          </div>
          <div class="row">
            <label title="Average kids per birth.">Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1"/>
          </div>
          <div class="row">
            <label title="Female share of newborn kids.">Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60"/>
          </div>
          <div class="row">
            <label title="Survival from birth through early life.">Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100"/>
          </div>
          <div class="row">
            <label title="How often an adult doe can conceive again after giving birth (rest period). You chose 3 months.">Post-birth rest (months)</label>
            <input id="restMonths" type="number" value="3" min="1" max="6"/>
          </div>
        </div>

        <div>
          <div class="row">
            <label title="Retained female kids can only start trying from this age. You requested 8 months.">Retained doe first-try age (months)</label>
            <input id="retainedTryAge" type="number" value="8" min="6" max="14"/>
          </div>
          <div class="row">
            <label title="Gestation is fixed at 5 months (150 days).">Gestation</label>
            <input value="5 months (fixed)" disabled/>
          </div>
          <div class="row">
            <label title="If ON, freeze sales for N months to focus on growth first.">Freeze sales?</label>
            <select id="freezeSalesOn">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div class="row">
            <label title="If freeze sales ON: no sales happen before this month number.">Freeze sales months</label>
            <input id="freezeMonths" type="number" value="0" min="0" max="60"/>
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Reached target?</small><div class="v" id="g_reach">—</div></div>
        <div class="kpi"><small>Time to target (det)</small><div class="v" id="g_time">—</div></div>
        <div class="kpi"><small>Herd at target (total)</small><div class="v" id="g_totalAt">—</div></div>
        <div class="kpi"><small>Herd at target (does/bucks)</small><div class="v" id="g_dbAt">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">Constraint: Breedable does vs Buck capacity + Bucks line (2nd axis). Whole numbers.</div>
      </div>
    </div>
  </div>

  <!-- Money TAB -->
  <div id="tMoney" class="tab">
    <div class="card">
      <b>Money assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Young goat purchase price (3 months old).">Buy price (young): doe / buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyYoungF" type="number" value="400000" min="0"/>
              <input id="buyYoungM" type="number" value="400000" min="0"/>
            </div>
          </div>

          <div class="row">
            <label title="Adult goat purchase price.">Buy price (adult): doe / buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyAdultF" type="number" value="400000" min="0"/>
              <input id="buyAdultM" type="number" value="400000" min="0"/>
            </div>
          </div>

          <div class="row">
            <label title="Male kid sale price.">Sell price: male kid</label>
            <input id="sellM" type="number" value="250000" min="0"/>
          </div>

          <div class="row">
            <label title="Female sold for breeding at 6 months.">Sell price: female (breeding)</label>
            <input id="sellF" type="number" value="400000" min="0"/>
          </div>

          <div class="row">
            <label title="Male kids sold at this age (months).">Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12"/>
          </div>

          <div class="row">
            <label title="Female kids: keep this % to grow; the remainder sold for breeding at 6 months.">Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100"/>
          </div>
        </div>

        <div>
          <div class="row">
            <label>Feed / goat / month</label>
            <input id="feed" type="number" value="2500" min="0"/>
          </div>
          <div class="row">
            <label>Medication / goat / month</label>
            <input id="med" type="number" value="0" min="0"/>
          </div>
          <div class="row">
            <label>Other variable / goat / month</label>
            <input id="othVar" type="number" value="0" min="0"/>
          </div>

          <hr/>

          <div class="row">
            <label>Property / year</label>
            <input id="propYr" type="number" value="1500000" min="0"/>
          </div>
          <div class="row">
            <label>Labor / month (fixed)</label>
            <input id="laborMo" type="number" value="0" min="0"/>
          </div>
          <div class="row">
            <label>Vet / month (fixed)</label>
            <input id="vetMo" type="number" value="0" min="0"/>
          </div>
          <div class="row">
            <label>Security / month (fixed)</label>
            <input id="secMo" type="number" value="0" min="0"/>
          </div>
          <div class="row">
            <label>Transport / month (fixed)</label>
            <input id="trMo" type="number" value="0" min="0"/>
          </div>
          <div class="row">
            <label>Admin / month (fixed)</label>
            <input id="adMo" type="number" value="0" min="0"/>
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Cash needed to start (buffer)</small><div class="v" id="m_startCash">—</div></div>
        <div class="kpi"><small>Cash-flow sustaining</small><div class="v" id="m_sustain">—</div></div>
        <div class="kpi"><small>Full payback</small><div class="v" id="m_payback">—</div></div>
        <div class="kpi"><small>Inventory value (farm)</small><div class="v" id="m_inv">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyNet"></canvas>
        <div class="small">Monthly net (all-in). Month 0 includes startup purchases. Green when positive, red when negative.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">Cumulative revenue vs cumulative total costs (operating + purchases). Shows when revenue overtakes costs.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartRevenueVsCost"></canvas>
        <div class="small">Monthly revenue vs monthly total costs (operating + purchases spikes).</div>
      </div>
    </div>
  </div>

  <!-- Snapshot TAB -->
  <div id="tSnap" class="tab">
    <div class="card">
      <b>Snapshot</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (det)</small><div class="v" id="s_det">—</div></div>
        <div class="kpi"><small>P50 / P90 (MC)</small><div class="v" id="s_p">—</div></div>
        <div class="kpi"><small>Target confidence (by timeframe)</small><div class="v" id="s_conf">—</div></div>
        <div class="kpi"><small>Net revenue at target</small><div class="v" id="s_netAt">—</div></div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="banner small" id="s_herdAt">
          Herd at target: —
        </div>
        <div class="banner small" id="s_moneyAt">
          At target month: —
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">By target month (or max months): Total Revenue vs Total Operating Costs vs Total Purchase Spend → Net Position.</div>
      </div>

      <details class="card" style="margin-top:12px">
        <summary style="cursor:pointer;font-weight:900">Model assumptions (plain English)</summary>
        <div class="small" style="margin-top:8px">
          <b>Breeding/biology</b><br/>
          • Gestation fixed at 5 months (150 days)<br/>
          • Starting herd bought at 3 months old: ready after 5 months on-farm + 1 month buffer before trying<br/>
          • Starting adults: can try after 1 month<br/>
          • After giving birth, a doe waits 3 months (rest) before it can conceive again<br/>
          • Retained female kids can only start trying from 8 months+<br/>
          • Breeding limited by buck capacity = bucks × does-per-buck<br/>
          • Success rate and survival rates applied as averages<br/><br/>

          <b>Sales</b><br/>
          • Male kids sold at your chosen age (months)<br/>
          • Female kids: retained % vs sold for breeding at 6 months<br/>
          • You can freeze sales for N months to focus on growth<br/><br/>

          <b>Money</b><br/>
          • Variable costs per goat per month = feed + med + other<br/>
          • Fixed costs constant monthly (property/12 + labor + vet + security + transport + admin)<br/>
          • Month 0 includes startup purchase spend<br/>
          • Cash-flow sustaining: from some month onward, cumulative cash never falls below 0 again (no external injection needed)<br/>
          • Full payback: first month cumulative cash becomes ≥ 0 (startup fully recovered)<br/><br/>

          <b>Monte Carlo (if ON)</b><br/>
          • We randomize biological rates in a tight range to estimate confidence and bands<br/>
          • We do not randomize prices (avoids weird values like 79,999)
        </div>
      </details>
    </div>
  </div>

  <!-- Advisory TAB -->
  <div id="tAdv" class="tab">
    <div class="card">
      <b>Advisory</b>
      <div class="small" style="margin-top:6px">
        This tab gives simple hints (not overcomplicated) to improve reaching target within timeframe and ending net position.
      </div>

      <div class="banner small" id="advBox" style="margin-top:12px">
        Run the model to see advisory hints.
      </div>
    </div>
  </div>

  <!-- Save/Load TAB -->
  <div id="tSave" class="tab">
    <div class="card">
      <b>Save / Load scenario</b>
      <div class="small" style="margin-top:6px">
        Save a scenario file to your computer and reload later to restore all inputs.
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <div class="row">
            <label>Scenario name</label>
            <input id="scName" value="my_goat_plan"/>
          </div>
          <button id="saveBtn">Save scenario</button>
        </div>
        <div>
          <div class="row">
            <label>Load scenario file</label>
            <input id="loadFile" type="file" accept="application/json"/>
          </div>
          <button id="loadBtn">Load scenario</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Save confirmation modal -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <h3>Saved ✅</h3>
    <div class="small">Your scenario file has been saved to your computer.</div>
    <div class="actions">
      <button id="closeModal">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Utilities
========================= */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number(($(id)?.value ?? 0) || 0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const roundInt = (x)=>Math.round(x);
const money = (n)=>{
  const cur = ($("cur").value||"UGX").trim();
  return `${cur} ${Math.round(n).toLocaleString()}`;
};
function moFmt(m){
  if(m===null || m===undefined) return "Never";
  const y = Math.floor(m/12), mm = m%12;
  return y ? `${y}y ${mm}m` : `${mm} months`;
}
function parseListMonths(str){
  return new Set((str||"").split(",").map(s=>parseInt(s.trim(),10)).filter(x=>x>=1 && x<=12));
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    $(btn.dataset.tab).classList.add("active");
  });
});

/* =========================
   Font size
========================= */
$("fontSize").addEventListener("input", ()=>{
  document.documentElement.style.setProperty("--fs", $("fontSize").value+"px");
});

/* =========================
   Purchases schedule
========================= */
const YOUNG_PUR_MONTHS = [4,8,12,16,20,24,28];
function youngPurchaseAtMonth(m){
  const map = {
    4:{f:N("p4f"), m:N("p4m")},
    8:{f:N("p8f"), m:N("p8m")},
    12:{f:N("p12f"), m:N("p12m")},
    16:{f:N("p16f"), m:N("p16m")},
    20:{f:N("p20f"), m:N("p20m")},
    24:{f:N("p24f"), m:N("p24m")},
    28:{f:N("p28f"), m:N("p28m")},
  };
  return map[m] || {f:0,m:0};
}
function adultPurchaseAtMonth(m){
  const map = {
    6:{f:N("a6f"), m:N("a6m")},
    12:{f:N("a12f"), m:N("a12m")},
  };
  return map[m] || {f:0,m:0};
}
function totalBoughtKPIs(){
  // month0 starters count as purchases too
  const startYoung = N("startYoungDoes")+N("startYoungBucks");
  const startAdult = N("startAdultDoes")+N("startAdultBucks");

  let young=0, adult=0;
  for(const mm of YOUNG_PUR_MONTHS){
    const p = youngPurchaseAtMonth(mm);
    young += p.f + p.m;
  }
  [6,12].forEach(mm=>{
    const p=adultPurchaseAtMonth(mm);
    adult += p.f + p.m;
  });

  $("k_buyYoung").textContent = String(startYoung + young);
  $("k_buyAdult").textContent = String(startAdult + adult);
  $("k_buyTotal").textContent = String(startYoung + startAdult + young + adult);
  $("k_startHerd").textContent = String(startYoung + startAdult);
}

/* =========================
   Model parameters
========================= */
const GEST = 5; // 150 days ~ 5 months

function getParams(){
  return {
    target: N("target"),
    timeframe: N("timeframe"),
    maxMonths: N("maxMonths"),
    mcOn: $("mcOn").value,
    mcRuns: clamp(N("mcRuns"), 0, 5000),
    bandsOn: $("bandsOn").value,

    // purchases / capacity
    doesPerBuck: clamp(N("doesPerBuck"), 1, 200),

    // breeding
    breedSuccess: clamp(N("breedSuccess"), 0, 100)/100,
    kidsPerBirth: Math.max(1, N("kidsPerBirth")),
    pctFemale: clamp(N("pctFemale"), 0, 100)/100,
    kidSurvival: clamp(N("kidSurvival"), 0, 100)/100,
    restMonths: clamp(N("restMonths"), 0, 12),
    retainedTryAge: clamp(N("retainedTryAge"), 0, 24),

    // sales logic
    freezeSalesOn: $("freezeSalesOn").value,
    freezeMonths: clamp(N("freezeMonths"), 0, 120),
    maleSaleAge: clamp(N("maleSaleAge"), 1, 12),
    retainF: clamp(N("retainF"), 0, 100)/100,

    // money
    buyYoungF: N("buyYoungF"), buyYoungM: N("buyYoungM"),
    buyAdultF: N("buyAdultF"), buyAdultM: N("buyAdultM"),
    sellM: N("sellM"), sellF: N("sellF"),
    feed: N("feed"), med: N("med"), othVar: N("othVar"),
    propYr: N("propYr"),
    laborMo: N("laborMo"), vetMo: N("vetMo"), secMo: N("secMo"), trMo: N("trMo"), adMo: N("adMo"),

    // starting herd
    startYoungDoes: N("startYoungDoes"), startYoungBucks: N("startYoungBucks"),
    startAdultDoes: N("startAdultDoes"), startAdultBucks: N("startAdultBucks"),
  };
}

/* =========================
   Deterministic simulation
   - whole-number outputs
   - breeding cycles: “together” monthly eligibility
========================= */
function simulateDet(p){
  // We track cohorts by age (months on farm) for:
  // - young does/bucks (start or purchased) to become “breed-eligible” after 5 months + 1 buffer
  // - adult does (already mature) but can only try after 1 month on farm (starter & purchased adult)
  // - retained female kids: can try after retainedTryAge
  // - males: sold at maleSaleAge
  // - females sold for breeding: sold at 6 months (unless freeze)

  const MAX = p.maxMonths;

  // Young starter cohorts (3 months old): they become eligible after 5 months + 1 buffer = 6 months on-farm
  const YOUNG_READY = 6; // 5 mature + 1 buffer
  let youngDoes = Array(YOUNG_READY).fill(0);
  let youngBucks = Array(YOUNG_READY).fill(0);
  youngDoes[0] = p.startYoungDoes;
  youngBucks[0] = p.startYoungBucks;

  // Adult starters: can try after 1 month on-farm
  const ADULT_READY = 1;
  let adultDoes = Array(ADULT_READY).fill(0);
  let adultBucks = Array(ADULT_READY).fill(0);
  adultDoes[0] = p.startAdultDoes;
  adultBucks[0] = p.startAdultBucks;

  // Retained female kids cohort until they can try
  const TRY_AGE = Math.max(1, p.retainedTryAge);
  let retainedF = Array(TRY_AGE).fill(0);

  // Female kids sold for breeding at 6 months
  const FSALE_AGE = 6;
  let fForSale = Array(FSALE_AGE).fill(0);

  // Male kids held until sale age
  const MSALE_AGE = Math.max(1, p.maleSaleAge);
  let mKids = Array(MSALE_AGE).fill(0);

  // Pregnancy pipeline: births happen after GEST months
  let preg = Array(MAX + GEST + 5).fill(0);

  // Rest pipeline: after birth, the doe rests p.restMonths before becoming eligible again.
  // We'll approximate by reducing eligible pool via a “resting bucket”.
  const REST = Math.max(0, p.restMonths);
  let resting = Array(Math.max(REST,1)).fill(0);

  // Money tracking (cumulative cash net)
  let cumCash = 0;
  let worstCum = 0;
  let worstMonth = 0;

  // month 0 startup purchases (Action: must be included)
  const startSpend =
    p.startYoungDoes*p.buyYoungF + p.startYoungBucks*p.buyYoungM +
    p.startAdultDoes*p.buyAdultF + p.startAdultBucks*p.buyAdultM;
  cumCash -= startSpend;
  worstCum = Math.min(worstCum, cumCash);

  // Break-even definitions
  // - Full payback: first month cumCash >= 0
  let fullPayback = null;
  // - Cash-flow sustaining: first month from which cumCash never goes below 0 again
  let cashFlowSustain = null;

  // Series
  const rows = [];

  // helper: total bucks available (eligible)
  const sum = (arr)=>arr.reduce((a,b)=>a+b,0);

  for(let m=0; m<=MAX; m++){
    // 1) bring in scheduled purchases
    if(m>0){
      // young purchases
      const yp = youngPurchaseAtMonth(m);
      if(yp.f || yp.m){
        youngDoes[0] += yp.f;
        youngBucks[0] += yp.m;
        cumCash -= (yp.f*p.buyYoungF + yp.m*p.buyYoungM);
      }
      // adult purchases at month 6/12
      const ap = adultPurchaseAtMonth(m);
      if(ap.f || ap.m){
        adultDoes[0] += ap.f;
        adultBucks[0] += ap.m;
        cumCash -= (ap.f*p.buyAdultF + ap.m*p.buyAdultM);
      }
    }

    // 2) shift cohorts (aging)
    const shift = (arr)=>{
      const out = arr[arr.length-1] || 0;
      for(let i=arr.length-1;i>=1;i--) arr[i]=arr[i-1];
      arr[0]=0;
      return out;
    };

    const newBreedableDoes_fromYoung = shift(youngDoes); // becomes breedable
    const newServiceBucks_fromYoung = shift(youngBucks);

    const newBreedableDoes_fromAdult = shift(adultDoes); // adult becomes try-eligible after 1 month
    const newServiceBucks_fromAdult = shift(adultBucks);

    // retained females become try-eligible after retainedTryAge
    const newBreedableDoes_fromRetained = shift(retainedF);

    // resting returns (if REST=0, treat as immediate)
    let backFromRest = 0;
    if(REST>0){
      backFromRest = shift(resting);
    }

    // 3) compute births this month from pregnancies GEST months ago
    let births = 0;
    if(m - GEST >= 0) births = preg[m-GEST] * p.kidsPerBirth * p.kidSurvival;

    // split births
    const fBorn = births * p.pctFemale;
    const mBorn = births - fBorn;

    // sales freeze
    const salesFrozen = (p.freezeSalesOn==="on") && (m < p.freezeMonths);

    // females: retain vs sell for breeding
    const fRet = fBorn * p.retainF;
    const fSell = fBorn - fRet;

    if(retainedF.length>0) retainedF[0] += fRet;
    if(fForSale.length>0) fForSale[0] += fSell;
    if(mKids.length>0) mKids[0] += mBorn;

    // 4) sell cohorts (if not frozen)
    let soldM = 0, soldF = 0;
    if(!salesFrozen){
      soldM = mKids[mKids.length-1] || 0;
      soldF = fForSale[fForSale.length-1] || 0;
    }
    // shift selling cohorts regardless (they age even if you freeze; we treat freeze as “you keep them”)
    // If frozen, we keep them instead of selling: move them into retained/breed pools as appropriate.
    // To keep minimal + not complicated: frozen means "no sales", so we just don't remove them and keep them in last bucket.
    // Implementation: only shift + clear last bucket when not frozen.
    if(!salesFrozen){
      shift(mKids);
      shift(fForSale);
    }

    // revenue
    const rev = soldM*p.sellM + soldF*p.sellF;
    cumCash += rev;

    // 5) determine current herd components (on-farm)
    // breedable pools
    // We'll keep running totals of breedable does/bucks:
    // Instead of tracking as a single scalar + cohorts, we approximate by summing:
    // - all does eligible: those that have matured + returned from rest
    // We'll store breedableDoes and serviceBucks as scalars updated each month.
    // Initialize scalars on first row creation:
    if(m===0){
      // create scalars on rows as 0 initially
    }

    // We'll store these scalars in closure:
    if(m===0){
      simulateDet.breedableDoes = 0;
      simulateDet.serviceBucks = 0;
      simulateDet.restingDoes = 0;
    }

    simulateDet.breedableDoes += newBreedableDoes_fromYoung + newBreedableDoes_fromAdult + newBreedableDoes_fromRetained + backFromRest;
    simulateDet.serviceBucks += newServiceBucks_fromYoung + newServiceBucks_fromAdult;

    // 6) breeding event (everyone together when eligible)
    // Eligible does are limited by buck capacity
    const buckCap = simulateDet.serviceBucks * p.doesPerBuck;
    const eligibleDoes = Math.min(simulateDet.breedableDoes, buckCap);

    // ALSO: does that just gave birth must go into rest.
    // We approximate: number of births / kidsPerBirth gives number of does that delivered.
    const deliveringDoes = (p.kidsPerBirth>0) ? (births / p.kidsPerBirth) : 0;

    // move delivering does into rest (remove from breedable now)
    if(deliveringDoes>0){
      simulateDet.breedableDoes = Math.max(0, simulateDet.breedableDoes - deliveringDoes);
      if(REST>0){
        resting[0] += deliveringDoes;
      } else {
        // no rest means immediately eligible next cycle
        simulateDet.breedableDoes += deliveringDoes;
      }
    }

    // This month conceptions:
    // Adults and eligible does conceive with breedSuccess.
    // NOTE: we use “together” conceptions each month from eligible pool (simple, stable).
    const conceived = eligibleDoes * p.breedSuccess;

    preg[m] = conceived;

    // 7) costs
    // herd inventory includes everyone on-farm (breedable does + young pipelines + retained + fForSale + mKids + resting + bucks)
    const youngTotal = sum(youngDoes)+sum(youngBucks);
    const adultQueueTotal = sum(adultDoes)+sum(adultBucks);
    const retainedTotal = sum(retainedF);
    const fForSaleTotal = sum(fForSale);
    const mKidsTotal = sum(mKids);
    const restingTotal = REST>0 ? sum(resting) : 0;

    const doesBreedable = simulateDet.breedableDoes;
    const bucksActive = simulateDet.serviceBucks;

    const herdTotal =
      doesBreedable + bucksActive +
      youngTotal + adultQueueTotal +
      retainedTotal + fForSaleTotal + mKidsTotal +
      restingTotal;

    const varCost = herdTotal * (p.feed + p.med + p.othVar);
    const fixedCost = (p.propYr/12) + p.laborMo + p.vetMo + p.secMo + p.trMo + p.adMo;
    const totalCostThisMonth = varCost + fixedCost;

    cumCash -= totalCostThisMonth;

    if(cumCash < worstCum){
      worstCum = cumCash;
      worstMonth = m;
    }

    // check payback
    if(fullPayback===null && cumCash>=0) fullPayback = m;

    rows.push({
      m,
      does: doesBreedable,
      bucks: bucksActive,
      young: youngTotal,
      retainedF: retainedTotal,
      youngMales: mKidsTotal,
      fForSale: fForSaleTotal,
      resting: restingTotal,
      herdTotal,
      buckCap,
      revenue: rev,
      varCost,
      fixedCost,
      purchaseSpend: (m===0? startSpend:0), // month0 already booked into cumCash; keep for chart reference
      totalCost: totalCostThisMonth,
      netAllIn: (rev - totalCostThisMonth), // purchases already netted into cumCash at purchase time
      cumCash
    });

    // stop early if hit target (for charts clarity), but still need to compute sustain/payback to max months.
    // We will NOT break; we compute to max months so KPIs can show Never if needed.
  }

  // cash-flow sustaining:
  // find earliest month where from that month onward cumCash never drops below 0
  // (simple scan from end)
  let minFromEnd = Infinity;
  const okFrom = Array(rows.length).fill(false);
  for(let i=rows.length-1;i>=0;i--){
    minFromEnd = Math.min(minFromEnd, rows[i].cumCash);
    okFrom[i] = (minFromEnd >= 0);
  }
  cashFlowSustain = okFrom.findIndex(v=>v===true);
  if(cashFlowSustain === -1) cashFlowSustain = null;

  // reached month
  let reached = null;
  for(const r of rows){
    if(r.herdTotal >= p.target){ reached = r.m; break; }
  }

  return {rows, reached, worstCum, worstMonth, fullPayback, cashFlowSustain};
}

/* =========================
   Monte Carlo (optional)
   - randomize biological rates only (tight ranges)
========================= */
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function jitter(r, base, pct){ return base*(1 + ((r()-0.5)*2*pct)); }

function monteCarlo(p){
  const runs = (p.mcOn==="on") ? Math.max(50, Math.floor(p.mcRuns)) : 0;
  if(!runs) return {pct:null,p50:null,p90:null,bands:null};

  const reached = [];
  const tf = p.timeframe;

  for(let i=0;i<runs;i++){
    const r = rng(123456 + i*99991);
    const q = {...p};
    // tight perturbations
    q.kidsPerBirth = clamp(jitter(r, p.kidsPerBirth, 0.12), 1, 3.5);
    q.kidSurvival = clamp(jitter(r, p.kidSurvival, 0.10), 0.40, 1.0);
    q.breedSuccess = clamp(jitter(r, p.breedSuccess, 0.08), 0.40, 1.0);

    const res = simulateDet(q);
    if(res.reached!==null) reached.push(res.reached);
  }

  reached.sort((a,b)=>a-b);
  const hitTF = reached.filter(x=>x<=tf).length;
  const pct = Math.round((hitTF / runs) * 100);

  const pctile=(q)=>{
    if(!reached.length) return null;
    const idx = Math.floor(q*(reached.length-1));
    return reached[idx];
  };

  return {pct, p50:pctile(0.50), p90:pctile(0.90)};
}

/* =========================
   Charts (single stable chart instances)
========================= */
let chHerdComp=null, chPurchMix=null, chConstraint=null, chMonthlyNet=null, chCumRevCost=null, chRevCost=null, chWaterfall=null;

function destroyAll(){
  [chHerdComp,chPurchMix,chConstraint,chMonthlyNet,chCumRevCost,chRevCost,chWaterfall].forEach(ch=>ch && ch.destroy());
  chHerdComp=chPurchMix=chConstraint=chMonthlyNet=chCumRevCost=chRevCost=chWaterfall=null;
}

function intTicks(){
  return {
    ticks: {
      callback: (v)=>Math.round(v).toLocaleString()
    }
  };
}

function sliceToHorizon(rows, reached, timeframe, maxMonths){
  // For charts: show until reached month (if reached), else timeframe, but never beyond maxMonths
  let h = maxMonths;
  if(reached!==null) h = Math.min(reached, maxMonths);
  else h = Math.min(timeframe, maxMonths);
  return rows.filter(r=>r.m<=h);
}

/* =========================
   Advisory (simple)
========================= */
function advisory(p, det){
  const reached = det.reached;
  const tf = p.timeframe;

  if(reached===null){
    return `You did not reach ${p.target} by Month ${p.maxMonths}. Likely constraints: (1) buck capacity, (2) too much sales early, (3) not enough front-loaded purchases. Try: add 1–2 bucks early, increase Month 4/8 does, or freeze sales for 6–12 months.`;
  }

  const msgs = [];
  if(reached > tf) msgs.push(`You reach target at ${moFmt(reached)} which is after your timeframe (${tf} months). Consider adding more does in Month 4/8 (front-load).`);
  else msgs.push(`You reach target by ${moFmt(reached)} within your timeframe.`);

  // buck tightness at target month
  const at = det.rows.find(r=>r.m===reached) || det.rows[det.rows.length-1];
  const util = at.buckCap>0 ? (at.does/at.buckCap) : 999;
  if(util>1) msgs.push(`Buck capacity is limiting at target. Add bucks earlier (Month 4/8) or raise does-per-buck only if realistic.`);
  else if(util>0.85) msgs.push(`Buck capacity is tight near target. Consider +1 buck.`);
  else msgs.push(`Buck capacity looks healthy.`);

  // net end position
  const end = det.rows[det.rows.length-1];
  if(end.cumCash<0) msgs.push(`Net cash is still negative at Month ${p.maxMonths}. Improve by freezing sales less (if on), raising sale prices, reducing fixed costs, or reducing late purchases.`);
  else msgs.push(`Net cash becomes positive within the cap — good sign for sustainability.`);

  return msgs.join(" ");
}

/* =========================
   Render
========================= */
function render(){
  totalBoughtKPIs();

  const p = getParams();
  const det = simulateDet(p);
  const mc = monteCarlo(p);

  // update KPIs (Growth)
  $("g_reach").textContent = det.reached===null ? "No" : "Yes";
  $("g_time").textContent = det.reached===null ? "Never (within cap)" : moFmt(det.reached);

  const rows = det.rows;
  const horizonRows = sliceToHorizon(rows, det.reached, p.timeframe, p.maxMonths);
  const labels = horizonRows.map(r=>r.m);

  // herd at target info
  let at = null;
  if(det.reached!==null) at = rows.find(r=>r.m===det.reached);
  if(!at) at = horizonRows[horizonRows.length-1];

  $("g_totalAt").textContent = String(roundInt(at.herdTotal));
  $("g_dbAt").textContent = `${roundInt(at.does)} / ${roundInt(at.bucks)}`;

  // Money KPIs
  const cashNeeded = Math.max(0, -det.worstCum);
  $("m_startCash").textContent = money(cashNeeded);
  $("m_sustain").textContent = det.cashFlowSustain===null ? "Never" : `Month ${det.cashFlowSustain}`;
  $("m_payback").textContent = det.fullPayback===null ? "Never" : `Month ${det.fullPayback}`;

  // Inventory valuation (Option A): value herd on-farm using input prices:
  // - classify “young inventory” vs “adult inventory” approximately:
  //   treat breedable does/bucks as adult value, and the pipelines (young/retained/for-sale/mkids/resting) as young value.
  const invAdult = at.does * p.buyAdultF + at.bucks * p.buyAdultM;
  const invYoungCount = (at.young + at.retainedF + at.youngMales + at.fForSale + at.resting);
  // split young value by assumed sex: use buyYoungF for half, buyYoungM for half (simple & stable)
  const invYoung = (invYoungCount/2)*p.buyYoungF + (invYoungCount/2)*p.buyYoungM;
  $("m_inv").textContent = money(invAdult + invYoung);

  // Snapshot KPIs
  $("s_det").textContent = det.reached===null ? "Never" : moFmt(det.reached);
  if(p.mcOn==="on"){
    $("s_p").textContent = `${mc.p50===null?"—":moFmt(mc.p50)} / ${mc.p90===null?"—":moFmt(mc.p90)}`;
    $("s_conf").textContent = mc.pct===null ? "—" : `${mc.pct}%`;
  } else {
    $("s_p").textContent = "MC Off";
    $("s_conf").textContent = "MC Off";
  }

  // Net revenue at target month (or horizon end)
  const targetMonth = (det.reached!==null) ? det.reached : horizonRows[horizonRows.length-1].m;
  const at2 = rows.find(r=>r.m===targetMonth) || rows[rows.length-1];
  $("s_netAt").textContent = money(at2.cumCash);

  // herd composition box
  $("s_herdAt").innerHTML =
    `<b>Herd at month ${targetMonth}:</b> Total <b>${roundInt(at2.herdTotal)}</b> — ` +
    `Does <b>${roundInt(at2.does)}</b>, Bucks <b>${roundInt(at2.bucks)}</b>, Young <b>${roundInt(at2.young)}</b>, ` +
    `Retained F <b>${roundInt(at2.retainedF)}</b>, Young M <b>${roundInt(at2.youngMales)}</b>.`;

  // money at target box
  // compute totals to targetMonth
  let totalRev=0, totalOp=0, totalPurch=0;
  for(const r of rows){
    if(r.m>targetMonth) break;
    totalRev += r.revenue;
    totalOp += (r.varCost + r.fixedCost);
    // purchases are booked directly into cumCash; for the summary, show startup purchases as purchase spend:
    if(r.m===0) totalPurch += (p.startYoungDoes*p.buyYoungF + p.startYoungBucks*p.buyYoungM + p.startAdultDoes*p.buyAdultF + p.startAdultBucks*p.buyAdultM);
    // plus any scheduled purchases: we estimate from cumCash deltas is messy; instead compute from inputs directly:
    // keep it simple: show startup purchases only as purchaseSpend summary; the monthly spikes are visible on net chart.
  }
  $("s_moneyAt").innerHTML =
    `<b>Money at month ${targetMonth}:</b> Total revenue <b>${money(totalRev)}</b>, Total operating costs <b>${money(totalOp)}</b>, ` +
    `Startup purchases <b>${money(totalPurch)}</b> → Net position <b>${money(at2.cumCash)}</b>.`;

  // Advisory
  $("advBox").textContent = advisory(p, det);

  // Copy prompt button
  $("copyBtn").onclick = async ()=>{
    const summary = {
      target:p.target, timeframe:p.timeframe, maxMonths:p.maxMonths,
      reached: det.reached,
      cashNeeded: cashNeeded,
      cashFlowSustain: det.cashFlowSustain,
      fullPayback: det.fullPayback,
      herdAtTarget: {
        month: targetMonth,
        total: roundInt(at2.herdTotal),
        does: roundInt(at2.does),
        bucks: roundInt(at2.bucks)
      },
      moneyAtTarget: {
        cumCash: Math.round(at2.cumCash),
        totalRevenue: Math.round(totalRev),
        totalOpCosts: Math.round(totalOp)
      },
      mc: (p.mcOn==="on") ? mc : {status:"off"}
    };
    const prompt =
`Analyze my goat farm scenario and suggest improvements:
- Target herd: ${p.target}
- Timeframe: ${p.timeframe} months
- Max months cap: ${p.maxMonths}
- Deterministic time-to-target: ${det.reached===null?"Never":det.reached+" months"}
- Cash needed to start (buffer): ${cashNeeded}
- Cash-flow sustaining month: ${det.cashFlowSustain===null?"Never":det.cashFlowSustain}
- Full payback month: ${det.fullPayback===null?"Never":det.fullPayback}
- Herd at target month ${targetMonth}: total=${roundInt(at2.herdTotal)}, does=${roundInt(at2.does)}, bucks=${roundInt(at2.bucks)}
- Net position at target: ${Math.round(at2.cumCash)}
- Total revenue to target: ${Math.round(totalRev)}
- Total operating costs to target: ${Math.round(totalOp)}
- Monte Carlo: ${p.mcOn==="on" ? `ON (confidence ${mc.pct}%, P50 ${mc.p50}, P90 ${mc.p90})` : "OFF"}

Give me:
1) Purchase suggestions for months 4/8/12/16/20/24/28 to hit target faster,
2) Buck/does mix changes if capacity is limiting,
3) Money adjustments to end net position positive,
4) A short action plan.`;

    try{
      await navigator.clipboard.writeText(prompt);
      // small feedback by temporarily changing button text
      const old = $("copyBtn").textContent;
      $("copyBtn").textContent = "Copied ✓";
      setTimeout(()=>$("copyBtn").textContent=old, 1200);
    }catch(e){
      alert("Copy failed. Your browser may block clipboard. You can manually copy from console if needed.");
      console.log(prompt);
    }
  };

  // ---- Charts ----
  destroyAll();

  // Purchases mix series
  const boughtYoung = horizonRows.map(r=>{
    const yp = youngPurchaseAtMonth(r.m);
    return roundInt(yp.f + yp.m + ((r.m===0)? (p.startYoungDoes+p.startYoungBucks):0));
  });
  const boughtAdult = horizonRows.map(r=>{
    const ap = adultPurchaseAtMonth(r.m);
    return roundInt(ap.f + ap.m + ((r.m===0)? (p.startAdultDoes+p.startAdultBucks):0));
  });

  // Herd composition series
  const doesS = horizonRows.map(r=>roundInt(r.does));
  const bucksS = horizonRows.map(r=>roundInt(r.bucks));
  const youngS = horizonRows.map(r=>roundInt(r.young + r.retainedF + r.fForSale + r.youngMales + r.resting));
  const totalS = horizonRows.map(r=>roundInt(r.herdTotal));

  // Herd composition chart
  chHerdComp = new Chart($("chartHerdComp").getContext("2d"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Total herd", data: totalS, borderWidth:3, pointRadius:0, tension:.25},
        {label:"Breedable does", data: doesS, borderWidth:2, pointRadius:0, tension:.25},
        {label:"Bucks", data: bucksS, borderWidth:2, pointRadius:0, tension:.25},
        {label:"Other on-farm (young + cohorts)", data: youngS, borderWidth:2, pointRadius:0, tension:.25}
      ]
    },
    options:{
      responsive:true,interaction:{mode:"index",intersect:false},
      scales:{x:intTicks(), y:intTicks()}
    }
  });

  // Purchases chart
  chPurchMix = new Chart($("chartPurchMix").getContext("2d"),{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"Young bought (this month)", data: boughtYoung},
        {label:"Adult bought (this month)", data: boughtAdult}
      ]
    },
    options:{
      responsive:true,interaction:{mode:"index",intersect:false},
      scales:{x:intTicks(), y:intTicks()}
    }
  });

  // Constraint chart with 2nd axis for bucks
  const buckCapS = horizonRows.map(r=>roundInt(r.buckCap));
  chConstraint = new Chart($("chartConstraint").getContext("2d"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Breedable does", data: doesS, borderWidth:3, pointRadius:0, tension:.25, yAxisID:"y"},
        {label:"Buck capacity (bucks×ratio)", data: buckCapS, borderWidth:2, pointRadius:0, tension:.25, borderDash:[6,4], yAxisID:"y"},
        {label:"Bucks (count)", data: bucksS, borderWidth:2, pointRadius:0, tension:.25, yAxisID:"y2"}
      ]
    },
    options:{
      responsive:true,interaction:{mode:"index",intersect:false},
      scales:{
        x:intTicks(),
        y:{...intTicks(), position:"left"},
        y2:{...intTicks(), position:"right", grid:{drawOnChartArea:false}}
      }
    }
  });

  // Money series
  const monthlyRev = horizonRows.map(r=>Math.round(r.revenue));
  const monthlyTotCost = horizonRows.map(r=>Math.round(r.totalCost)); // operating only (purchases already booked into cumCash at purchase time)
  // To show purchases as spikes on revenue-vs-cost chart, we reconstruct from inputs:
  const monthlyPurch = horizonRows.map(r=>{
    if(r.m===0){
      return Math.round(
        p.startYoungDoes*p.buyYoungF + p.startYoungBucks*p.buyYoungM +
        p.startAdultDoes*p.buyAdultF + p.startAdultBucks*p.buyAdultM
      );
    }
    const yp=youngPurchaseAtMonth(r.m);
    const ap=adultPurchaseAtMonth(r.m);
    return Math.round(yp.f*p.buyYoungF + yp.m*p.buyYoungM + ap.f*p.buyAdultF + ap.m*p.buyAdultM);
  });

  // Monthly net all-in: revenue - (operating costs + purchases)
  const monthlyNetAll = horizonRows.map((r,i)=>Math.round(monthlyRev[i] - monthlyTotCost[i] - monthlyPurch[i]));

  // cumulative revenue vs cumulative total costs (operating+ purchases)
  let cumR=0, cumC=0;
  const cumRev = monthlyRev.map(v=>{cumR+=v; return Math.round(cumR);});
  const cumCost = monthlyTotCost.map((v,i)=>{cumC += (v + monthlyPurch[i]); return Math.round(cumC);});

  // Monthly Net chart with segment coloring
  chMonthlyNet = new Chart($("chartMonthlyNet").getContext("2d"),{
    type:"line",
    data:{labels, datasets:[{
      label:"Monthly net (all-in)",
      data: monthlyNetAll,
      borderWidth:3,
      pointRadius:0,
      tension:.25,
      segment:{
        borderColor: ctx => (ctx.p0.parsed.y>=0 && ctx.p1.parsed.y>=0) ? "rgba(22,163,74,.95)" : "rgba(220,38,38,.95)"
      }
    }]},
    options:{responsive:true,interaction:{mode:"index",intersect:false}, scales:{x:intTicks(), y:intTicks()}}
  });

  // Cumulative revenue vs cumulative costs
  chCumRevCost = new Chart($("chartCumRevCost").getContext("2d"),{
    type:"line",
    data:{labels, datasets:[
      {label:"Cumulative revenue", data:cumRev, borderWidth:3, pointRadius:0, tension:.25},
      {label:"Cumulative total costs (operating+purchases)", data:cumCost, borderWidth:3, pointRadius:0, tension:.25}
    ]},
    options:{responsive:true,interaction:{mode:"index",intersect:false}, scales:{x:intTicks(), y:intTicks()}}
  });

  // Monthly revenue vs costs chart (with purchase spikes)
  chRevCost = new Chart($("chartRevenueVsCost").getContext("2d"),{
    type:"line",
    data:{labels, datasets:[
      {label:"Revenue", data:monthlyRev, borderWidth:3, pointRadius:0, tension:.25},
      {label:"Operating costs", data:monthlyTotCost, borderWidth:2, pointRadius:0, tension:.25},
      {label:"Purchases (spikes)", data:monthlyPurch, borderWidth:2, pointRadius:0, tension:.25, borderDash:[6,4]}
    ]},
    options:{responsive:true,interaction:{mode:"index",intersect:false}, scales:{x:intTicks(), y:intTicks()}}
  });

  // Waterfall-like stacked bars (simple)
  // At target month: totals (rev, op costs, purchases) and net
  const revTot = Math.round(totalRev);
  const opTot = Math.round(totalOp);
  const purchTot = Math.round(totalPurch);
  const netPos = Math.round(at2.cumCash);

  chWaterfall = new Chart($("chartWaterfall").getContext("2d"),{
    type:"bar",
    data:{
      labels:["Totals to target"],
      datasets:[
        {label:"Total Revenue", data:[revTot]},
        {label:"Total Operating Costs", data:[opTot]},
        {label:"Startup Purchase Spend", data:[purchTot]},
        {label:"Net Position", data:[netPos]}
      ]
    },
    options:{responsive:true,interaction:{mode:"index",intersect:false}, scales:{x:intTicks(), y:intTicks()}}
  });
}

/* =========================
   Save/Load (file to computer)
========================= */
function getAllInputs(){
  const ids = [
    "target","timeframe","maxMonths","fontSize","mcOn","mcRuns","bandsOn",
    "startYoungDoes","startYoungBucks","startAdultDoes","startAdultBucks",
    "p4f","p4m","p8f","p8m","p12f","p12m","p16f","p16m","p20f","p20m","p24f","p24m","p28f","p28m",
    "a6f","a6m","a12f","a12m",
    "doesPerBuck","breedSuccess","kidsPerBirth","pctFemale","kidSurvival","restMonths","retainedTryAge",
    "freezeSalesOn","freezeMonths",
    "cur","buyYoungF","buyYoungM","buyAdultF","buyAdultM","sellM","sellF","maleSaleAge","retainF",
    "feed","med","othVar","propYr","laborMo","vetMo","secMo","trMo","adMo",
    "scName"
  ];
  const obj = {};
  ids.forEach(id=>{
    const el = $(id);
    if(!el) return;
    obj[id] = (el.type==="number" || el.type==="range") ? N(id) : el.value;
  });
  return obj;
}
function applyInputs(obj){
  Object.entries(obj).forEach(([id,val])=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="number" || el.type==="range") el.value = val;
    else el.value = val;
  });
  // apply font immediately
  document.documentElement.style.setProperty("--fs", $("fontSize").value+"px");
}

function openModal(){
  $("modalBack").style.display="flex";
}
function closeModal(){
  $("modalBack").style.display="none";
}
$("closeModal").onclick = closeModal;
$("modalBack").addEventListener("click",(e)=>{
  if(e.target.id==="modalBack") closeModal();
});

$("saveBtn").onclick = ()=>{
  const name = ($("scName").value||"scenario").trim().replaceAll(" ","_");
  const data = getAllInputs();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  openModal();
};

$("loadBtn").onclick = ()=>{
  const f = $("loadFile").files?.[0];
  if(!f){ alert("Choose a .json scenario file first."); return; }
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      applyInputs(obj);
      render();
    }catch(e){
      alert("Could not load file. Make sure it's a valid scenario JSON.");
    }
  };
  reader.readAsText(f);
};

/* =========================
   Run button spinner (1.5s) + render
========================= */
$("runBtn").onclick = ()=>{
  const sp = $("spin");
  sp.style.display="block";
  // keep stable 1.5s
  setTimeout(()=>{
    try{ render(); }
    catch(e){
      console.error(e);
      alert("A script error stopped charts. Open Console (F12) and share the first red error line.");
    }
    sp.style.display="none";
  }, 1500);
};

/* =========================
   Initial render
========================= */
try{
  totalBoughtKPIs();
  render();
}catch(e){
  console.error(e);
}
</script>
</body>
</html>
