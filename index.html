<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Goat Farm Dashboard — MK2 (Actions 1–2)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --fs: 16px;
      --bg: #e8eaee;
      --card: #ffffff;
      --ink: #111;
      --muted: #444;
      --line: #d4d7dd;
      --soft: rgba(0,0,0,.06);
      --good: rgba(0,140,0,.10);
      --warn: rgba(200,150,0,.12);
      --bad: rgba(180,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.92rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.25fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.1rem;font-weight:950;margin-top:6px}
    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{border-color:rgba(0,140,0,.35);background:var(--good)}
    .warn{border-color:rgba(200,150,0,.35);background:var(--warn)}
    .bad{border-color:rgba(180,0,0,.35);background:var(--bad)}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .canvasBox{margin-top:10px}
    canvas{
      display:block;
      width:100% !important;
      height:290px !important;
      max-height:290px !important;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px;
    }
    .pillGroup{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .pill{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:8px 12px;font-weight:900;
    }
    .pill input{width:auto;padding:0;margin:0}
    .hint{font-size:.9rem;color:var(--muted);margin-top:6px}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Goat Farm Dashboard — MK2 <span class="small">• Actions 1–2 applied</span></h1>

  <!-- Global Controls -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops when herd on-farm reaches this size.">Target herd size</label>
          <input id="target" type="number" value="200" min="10" />
        </div>
        <div class="row">
          <label title="Used as a comparison milestone.">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6" />
        </div>
        <div class="row">
          <label title="Hard cap for simulation length.">Max months (safety cap)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12" />
        </div>
      </div>
      <div>
        <div class="row">
          <label title="Adjust readability.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16" />
        </div>
        <div class="row">
          <label title="Click to compute and refresh all tabs.">Run model</label>
          <button id="runBtn">Run</button>
        </div>
        <div class="banner small" id="runNote">
          Charts remain static until you click <b>Run</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabSales">Sales Cycle</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
    <button class="tabBtn" data-tab="tabAdv">Advisory</button>
    <button class="tabBtn" data-tab="tabSave">Save / Load</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (goats bought at the start)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Young starting goats are treated as ~3 months old and need time before breeding eligibility.">Start: Young does (3 months old)</label>
            <input id="startYoungDoes" type="number" value="4" min="0" />
          </div>
          <div class="row">
            <label title="Young starting bucks are treated as ~3 months old and need time before breeding service.">Start: Young bucks (3 months old)</label>
            <input id="startYoungBucks" type="number" value="1" min="0" />
          </div>
        </div>
        <div>
          <div class="row">
            <label title="Adult starting does become eligible after a short buffer.">Start: Adult ready does</label>
            <input id="startAdultDoes" type="number" value="0" min="0" />
          </div>
          <div class="row">
            <label title="Adult starting bucks become eligible after a short buffer.">Start: Adult ready bucks</label>
            <input id="startAdultBucks" type="number" value="0" min="0" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Expansion purchases (months 4, 8, 12, 16, 20, 24, 28)</b>
      <div class="small">Purchased goats are assumed “young” and take time before they become active.</div>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p4d" type="number" value="0" min="0" />
              <input id="p4b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 8: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p8d" type="number" value="0" min="0" />
              <input id="p8b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 12: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p12d" type="number" value="0" min="0" />
              <input id="p12b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 16: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p16d" type="number" value="0" min="0" />
              <input id="p16b" type="number" value="0" min="0" />
            </div>
          </div>
        </div>
        <div>
          <div class="row"><label>Month 20: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p20d" type="number" value="0" min="0" />
              <input id="p20b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 24: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p24d" type="number" value="0" min="0" />
              <input id="p24b" type="number" value="0" min="0" />
            </div>
          </div>
          <div class="row"><label>Month 28: buy does / buy bucks</label>
            <div style="display:flex;gap:10px">
              <input id="p28d" type="number" value="0" min="0" />
              <input id="p28b" type="number" value="0" min="0" />
            </div>
          </div>

          <div class="banner small" style="margin-top:10px">
            Purchases KPI will show <b>total bought</b> over time (does + bucks).
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total bought (does+bucks)</small><div class="v" id="k_buy_total">—</div></div>
        <div class="kpi"><small>Total bought does</small><div class="v" id="k_buy_does">—</div></div>
        <div class="kpi"><small>Total bought bucks</small><div class="v" id="k_buy_bucks">—</div></div>
        <div class="kpi"><small>First purchase month</small><div class="v" id="k_buy_first">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartPurchTotal"></canvas>
        <div class="small">
          Action 1: Purchases chart now also shows <b>total herd on-farm</b> (births + purchases − sales).
        </div>
      </div>
    </div>
  </div>

  <!-- Goat Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Breeding settings</b>

      <div class="pillGroup" aria-label="Growth presets">
        <label class="pill" title="Faster herd build; tighter cycles; higher retention.">
          <input type="radio" name="growthMode" id="modeAgg" />
          Aggressive growth
        </label>
        <label class="pill" title="More conservative, planning-safe assumptions.">
          <input type="radio" name="growthMode" id="modeCon" checked />
          Conservative growth
        </label>
        <span class="pill">Retained doe first-try age: <b>8 months</b></span>
        <span class="pill">Gestation: <b>5 months</b></span>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>Kidding interval (months)</label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18" />
          </div>
          <div class="row">
            <label>Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label>Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1" />
          </div>
          <div class="row">
            <label title="After a doe gives birth, she must wait this many months before she can conceive again.">Re-breed delay (months)</label>
            <input id="rebreedDelay" type="number" value="3" min="0" max="12" />
          </div>
        </div>

        <div>
          <div class="row">
            <label>Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60" />
          </div>
          <div class="row">
            <label>Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label>Does per buck</label>
            <input id="doesPerBuck" type="number" value="20" min="5" max="50" />
          </div>
          <div class="row">
            <label>Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100" />
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Sales assumptions (used for Sales Cycle + Money)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12" />
          </div>
          <div class="banner small">
            Rule: Male kids are always sold (unless sales are frozen). Female kids are either retained for breeding or sold for breeding at 6 months.
          </div>
        </div>
        <div>
          <div class="banner small">
            Fixed biology:<br/>
            • Retained females can first attempt pregnancy at <b>8 months</b>.<br/>
            • Gestation fixed at <b>5 months</b>.<br/>
            • Re-breed delay controls how long after kidding a doe can conceive again.
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target</small><div class="v" id="g_time">—</div></div>
        <div class="kpi"><small>Reached target?</small><div class="v" id="g_reach">—</div></div>
        <div class="kpi"><small>Buck capacity status</small><div class="v" id="g_buck">—</div></div>
        <div class="kpi"><small>Herd at target (total)</small><div class="v" id="g_herd_target_total">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartHerd"></canvas>
        <div class="small">Herd composition over time (whole numbers).</div>
      </div>
      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">Constraint: breedable does vs buck capacity, with bucks count shown on 2nd axis.</div>
      </div>
    </div>
  </div>

  <!-- Sales Cycle -->
  <div id="tabSales" class="tab">
    <div class="card">
      <b class="small">Sales Cycle</b>
      <div class="small">Shows <b>when goats are sold</b> and how many leave the farm each month.</div>

      <!-- Action 2: freeze sales until herd threshold -->
      <div class="grid" style="margin-top:12px">
        <div>
          <div class="row">
            <label title="Optional. If set > 0, no sales happen until herd on-farm reaches this size.">Freeze sales until herd reaches (goats)</label>
            <input id="freezeUntilHerd" type="number" value="0" min="0" />
          </div>
          <div class="hint">Example: set to <b>100</b> to grow first, then allow sales once the herd reaches 100.</div>
        </div>
        <div>
          <div class="row">
            <label title="Optional. Freeze sales for the first N months regardless of herd size.">Freeze sales for first (months)</label>
            <input id="freezeSalesMonths" type="number" value="0" min="0" />
          </div>
          <div class="hint">Both freezes can work together (both must be satisfied to allow sales).</div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total goats sold (lifetime)</small><div class="v" id="s_totalSold">—</div></div>
        <div class="kpi"><small>Male goats sold</small><div class="v" id="s_maleSold">—</div></div>
        <div class="kpi"><small>Female goats sold</small><div class="v" id="s_femaleSold">—</div></div>
        <div class="kpi"><small>First sale month</small><div class="v" id="s_firstSale">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartSales"></canvas>
        <div class="small">Monthly goats sold (whole numbers): male kids vs female goats sold for breeding.</div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Currency label</label><input id="cur" value="UGX" /></div>

          <div class="row">
            <label>Buy price: young doe / young buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyYoungDoe" type="number" value="400000" min="0" />
              <input id="buyYoungBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label>Buy price: adult doe / adult buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyAdultDoe" type="number" value="400000" min="0" />
              <input id="buyAdultBuck" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="row">
            <label>Sale price: male / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellMale" type="number" value="250000" min="0" />
              <input id="sellFemale" type="number" value="400000" min="0" />
            </div>
          </div>

          <div class="banner small">Sales are recorded in Sales Cycle and reflected here as revenue.</div>
        </div>

        <div>
          <div class="row"><label>Feed per goat / month</label><input id="feed" type="number" value="2500" min="0" /></div>
          <div class="row"><label>Medication per goat / month</label><input id="med" type="number" value="0" min="0" /></div>
          <div class="row"><label>Other variable per goat / month</label><input id="othVar" type="number" value="0" min="0" /></div>

          <div class="row"><label>Property / year</label><input id="propYr" type="number" value="1500000" min="0" /></div>
          <div class="row"><label>Labor / month</label><input id="laborMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Vet / month</label><input id="vetMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Security / month</label><input id="secMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Transport / month</label><input id="trMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Admin / month</label><input id="adMo" type="number" value="0" min="0" /></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Operating break-even (month)</small><div class="v" id="m_opBE">—</div></div>
        <div class="kpi"><small>Farm break-even (month)</small><div class="v" id="m_fullBE">—</div></div>
        <div class="kpi"><small>Total revenue (to horizon)</small><div class="v" id="m_revTot">—</div></div>
        <div class="kpi"><small>Total costs (to horizon)</small><div class="v" id="m_costTot">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCumRevCost"></canvas>
        <div class="small">Cumulative revenue vs cumulative costs (operating + purchases + startup).</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyNet"></canvas>
        <div class="small">Monthly net (all-in). Includes month 0 startup purchases via starting balance.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthlyRevCost"></canvas>
        <div class="small">Monthly revenue vs monthly operating costs.</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Snapshot</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target</small><div class="v" id="x_time">—</div></div>
        <div class="kpi"><small>Target confidence by Month X</small><div class="v" id="x_conf">—</div></div>
        <div class="kpi"><small>Net position at horizon</small><div class="v" id="x_netTarget">—</div></div>
        <div class="kpi"><small>Herd composition at horizon</small><div class="v" id="x_compTarget">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWaterfall"></canvas>
        <div class="small">Horizon summary: Total Revenue vs Total Costs → Net position.</div>
      </div>
    </div>
  </div>

  <!-- Advisory -->
  <div id="tabAdv" class="tab">
    <div class="card">
      <b class="small">Advisory (simple)</b>
      <div class="banner small" id="advBox">
        Run the model to get advice.
      </div>
    </div>
  </div>

  <!-- Save / Load -->
  <div id="tabSave" class="tab">
    <div class="card">
      <b class="small">Save / Load scenario</b>
      <div class="small">This saves your inputs as a JSON file on your computer and lets you reload them later.</div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Scenario name</label><input id="scName" value="MK2-scenario" /></div>
          <button id="btnSave">Save scenario (download JSON)</button>
          <div class="hint">Tip: Keep your MK1 baseline file separately.</div>
        </div>
        <div>
          <div class="row"><label>Load scenario JSON</label><input id="fileLoad" type="file" accept=".json" /></div>
          <button id="btnApplyLoad">Apply loaded scenario</button>
          <div class="hint">After loading, click <b>Run</b> to refresh charts.</div>
        </div>
      </div>

      <div class="banner small" id="saveMsg" style="display:none;margin-top:10px"></div>
      <div class="banner small" id="loadMsg" style="display:none;margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/* helpers */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id).value||0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtInt=(n)=>Math.round(n).toLocaleString();
const money=(n)=>{
  const cur = ($("cur")?.value || "UGX").trim();
  return `${cur} ${Math.round(n).toLocaleString()}`;
};
function moFmt(mo){
  if(mo===null || mo===undefined) return "Never";
  const y=Math.floor(mo/12), m=mo%12;
  return y?`${y}y ${m}m`:`${m} months`;
}

/* tabs */
(function initTabs(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $(b.dataset.tab).classList.add("active");
    });
  });
})();

/* presets */
const PRESET = {
  aggressive: { kiddingInt: 9, breedSuccess: 93, kidsPerBirth: 1.9, rebreedDelay: 2, retainF: 95 },
  conservative:{ kiddingInt:12, breedSuccess: 90, kidsPerBirth: 1.8, rebreedDelay: 3, retainF: 85 }
};
function applyPreset(name){
  const p = PRESET[name];
  $("kiddingInt").value = p.kiddingInt;
  $("breedSuccess").value = p.breedSuccess;
  $("kidsPerBirth").value = p.kidsPerBirth;
  $("rebreedDelay").value = p.rebreedDelay;
  $("retainF").value = p.retainF;
}
$("modeAgg").addEventListener("change", ()=>{ if($("modeAgg").checked) applyPreset("aggressive"); });
$("modeCon").addEventListener("change", ()=>{ if($("modeCon").checked) applyPreset("conservative"); });

/* fixed biology */
const FIX_GEST = 5;
const FIX_FIRST_TRY = 8;
const FIX_FEMALE_SALE_AGE = 6;

/* purchases schedule */
function purchAtMonth(m){
  let d=0,b=0;
  if(m===4){ d=N("p4d"); b=N("p4b"); }
  else if(m===8){ d=N("p8d"); b=N("p8b"); }
  else if(m===12){ d=N("p12d"); b=N("p12b"); }
  else if(m===16){ d=N("p16d"); b=N("p16b"); }
  else if(m===20){ d=N("p20d"); b=N("p20b"); }
  else if(m===24){ d=N("p24d"); b=N("p24b"); }
  else if(m===28){ d=N("p28d"); b=N("p28b"); }
  return {d,b};
}

function getParams(){
  const target = clamp(N("target"), 10, 100000);
  const timeframe = clamp(N("timeframe"), 6, 240);
  const maxMonths = clamp(N("maxMonths"), 24, 360);

  const kiddingInt = clamp(N("kiddingInt"), 6, 18);
  const rebreedDelay = clamp(N("rebreedDelay"), 0, 12);

  const breedSuccess = clamp(N("breedSuccess"), 40, 100) / 100;
  const kidsPerBirth = clamp(Number($("kidsPerBirth").value||1.8), 1, 3.5);

  const pctFemale = clamp(N("pctFemale"), 40, 60) / 100;
  const kidSurvival = clamp(N("kidSurvival"), 40, 100) / 100;

  const doesPerBuck = clamp(N("doesPerBuck"), 5, 50);
  const retainF = clamp(N("retainF"), 0, 100) / 100;
  const maleSaleAge = clamp(N("maleSaleAge"), 1, 12);

  const startYoungDoes = clamp(N("startYoungDoes"), 0, 999999);
  const startYoungBucks = clamp(N("startYoungBucks"), 0, 999999);
  const startAdultDoes = clamp(N("startAdultDoes"), 0, 999999);
  const startAdultBucks = clamp(N("startAdultBucks"), 0, 999999);

  const buyYoungDoe = N("buyYoungDoe"), buyYoungBuck=N("buyYoungBuck");
  const buyAdultDoe = N("buyAdultDoe"), buyAdultBuck=N("buyAdultBuck");
  const sellMale=N("sellMale"), sellFemale=N("sellFemale");

  const feed=N("feed"), med=N("med"), othVar=N("othVar");
  const fixedMo=(N("propYr")/12)+N("laborMo")+N("vetMo")+N("secMo")+N("trMo")+N("adMo");

  // Action 2 controls
  const freezeSalesMonths = clamp(N("freezeSalesMonths"), 0, 360);
  const freezeUntilHerd = clamp(N("freezeUntilHerd"), 0, 1000000);

  return {
    target, timeframe, maxMonths,
    kiddingInt, rebreedDelay,
    breedSuccess, kidsPerBirth,
    pctFemale, kidSurvival,
    doesPerBuck, retainF, maleSaleAge,
    startYoungDoes, startYoungBucks, startAdultDoes, startAdultBucks,
    buyYoungDoe, buyYoungBuck, buyAdultDoe, buyAdultBuck,
    sellMale, sellFemale,
    feed, med, othVar, fixedMo,
    freezeSalesMonths, freezeUntilHerd
  };
}

function simulate(p){
  const rows=[];

  const fRetCoh = Array(FIX_FIRST_TRY).fill(0);
  const mCoh = Array(p.maleSaleAge).fill(0);
  const fSaleCoh = Array(FIX_FEMALE_SALE_AGE).fill(0);

  const preg = Array(FIX_GEST).fill(0);
  const rest = Array(p.rebreedDelay).fill(0);

  const youngStarterF = Array(5).fill(0);
  const youngStarterM = Array(5).fill(0);
  youngStarterF[0] = p.startYoungDoes;
  youngStarterM[0] = p.startYoungBucks;

  let adultBufferDoes = p.startAdultDoes;
  let adultBufferBucks = p.startAdultBucks;

  let breedingDoes = 0;
  let bucksActive = 0;

  const startupSpend =
    p.startYoungDoes*p.buyYoungDoe +
    p.startYoungBucks*p.buyYoungBuck +
    p.startAdultDoes*p.buyAdultDoe +
    p.startAdultBucks*p.buyAdultBuck;

  let cumRev=0, cumCost=0;
  let cumNet = -startupSpend;
  let opBE = null, fullBE = null;

  let totalMaleSold=0, totalFemaleSold=0;
  let firstSaleMonth = null;

  let cumBoughtDoes = p.startYoungDoes + p.startAdultDoes;
  let cumBoughtBucks = p.startYoungBucks + p.startAdultBucks;

  let reachedMonth = null;
  let targetIndex = null;

  function monthlyOperatingCost(inv){
    return inv * (p.feed + p.med + p.othVar) + p.fixedMo;
  }

  function eligibleDoes(){
    const pregTot = preg.reduce((a,b)=>a+b,0);
    const restTot = rest.reduce((a,b)=>a+b,0);
    return Math.max(0, breedingDoes - pregTot - restTot);
  }

  function herdTotal(){
    const youngF = fRetCoh.reduce((a,b)=>a+b,0);
    const maleKids = mCoh.reduce((a,b)=>a+b,0);
    const femaleForSale = fSaleCoh.reduce((a,b)=>a+b,0);

    const startersF = youngStarterF.reduce((a,b)=>a+b,0);
    const startersM = youngStarterM.reduce((a,b)=>a+b,0);
    const adultsWaiting = adultBufferDoes + adultBufferBucks;

    return (breedingDoes + bucksActive + youngF + maleKids + femaleForSale + startersF + startersM + adultsWaiting);
  }

  for(let m=0; m<=p.maxMonths; m++){
    if(m===1){
      breedingDoes += adultBufferDoes;
      bucksActive += adultBufferBucks;
      adultBufferDoes = 0;
      adultBufferBucks = 0;
    }

    // young starters mature
    const starterFOut = youngStarterF[youngStarterF.length-1] || 0;
    for(let i=youngStarterF.length-1;i>=1;i--) youngStarterF[i]=youngStarterF[i-1];
    youngStarterF[0]=0;
    if(starterFOut>0) breedingDoes += starterFOut;

    const starterMOut = youngStarterM[youngStarterM.length-1] || 0;
    for(let i=youngStarterM.length-1;i>=1;i--) youngStarterM[i]=youngStarterM[i-1];
    youngStarterM[0]=0;
    if(starterMOut>0) bucksActive += starterMOut;

    // purchases
    const pur = purchAtMonth(m);
    if(pur.d || pur.b){
      youngStarterF[0] += pur.d;
      youngStarterM[0] += pur.b;
      cumBoughtDoes += pur.d;
      cumBoughtBucks += pur.b;
    }

    // breeding attempt
    let conceptions = 0;
    if(m>0 && (m % p.kiddingInt === 0)){
      const elig = eligibleDoes();
      const capacity = bucksActive * p.doesPerBuck;
      const attempted = Math.min(elig, capacity);
      conceptions = attempted * p.breedSuccess;
      preg[0] += conceptions;
    }

    // advance pregnancy
    const birthDoes = preg[preg.length-1] || 0;
    for(let i=preg.length-1;i>=1;i--) preg[i]=preg[i-1];
    preg[0]=0;
    preg[0] += conceptions;

    // births
    let birthsKids = 0;
    if(birthDoes>0){
      birthsKids = birthDoes * p.kidsPerBirth * p.kidSurvival;
    }
    const fBorn = birthsKids * p.pctFemale;
    const mBorn = birthsKids - fBorn;

    // rest after kidding
    if(p.rebreedDelay>0 && birthDoes>0){
      rest[0] += birthDoes;
    }
    if(p.rebreedDelay>0){
      const restOut = rest[rest.length-1] || 0;
      for(let i=rest.length-1;i>=1;i--) rest[i]=rest[i-1];
      rest[0]=0;
      // restOut becomes eligible implicitly (we track via eligibleDoes calculation)
      void restOut;
    }

    // allocate kids
    const fRet = fBorn * p.retainF;
    const fSale = fBorn - fRet;

    fRetCoh[0] += fRet;
    mCoh[0] += mBorn;
    fSaleCoh[0] += fSale;

    // retained females age up into breeding
    const toBreeding = fRetCoh[fRetCoh.length-1] || 0;
    for(let i=fRetCoh.length-1;i>=1;i--) fRetCoh[i]=fRetCoh[i-1];
    fRetCoh[0]=0;
    if(toBreeding>0) breedingDoes += toBreeding;

    // Action 2: sales allow logic (must satisfy BOTH, if enabled)
    const invNowForGate = herdTotal();
    const allowByMonths = (m >= p.freezeSalesMonths);
    const allowByHerd = (p.freezeUntilHerd<=0) ? true : (invNowForGate >= p.freezeUntilHerd);
    const salesAllowed = allowByMonths && allowByHerd;

    // sales: age cohorts; if sales not allowed, keep goats at sale-age bucket (do not sell)
    let maleSold = 0;
    if(mCoh.length>0){
      const wouldSell = mCoh[mCoh.length-1] || 0;
      for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
      mCoh[0]=0;

      if(salesAllowed){
        maleSold = wouldSell;
      }else{
        mCoh[mCoh.length-1] += wouldSell; // hold at sale age
      }
    }

    let femaleSold = 0;
    if(fSaleCoh.length>0){
      const wouldSell = fSaleCoh[fSaleCoh.length-1] || 0;
      for(let i=fSaleCoh.length-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
      fSaleCoh[0]=0;

      if(salesAllowed){
        femaleSold = wouldSell;
      }else{
        fSaleCoh[fSaleCoh.length-1] += wouldSell; // hold at sale age
      }
    }

    if((maleSold + femaleSold) > 0 && firstSaleMonth===null) firstSaleMonth = m;
    totalMaleSold += maleSold;
    totalFemaleSold += femaleSold;

    // money
    const inv = herdTotal();
    const opCost = monthlyOperatingCost(inv);
    const purchaseSpend = (pur.d*p.buyYoungDoe) + (pur.b*p.buyYoungBuck);
    const revenue = (maleSold * p.sellMale) + (femaleSold * p.sellFemale);

    cumRev += revenue;
    cumCost += (opCost + purchaseSpend);

    const net = revenue - opCost - purchaseSpend;
    cumNet += net;

    if(opBE===null && revenue >= opCost) opBE = m;
    if(fullBE===null && cumNet >= 0) fullBE = m;

    const pregTot = preg.reduce((a,b)=>a+b,0);
    const restTot = rest.reduce((a,b)=>a+b,0);

    const youngF = fRetCoh.reduce((a,b)=>a+b,0);
    const youngM = mCoh.reduce((a,b)=>a+b,0);
    const fForSale = fSaleCoh.reduce((a,b)=>a+b,0);

    const capacityDoes = bucksActive * p.doesPerBuck;
    const elig = eligibleDoes();

    rows.push({
      m,
      herd: inv,
      breedingDoes,
      bucksActive,
      youngF,
      youngM,
      fForSale,
      eligible: elig,
      capacityDoes,
      pregnant: pregTot,
      resting: restTot,
      maleSold,
      femaleSold,
      revenue,
      opCost,
      purchaseSpend,
      net,
      cumRev,
      cumCost,
      cumNet,
      cumBought: (cumBoughtDoes + cumBoughtBucks),
      cumBoughtDoes,
      cumBoughtBucks
    });

    if(reachedMonth===null && inv >= p.target){
      reachedMonth = m;
      targetIndex = rows.length-1;
      break;
    }
  }

  const horizonIndex = (targetIndex!==null) ? targetIndex : Math.min(rows.length-1, p.maxMonths);
  return {
    rows,
    reachedMonth,
    horizonIndex,
    startupSpend,
    opBE,
    fullBE,
    totals: {
      totalMaleSold,
      totalFemaleSold,
      firstSaleMonth,
      cumRev,
      cumCost,
      cumNet,
      cumBoughtDoes,
      cumBoughtBucks
    }
  };
}

/* charts */
let chPurch=null, chHerd=null, chCons=null, chSales=null, chCum=null, chNet=null, chMo=null, chWF=null;

function makeChart(canvasId, type, labels, datasets, options={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      plugins:{
        legend:{labels:{color:"#111", font:{weight:"800"}}},
        tooltip:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}}
      },
      ...options
    }
  });
}

function buildAdvice(p, sim){
  const rows = sim.rows;
  const last = rows[sim.horizonIndex] || rows[rows.length-1];
  if(!last) return "Run the model to get advice.";

  let limiter = "";
  if(last.capacityDoes===0 && last.bucksActive===0 && last.breedingDoes>0) limiter = "You have does but no active bucks. Add bucks or buy adult buck(s).";
  else if(last.eligible > last.capacityDoes) limiter = "Buck capacity is limiting. Add bucks or reduce does-per-buck.";
  else limiter = "Buck capacity looks OK. Your main levers are cycle length, retention, and costs.";

  const moneyNote = (sim.fullBE===null)
    ? "Farm break-even not reached within the simulated horizon. Improve net position by raising sale prices, reducing costs, or slowing purchases."
    : `Farm break-even is reached around ${moFmt(sim.fullBE)}.`;

  const salesGate = (p.freezeSalesMonths>0 || p.freezeUntilHerd>0)
    ? `Sales gate ON (months ≥ ${p.freezeSalesMonths}, herd ≥ ${p.freezeUntilHerd||"OFF"}).`
    : "Sales gate OFF.";

  return `
    <b>Limiter:</b> ${limiter}<br/><br/>
    <b>Sales rule:</b> ${salesGate}<br/>
    <b>Money:</b> ${moneyNote}
  `;
}

/* save/load */
let loadedScenario=null;

function getAllInputs(){
  const ids=[
    "target","timeframe","maxMonths","fontSize",
    "startYoungDoes","startYoungBucks","startAdultDoes","startAdultBucks",
    "p4d","p4b","p8d","p8b","p12d","p12b","p16d","p16b","p20d","p20b","p24d","p24b","p28d","p28b",
    "kiddingInt","breedSuccess","kidsPerBirth","rebreedDelay","pctFemale","kidSurvival","doesPerBuck","retainF","maleSaleAge",
    "freezeUntilHerd","freezeSalesMonths",
    "cur","buyYoungDoe","buyYoungBuck","buyAdultDoe","buyAdultBuck","sellMale","sellFemale",
    "feed","med","othVar","propYr","laborMo","vetMo","secMo","trMo","adMo",
    "modeAgg","modeCon"
  ];
  const out={};
  ids.forEach(id=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio") out[id]=el.checked;
    else out[id]=el.value;
  });
  return out;
}
function applyAllInputs(obj){
  Object.entries(obj||{}).forEach(([id,val])=>{
    const el=$(id);
    if(!el) return;
    if(el.type==="radio") el.checked=!!val;
    else el.value=val;
  });
}

/* render */
function run(){
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");

  const p = getParams();
  const sim = simulate(p);
  const rows = sim.rows;
  if(!rows.length) return;

  const h = sim.horizonIndex;
  const slice = rows.slice(0, h+1);
  const labels = slice.map(r=>r.m);

  // Purchases KPIs
  const totB = sim.totals.cumBoughtDoes + sim.totals.cumBoughtBucks;
  $("k_buy_total").textContent = fmtInt(totB);
  $("k_buy_does").textContent = fmtInt(sim.totals.cumBoughtDoes);
  $("k_buy_bucks").textContent = fmtInt(sim.totals.cumBoughtBucks);

  let firstPur = null;
  for(const r of rows){
    if(r.purchaseSpend>0){ firstPur = r.m; break; }
  }
  $("k_buy_first").textContent = firstPur===null ? "None" : `Month ${firstPur}`;

  // Purchases chart (Action 1)
  chPurch?.destroy();
  chPurch = makeChart("chartPurchTotal","line",labels,[
    {label:"Cumulative goats bought", data:slice.map(r=>Math.round(r.cumBought)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Total herd on-farm", data:slice.map(r=>Math.round(r.herd)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4]}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Growth KPIs
  $("g_reach").textContent = sim.reachedMonth===null ? "No" : "Yes";
  $("g_time").textContent = sim.reachedMonth===null ? `Not reached by ${p.maxMonths} months` : moFmt(sim.reachedMonth);

  const last = slice[slice.length-1];
  const util = (last.capacityDoes>0) ? last.eligible/last.capacityDoes : 0;
  $("g_buck").textContent =
    (last.capacityDoes===0 && last.breedingDoes>0) ? "No bucks"
    : (last.eligible > last.capacityDoes) ? "Limiting (add bucks)"
    : (util>0.85) ? "Tight"
    : "Healthy";

  $("g_herd_target_total").textContent = fmtInt(last.herd);

  // Herd chart
  chHerd?.destroy();
  chHerd = makeChart("chartHerd","line",labels,[
    {label:"Breeding does", data:slice.map(r=>Math.round(r.breedingDoes)), borderWidth:2, tension:.25, pointRadius:0, fill:true},
    {label:"Young females", data:slice.map(r=>Math.round(r.youngF + r.fForSale)), borderWidth:2, tension:.25, pointRadius:0, fill:true},
    {label:"Bucks", data:slice.map(r=>Math.round(r.bucksActive)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Young males", data:slice.map(r=>Math.round(r.youngM)), borderWidth:2, tension:.25, pointRadius:0, fill:true}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Constraint chart
  chCons?.destroy();
  chCons = makeChart("chartConstraint","line",labels,[
    {label:"Breedable does (eligible)", data:slice.map(r=>Math.round(r.eligible)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y"},
    {label:"Buck capacity (bucks×ratio)", data:slice.map(r=>Math.round(r.capacityDoes)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4], yAxisID:"y"},
    {label:"Bucks (count)", data:slice.map(r=>Math.round(r.bucksActive)), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y2"}
  ],{
    scales:{
      y:{type:"linear", position:"left", beginAtZero:true, grid:{color:"rgba(0,0,0,.08)"}},
      y2:{type:"linear", position:"right", beginAtZero:true, grid:{drawOnChartArea:false}}
    }
  });

  // Sales KPIs + chart
  const maleSoldTot = Math.round(sim.totals.totalMaleSold);
  const femSoldTot = Math.round(sim.totals.totalFemaleSold);
  $("s_totalSold").textContent = fmtInt(maleSoldTot + femSoldTot);
  $("s_maleSold").textContent = fmtInt(maleSoldTot);
  $("s_femaleSold").textContent = fmtInt(femSoldTot);
  $("s_firstSale").textContent = sim.totals.firstSaleMonth===null ? "Never" : `Month ${sim.totals.firstSaleMonth}`;

  chSales?.destroy();
  chSales = makeChart("chartSales","bar",labels,[
    {label:"Male sold", data:slice.map(r=>Math.round(r.maleSold)), borderWidth:1},
    {label:"Female sold", data:slice.map(r=>Math.round(r.femaleSold)), borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Money KPIs
  const horizonRow = rows[sim.horizonIndex];
  $("m_revTot").textContent = money(horizonRow.cumRev);
  $("m_costTot").textContent = money(horizonRow.cumCost);
  $("m_opBE").textContent = sim.opBE===null ? "Never" : `Month ${sim.opBE}`;
  $("m_fullBE").textContent = sim.fullBE===null ? "Never" : `Month ${sim.fullBE}`;

  // Money charts
  chCum?.destroy();
  chCum = makeChart("chartCumRevCost","line",labels,[
    {label:"Cumulative revenue", data:slice.map(r=>Math.round(r.cumRev)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Cumulative costs", data:slice.map(r=>Math.round(r.cumCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[5,4]}
  ]);

  chNet?.destroy();
  const netSeries = slice.map(r=>Math.round(r.net));
  chNet = makeChart("chartMonthlyNet","line",labels,[
    {
      label:"Monthly net (all-in)",
      data: netSeries,
      borderWidth:4,
      tension:.25,
      pointRadius:0,
      segment:{
        borderColor: ctx => (ctx.p0.parsed.y>=0 && ctx.p1.parsed.y>=0) ? "rgba(0,140,0,.95)" : "rgba(180,0,0,.95)"
      }
    }
  ],{ scales:{ y:{beginAtZero:false} } });

  chMo?.destroy();
  chMo = makeChart("chartMonthlyRevCost","line",labels,[
    {label:"Monthly revenue", data:slice.map(r=>Math.round(r.revenue)), borderWidth:3, tension:.25, pointRadius:0},
    {label:"Operating cost", data:slice.map(r=>Math.round(r.opCost)), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4]}
  ],{ scales:{ y:{beginAtZero:true} } });

  // Snapshot
  $("x_time").textContent = sim.reachedMonth===null ? "Not reached" : moFmt(sim.reachedMonth);
  $("x_conf").textContent = "—";
  $("x_netTarget").textContent = money(horizonRow.cumNet);
  $("x_compTarget").textContent =
    `Total ${fmtInt(horizonRow.herd)} | Does ${fmtInt(horizonRow.breedingDoes)} | Bucks ${fmtInt(horizonRow.bucksActive)} | YoungF ${fmtInt(horizonRow.youngF + horizonRow.fForSale)} | YoungM ${fmtInt(horizonRow.youngM)}`;

  chWF?.destroy();
  chWF = makeChart("chartWaterfall","bar",["Horizon"],[
    {label:"Total Revenue", data:[Math.round(horizonRow.cumRev)], borderWidth:1},
    {label:"Total Costs", data:[Math.round(horizonRow.cumCost)], borderWidth:1},
    {label:"Net Position", data:[Math.round(horizonRow.cumNet)], borderWidth:1}
  ],{ scales:{ y:{beginAtZero:true} } });

  $("advBox").innerHTML = buildAdvice(p, sim);

  $("saveMsg").style.display="none";
  $("loadMsg").style.display="none";
}

/* run button */
$("runBtn").addEventListener("click", run);

/* font size */
$("fontSize").addEventListener("input", ()=>{
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});

/* save/load handlers */
$("btnSave").addEventListener("click", ()=>{
  const name = ($("scName").value || "scenario").trim().replace(/[^\w\-]+/g,"_");
  const data = getAllInputs();
  const blob = new Blob([JSON.stringify({name, data}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${name}.json`;
  a.click();
  URL.revokeObjectURL(a.href);

  const box = $("saveMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Saved: ${name}.json (downloaded).`;
});

$("fileLoad").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    loadedScenario = JSON.parse(txt);
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small warn";
    box.textContent = `Loaded file: ${(loadedScenario.name||file.name)}. Click “Apply loaded scenario”.`;
  }catch(err){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `Could not read JSON.`;
    loadedScenario = null;
  }
});

$("btnApplyLoad").addEventListener("click", ()=>{
  if(!loadedScenario?.data){
    const box = $("loadMsg");
    box.style.display="block";
    box.className="banner small bad";
    box.textContent = `No scenario loaded yet.`;
    return;
  }
  applyAllInputs(loadedScenario.data);

  const box = $("loadMsg");
  box.style.display="block";
  box.className="banner small good";
  box.textContent = `Applied scenario inputs. Now click Run.`;
});

/* initial render */
run();
</script>
</body>
</html>
