<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Goat Farm Planner</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --fs: 16px;
  --bg: #e6e6e6;
  --card: #f7f7f7;
  --ink: #111;
  --muted: #444;
  --line: #c8c8c8;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
.wrap{max-width:1180px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;font-size:1.25rem}
.small{color:var(--muted);font-size:0.9rem;line-height:1.35}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:1.25fr 1fr;gap:12px;align-items:center;margin:10px 0}
label{font-weight:800}
input,select,button{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
button{cursor:pointer;font-weight:900}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}

.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.tabBtn{width:auto;padding:8px 10px}
.tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
.tab{display:none}.tab.active{display:block}

.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi small{display:block;color:var(--muted);font-weight:800}
.kpi .v{font-size:1.1rem;font-weight:900;margin-top:6px}
.banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
.good{border-color:rgba(0,140,0,.35);background:rgba(0,140,0,.07)}
.warn{border-color:rgba(200,150,0,.35);background:rgba(200,150,0,.08)}
.bad{border-color:rgba(180,0,0,.35);background:rgba(180,0,0,.08)}

.canvasBox{margin-top:10px}
canvas{
  display:block;
  width:100% !important;
  height:280px !important;
  max-height:280px !important;
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:8px;
}

details{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
details summary{cursor:pointer;font-weight:900}
.pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:800;font-size:.85rem}
.pill.green{border-color:rgba(0,140,0,.35);background:rgba(0,140,0,.07)}
.pill.yellow{border-color:rgba(200,150,0,.35);background:rgba(200,150,0,.08)}
.pill.red{border-color:rgba(180,0,0,.35);background:rgba(180,0,0,.08)}

.topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.runArea{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.runBtn{position:relative;min-width:140px}
.spinner{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(0,0,0,.18);
  border-top-color: rgba(0,0,0,.65);
  animation:spin 1s linear infinite;
  display:none;
}
@keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Goat Farm Planner <span class="small">— reach your target herd + money plan</span></h1>
      <div class="small">
        Gestation fixed: <b>5 months</b> • Starting herd bought at <b>3 months old</b> → active after <b>5 months</b> • Purchases also mature in <b>5 months</b> • Buck limit: <b>does per buck</b>
      </div>
    </div>

    <div class="runArea">
      <div class="row" style="margin:0;min-width:260px">
        <label title="Your goal herd size. Simulation stops when you hit it.">Target herd size</label>
        <input id="target" type="number" value="200" min="10" />
      </div>
      <div class="row" style="margin:0;min-width:260px">
        <label title="Your target month window. Used for confidence + purchase suggestions.">Target months (timeframe)</label>
        <input id="timeframe" type="number" value="48" min="6" />
      </div>

      <div class="runBtn">
        <button id="runBtn">Run</button>
        <div class="spinner" id="spin"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Maximum months the model will simulate if target isn't reached.">Max months (safety cap)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12" />
        </div>

        <div class="row">
          <label title="Does per buck. Buck capacity = bucks × does-per-buck.">Does per buck</label>
          <input id="doesPerBuck" type="number" value="20" min="5" max="50" />
        </div>

        <div class="row">
          <label title="Land cap = acres × goats per acre. If herd exceeds cap, growth is reduced.">Land acres / goats per acre</label>
          <div style="display:flex;gap:10px">
            <input id="acres" type="number" value="20" min="1" />
            <input id="goatsPerAcre" type="number" value="10" min="1" />
          </div>
        </div>

        <div class="row">
          <label title="Pick a comfortable reading size.">Font size</label>
          <input id="fontSize" type="range" min="14" max="22" value="16" />
        </div>
      </div>

      <div>
        <div class="row">
          <label title="If ON, we simulate uncertainty in biological rates (not prices).">Monte Carlo</label>
          <select id="mcOn">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </div>

        <div class="row">
          <label title="Show/hide confidence bands on the herd chart. (Bands are percentiles from Monte Carlo runs.)">Confidence bands</label>
          <select id="bandsOn">
            <option value="on">Show</option>
            <option value="off">Hide</option>
          </select>
        </div>

        <div class="row">
          <label title="How many random simulations. 150–300 is a good balance.">Monte Carlo runs</label>
          <input id="mcRuns" type="number" value="200" min="50" step="50" />
        </div>

        <div class="row">
          <label title="Toggle to reduce breeding success outside peak months.">Seasonality (breeding)</label>
          <select id="seasonOn">
            <option value="off">Off</option>
            <option value="on">On</option>
          </select>
        </div>

        <div class="row">
          <label title="If seasonality ON, breeding success reduced in off-peak months by this %.">Off-season penalty %</label>
          <input id="seasonPenalty" type="number" value="15" min="0" max="60" />
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs (requested order) -->
  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (bought at 3 months old → active after 5 months)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="These are young at Month 0 and become active breeders after 5 months.">Starting does (young)</label>
            <input id="startDoes" type="number" value="4" min="0" />
          </div>
          <div class="row">
            <label title="These are young at Month 0 and become active bucks after 5 months.">Starting bucks (young)</label>
            <input id="startBucks" type="number" value="1" min="0" />
          </div>
        </div>
        <div>
          <div class="banner small">
            <b>Purchase maturity</b> means “time before a purchased goat can breed (does) or service (bucks).”
            Here it’s fixed at <b>5 months</b>.
          </div>
        </div>
      </div>

      <hr/>

      <b class="small">Expansion purchases (Months 4, 8, 12, 16, 20, 24, 28)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p4f" type="number" value="0" min="0" /><input id="p4m" type="number" value="0" min="0" /></div>
          </div>
          <div class="row"><label>Month 8: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p8f" type="number" value="0" min="0" /><input id="p8m" type="number" value="0" min="0" /></div>
          </div>
          <div class="row"><label>Month 12: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p12f" type="number" value="0" min="0" /><input id="p12m" type="number" value="0" min="0" /></div>
          </div>
          <div class="row"><label>Month 16: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p16f" type="number" value="0" min="0" /><input id="p16m" type="number" value="0" min="0" /></div>
          </div>
        </div>

        <div>
          <div class="row"><label>Month 20: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p20f" type="number" value="0" min="0" /><input id="p20m" type="number" value="0" min="0" /></div>
          </div>
          <div class="row"><label>Month 24: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p24f" type="number" value="0" min="0" /><input id="p24m" type="number" value="0" min="0" /></div>
          </div>
          <div class="row"><label>Month 28: buy does / buy bucks</label>
            <div style="display:flex;gap:10px"><input id="p28f" type="number" value="0" min="0" /><input id="p28m" type="number" value="0" min="0" /></div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button id="suggestBtn" style="flex:1">Suggest buys</button>
            <button id="clearPurchBtn" style="flex:1">Clear purchases</button>
          </div>

          <div id="suggestOut" class="banner small" style="margin-top:10px;display:none"></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total goats bought (start + expansion)</small><div class="v" id="k_totalBought">—</div></div>
        <div class="kpi"><small>Total does bought</small><div class="v" id="k_totalBoughtD">—</div></div>
        <div class="kpi"><small>Total bucks bought</small><div class="v" id="k_totalBoughtB">—</div></div>
        <div class="kpi"><small>Total purchase spend (lifetime)</small><div class="v" id="k_totalSpend">—</div></div>
      </div>

      <!-- Chart 1 placed under Purchases (requested) -->
      <div class="canvasBox">
        <canvas id="chartHerd"></canvas>
        <div class="small">
          Herd composition over time (whole numbers). If Monte Carlo bands are ON, shaded bands show uncertainty.
        </div>
      </div>
    </div>
  </div>

  <!-- Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Growth assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="Monthly breeding rate ≈ 1 / kidding interval.">Kidding interval (months)</label>
            <input id="kiddingInt" type="number" value="12" min="6" max="18" />
          </div>
          <div class="row">
            <label title="Not all breedings result in pregnancy.">Breeding success %</label>
            <input id="breedSuccess" type="number" value="90" min="40" max="100" />
          </div>
          <div class="row">
            <label title="Average number of kids per birth.">Kids per birth</label>
            <input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1" />
          </div>
          <div class="row">
            <label title="Female share of newborn kids.">Female kids %</label>
            <input id="pctFemale" type="number" value="50" min="40" max="60" />
          </div>
          <div class="row">
            <label title="Survival from birth to early life.">Kid survival %</label>
            <input id="kidSurvival" type="number" value="90" min="40" max="100" />
          </div>
        </div>

        <div>
          <div class="row">
            <label title="Females mature into breeding does after this age.">First breeding age (months)</label>
            <input id="breedAge" type="number" value="9" min="8" max="12" />
          </div>
          <div class="row">
            <label title="Females retained to grow the farm. The remainder are sold for breeding at 6 months.">Retain female kids %</label>
            <input id="retainF" type="number" value="85" min="0" max="100" />
          </div>
          <div class="row">
            <label title="All male kids are sold at this age.">Male sale age (months)</label>
            <input id="maleSaleAge" type="number" value="6" min="1" max="12" />
          </div>
          <div class="banner small" id="femaleRuleNote"></div>
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">
          Constraint chart: breedable does vs buck capacity. Buck count is shown on a 2nd axis.
          <span class="pill" title="Buck capacity = bucks × does-per-buck. If does exceed capacity, breeding is limited.">Buck capacity</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Money assumptions</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label>Currency label</label>
            <input id="cur" value="UGX" />
          </div>
          <div class="row">
            <label>Buy price: doe / buck</label>
            <div style="display:flex;gap:10px">
              <input id="buyF" type="number" value="400000" min="0" />
              <input id="buyM" type="number" value="400000" min="0" />
            </div>
          </div>
          <div class="row">
            <label>Sale price: male / female (breeding)</label>
            <div style="display:flex;gap:10px">
              <input id="sellM" type="number" value="250000" min="0" />
              <input id="sellFb" type="number" value="400000" min="0" />
            </div>
          </div>
          <div class="banner small">
            We do <b>not</b> randomize prices in Monte Carlo (to avoid weird values like “79,999”). If you ever want market volatility, we can add it explicitly.
          </div>
        </div>

        <div>
          <div class="row"><label>Feed/goat/month</label><input id="feed" type="number" value="2500" min="0" /></div>
          <div class="row"><label>Medication/goat/month</label><input id="med" type="number" value="0" min="0" /></div>
          <div class="row"><label>Other variable/goat/month</label><input id="othVar" type="number" value="0" min="0" /></div>

          <hr/>

          <b class="small">Fixed costs (monthly)</b>
          <div class="row"><label>Property / year</label><input id="propYr" type="number" value="1500000" min="0" /></div>
          <div class="row"><label>Labor / month</label><input id="laborMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Vet / month</label><input id="vetMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Security / month</label><input id="secMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Transport / month</label><input id="trMo" type="number" value="0" min="0" /></div>
          <div class="row"><label>Admin / month</label><input id="adMo" type="number" value="0" min="0" /></div>
        </div>
      </div>

      <hr/>

      <b class="small">Season toggles (cost + price)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="If ON, variable costs increase in these months.">Dry season cost bump</label>
            <select id="dryOn"><option value="off">Off</option><option value="on">On</option></select>
          </div>
          <div class="row">
            <label title="Months 1–12, comma list (e.g., 6,7,8).">Dry season months</label>
            <input id="dryMonths" value="6,7,8" />
          </div>
          <div class="row">
            <label>Dry season cost increase %</label>
            <input id="dryPct" type="number" value="20" min="0" max="100" />
          </div>
        </div>

        <div>
          <div class="row">
            <label title="If ON, sale prices change in these months.">Seasonal sale price change</label>
            <select id="priceOn"><option value="off">Off</option><option value="on">On</option></select>
          </div>
          <div class="row">
            <label title="Months 1–12, comma list (e.g., 11,12).">Price season months</label>
            <input id="priceMonths" value="11,12" />
          </div>
          <div class="row">
            <label>Sale price change %</label>
            <input id="pricePct" type="number" value="10" min="-50" max="50" />
          </div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small title="Initial goat purchases + 6 months of fixed + variable costs (net of any revenue in first 6 months).">Cash needed to start (6 months)</small><div class="v" id="m_startcash">—</div></div>
        <div class="kpi"><small title="First month where Revenue ≥ Operating Costs (variable+fixed, excluding purchases).">Operating break-even</small><div class="v" id="m_opbe">—</div></div>
        <div class="kpi"><small title="First month where cumulative net cash ≥ 0 (includes purchases).">Farm break-even</small><div class="v" id="m_fullbe">—</div></div>
        <div class="kpi"><small title="First month where monthly net (all-in) stays ≥ 0 for 6 months in a row.">Self-sustaining</small><div class="v" id="m_self">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartMonthly"></canvas>
        <div class="small">Monthly revenue vs total costs (operating + purchases). Whole numbers only.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCum"></canvas>
        <div class="small">
          Cumulative revenue vs cumulative total costs (operating + purchases).
          <b>Startup goat purchase is included at Month 0.</b>
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartRevBreak"></canvas>
        <div class="small">Revenue breakdown (male sales vs female breeding sales).</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartNet"></canvas>
        <div class="small">Monthly net (all-in): revenue − operating costs − purchases.</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Outcome KPIs</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small title="Month you hit target in the deterministic run.">Time to target (deterministic)</small><div class="v" id="s_det">—</div></div>
        <div class="kpi"><small title="Chance to hit target by your timeframe (Monte Carlo only).">Target confidence (by Month X)</small><div class="v" id="s_conf">—</div></div>
        <div class="kpi"><small title="Median time-to-target across Monte Carlo runs (if ON).">P50 time-to-target</small><div class="v" id="s_p50">—</div></div>
        <div class="kpi"><small title="90th percentile time-to-target across Monte Carlo runs (if ON).">P90 time-to-target</small><div class="v" id="s_p90">—</div></div>
      </div>

      <hr/>

      <b class="small">Money KPIs (at target month)</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Total purchase spend (lifetime)</small><div class="v" id="s_purchSpend">—</div></div>
        <div class="kpi"><small>Total revenue to date</small><div class="v" id="s_rev">—</div></div>
        <div class="kpi"><small>Total costs to date</small><div class="v" id="s_cost">—</div></div>
        <div class="kpi"><small>Net position to date</small><div class="v" id="s_net">—</div></div>
      </div>

      <hr/>

      <b class="small">Herd composition at target</b>
      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Breeding does</small><div class="v" id="h_does">—</div></div>
        <div class="kpi"><small>Bucks</small><div class="v" id="h_bucks">—</div></div>
        <div class="kpi"><small>Young females</small><div class="v" id="h_yf">—</div></div>
        <div class="kpi"><small>Young males</small><div class="v" id="h_ym">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWater"></canvas>
        <div class="small">Totals by target month: revenue vs operating costs vs purchase spend → net position.</div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="copyPromptBtn" style="flex:1">Copy analysis prompt + data</button>
      </div>
      <div id="copyOut" class="banner small" style="margin-top:10px;display:none"></div>

      <hr/>

      <details>
        <summary>Model assumptions</summary>
        <div class="small" style="margin-top:10px">
          <b>Breeding / biology assumptions</b>
          <ul>
            <li>Gestation is fixed at <b>5 months</b>.</li>
            <li>Starting herd is bought at <b>3 months old</b> and becomes active after <b>5 months</b>.</li>
            <li>Purchased goats also take <b>5 months</b> to become active.</li>
            <li>Breeding is modeled as a <b>monthly rate</b> ≈ 1 / kidding interval (not one big breeding event).</li>
            <li>Breeding limited by <b>buck capacity</b> = bucks × does-per-buck.</li>
            <li>Kid survival and breed success are applied as <b>percentages</b> (averages).</li>
          </ul>

          <b>Sales assumptions</b>
          <ul>
            <li>Male kids sold at your chosen age.</li>
            <li>Female kids: retained % vs sold for breeding at <b>6 months</b>.</li>
            <li>No “clearance” selling (unless you add it later).</li>
          </ul>

          <b>Money assumptions</b>
          <ul>
            <li>Variable cost per goat per month is constant (feed + med + other), with optional dry-season bump.</li>
            <li>Fixed costs are constant monthly (property/12 + labor + vet + security + transport + admin).</li>
            <li><b>Operating BE:</b> Revenue ≥ Operating Costs (excludes purchases).</li>
            <li><b>Farm BE:</b> Cumulative net cash ≥ 0 (includes purchases).</li>
            <li><b>Self-sustaining:</b> Monthly net (all-in) ≥ 0 for 6 consecutive months.</li>
          </ul>

          <b>Monte Carlo assumptions (if ON)</b>
          <ul>
            <li>We randomize biological rates within tight ranges to estimate confidence/bands.</li>
            <li>We do <b>not</b> randomize prices (avoids unrealistic price values).</li>
          </ul>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number(($(id)?.value ?? 0) || 0);
const S = (id)=>String(($(id)?.value ?? ""));

const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const round0=(x)=>Math.round(x||0);
const money=(n)=>{
  const cur = (S("cur")||"UGX").trim();
  return `${cur} ${round0(n).toLocaleString()}`;
};
const moFmt=(mo)=>{
  if(mo===null || mo===undefined) return "Never";
  const y = Math.floor(mo/12), m = mo%12;
  return y ? `${y}y ${m}m` : `${m} months`;
};
function parseMonthList(s){
  return new Set((s||"").split(",").map(x=>parseInt(x.trim(),10)).filter(x=>x>=1&&x<=12));
}
$("fontSize").addEventListener("input", ()=> {
  document.documentElement.style.setProperty("--fs", $("fontSize").value + "px");
});

/* ---------- tabs ---------- */
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    $(btn.dataset.tab).classList.add("active");
  });
});

/* ---------- fixed model constants ---------- */
const GEST = 5;        // months
const MAT = 5;         // months to become active (starting herd + purchases)
const F_SALE_AGE = 6;  // female breeding sale age (months)

/* ---------- purchase schedule (months) ---------- */
const PURCHASE_MONTHS = [4,8,12,16,20,24,28];

/* ---------- UI rule note ---------- */
function updateFemaleRuleNote(){
  const retain = clamp(N("retainF"),0,100);
  const sell = 100 - retain;
  $("femaleRuleNote").innerHTML =
    `Females: <b>${retain}% retained</b> for growth, <b>${sell}% sold for breeding</b> at 6 months.`;
}
$("retainF").addEventListener("input", updateFemaleRuleNote);
updateFemaleRuleNote();

/* ---------- params ---------- */
function getParams(){
  const acres = N("acres"), gpa = N("goatsPerAcre");
  const cap = Math.max(0, acres*gpa);

  const fixedMo =
    (N("propYr")/12) + N("laborMo") + N("vetMo") + N("secMo") + N("trMo") + N("adMo");

  return {
    target: N("target"),
    timeframe: N("timeframe"),
    maxMonths: N("maxMonths"),
    doesPerBuck: N("doesPerBuck"),

    // starting herd (young; active after MAT)
    startDoes: N("startDoes"),
    startBucks: N("startBucks"),

    // growth
    kiddingInt: clamp(N("kiddingInt"), 6, 18),
    breedSuccess: clamp(N("breedSuccess"), 40, 100)/100,
    kidsPerBirth: clamp(N("kidsPerBirth"), 1, 3.5),
    pctFemale: clamp(N("pctFemale"), 40, 60)/100,
    kidSurvival: clamp(N("kidSurvival"), 40, 100)/100,
    breedAge: clamp(N("breedAge"), 8, 12),
    retainF: clamp(N("retainF"), 0, 100)/100,
    maleSaleAge: clamp(N("maleSaleAge"), 1, 12),

    // land cap
    cap,

    // seasonality (breeding)
    seasonOn: S("seasonOn"),
    seasonPenalty: clamp(N("seasonPenalty"), 0, 60)/100,

    // money
    buyF: N("buyF"),
    buyM: N("buyM"),
    sellM: N("sellM"),
    sellFb: N("sellFb"),
    feed: N("feed"),
    med: N("med"),
    othVar: N("othVar"),
    fixedMo,

    // cost/price season
    dryOn: S("dryOn"),
    dryMonths: S("dryMonths"),
    dryPct: N("dryPct")/100,
    priceOn: S("priceOn"),
    priceMonths: S("priceMonths"),
    pricePct: N("pricePct")/100,

    // monte carlo
    mcOn: S("mcOn"),
    bandsOn: S("bandsOn"),
    mcRuns: clamp(N("mcRuns"), 50, 1000),
  };
}

/* ---------- purchases getters/setters ---------- */
function getPurchaseInputs(){
  const map = {};
  for(const m of PURCHASE_MONTHS){
    map[m] = { f: N(`p${m}f`), b: N(`p${m}m`) };
  }
  return map;
}
function setPurchaseInputs(map){
  for(const m of PURCHASE_MONTHS){
    const v = map[m] || {f:0,b:0};
    $(`p${m}f`).value = Math.max(0, round0(v.f));
    $(`p${m}m`).value = Math.max(0, round0(v.b));
  }
}
$("clearPurchBtn").addEventListener("click", ()=>{
  const blank = {};
  for(const m of PURCHASE_MONTHS) blank[m] = {f:0,b:0};
  setPurchaseInputs(blank);
  $("suggestOut").style.display="none";
});

/* ---------- model helpers ---------- */
function seasonFactor(monthIndex, p){
  if(p.seasonOn!=="on") return 1;
  const pen = p.seasonPenalty;
  const mod = (monthIndex % 12); // 0..11
  // simple: peak months roughly Mar-Aug => 2..7
  const peak = (mod>=2 && mod<=7);
  return peak ? 1 : (1-pen);
}
function capFactor(total, cap){
  if(cap<=0) return 1;
  if(total<=cap) return 1;
  return cap/total; // soft reduction
}
function getPurchaseForMonth(m, purchaseMap){
  // purchaseMap uses month numbers (4,8,12,16...) not mod-year
  if(purchaseMap[m]) return purchaseMap[m];
  return {f:0,b:0};
}
function cumulative(arr){
  let s=0;
  return arr.map(x => (s += (x||0)));
}

/* ---------- deterministic simulation ---------- */
function simulateDeterministic(p, purchaseMap){
  // pipelines for starting herd and purchases (young -> active after MAT)
  let pDoes = Array(MAT).fill(0);
  let pBucks = Array(MAT).fill(0);
  pDoes[0] = p.startDoes;
  pBucks[0] = p.startBucks;

  let does = 0;
  let bucks = 0;

  // retained females until breed age
  let fCoh = Array(p.breedAge).fill(0);

  // male kids until sale age
  let mCoh = Array(p.maleSaleAge).fill(0);

  // female kids for breeding sale at 6 months
  let fSaleCoh = Array(F_SALE_AGE).fill(0);

  // pregnancy queue (attempts) — births after GEST months
  let preg = Array(p.maxMonths + GEST + 5).fill(0);

  // money tracking
  const startSpend = p.startDoes*p.buyF + p.startBucks*p.buyM; // Month 0 purchase (requested)
  let cumNet = -startSpend;
  let worstCum = cumNet;
  let worstMonth = 0;

  let opBE = null;
  let fullBE = (cumNet>=0) ? 0 : null;
  let selfSustain = null;
  let nonNegStreak = 0;

  // 6-month startup cash (requested)
  let startupNeed6 = startSpend; // add first goats
  let startupRev6 = 0;

  const rows = [];

  let totalPurchaseSpend = startSpend;
  let totalDoesBought = p.startDoes;
  let totalBucksBought = p.startBucks;

  for(let m=0; m<p.maxMonths; m++){
    const monthInYear = (m % 12) + 1;

    // mature pipelines into active
    const matureDoes = pDoes[MAT-1] || 0;
    const matureBucks = pBucks[MAT-1] || 0;
    for(let i=MAT-1;i>=1;i--){ pDoes[i]=pDoes[i-1]; pBucks[i]=pBucks[i-1]; }
    pDoes[0]=0; pBucks[0]=0;
    does += matureDoes;
    bucks += matureBucks;

    // births due
    const due = (m-GEST>=0) ? preg[m-GEST] : 0;
    const births = due * p.kidsPerBirth * p.kidSurvival;
    const fBorn = births * p.pctFemale;
    const mBorn = births - fBorn;

    // split females: retain vs sell breeding at 6 months
    const fRet = fBorn * p.retainF;
    const fSale = fBorn - fRet;

    // add newborns into cohorts (these cohorts count as "young")
    if(fCoh.length) fCoh[0] += fRet;
    if(mCoh.length) mCoh[0] += mBorn;
    fSaleCoh[0] += fSale;

    // shift female retained cohort into does at breedAge
    const toDoes = fCoh[fCoh.length-1] || 0;
    for(let i=fCoh.length-1;i>=1;i--) fCoh[i]=fCoh[i-1];
    fCoh[0]=0;
    does += toDoes;

    // shift male cohort to sale at maleSaleAge
    const maleSold = mCoh[mCoh.length-1] || 0;
    for(let i=mCoh.length-1;i>=1;i--) mCoh[i]=mCoh[i-1];
    mCoh[0]=0;

    // shift female-sale cohort to sale at 6 months
    const fBreedingSold = fSaleCoh[F_SALE_AGE-1] || 0;
    for(let i=F_SALE_AGE-1;i>=1;i--) fSaleCoh[i]=fSaleCoh[i-1];
    fSaleCoh[0]=0;

    // apply purchases this month (young, mature later)
    const pur = getPurchaseForMonth(m, purchaseMap);
    const buyDoes = Math.max(0, pur.f||0);
    const buyBucks = Math.max(0, pur.b||0);
    if(buyDoes || buyBucks){
      pDoes[0] += buyDoes;
      pBucks[0] += buyBucks;
      totalDoesBought += buyDoes;
      totalBucksBought += buyBucks;
      totalPurchaseSpend += buyDoes*p.buyF + buyBucks*p.buyM;
    }
    const purchaseSpend = buyDoes*p.buyF + buyBucks*p.buyM;

    // herd counts held on farm (for costs)
    const youngF = fCoh.reduce((a,b)=>a+b,0) + fSaleCoh.reduce((a,b)=>a+b,0) + pDoes.reduce((a,b)=>a+b,0);
    const youngM = mCoh.reduce((a,b)=>a+b,0) + pBucks.reduce((a,b)=>a+b,0);
    const herdTotal = does + bucks + youngF + youngM;

    // breeding this month: monthly rate ~ 1/kiddingInt
    const capDoes = bucks * p.doesPerBuck;
    const breedable = Math.min(does, capDoes);
    const monthlyRate = 1 / p.kiddingInt;
    const attempts = breedable * monthlyRate;

    // apply breed success, seasonality, land cap
    const sf = seasonFactor(m, p);
    const cf = capFactor(herdTotal, p.cap);
    preg[m] = attempts * p.breedSuccess * sf * cf;

    // money season toggles
    const dryMonths = parseMonthList(p.dryMonths);
    const priceMonths = parseMonthList(p.priceMonths);
    const isDry = (p.dryOn==="on") && dryMonths.has(monthInYear);
    const isPriceSeason = (p.priceOn==="on") && priceMonths.has(monthInYear);
    const costMult = isDry ? (1 + p.dryPct) : 1;
    const saleMult = isPriceSeason ? (1 + p.pricePct) : 1;

    const varCost = herdTotal * ((p.feed + p.med + p.othVar) * costMult);
    const opCost = varCost + p.fixedMo;
    const revMale = maleSold * p.sellM * saleMult;
    const revFemB = fBreedingSold * p.sellFb * saleMult;
    const revenue = revMale + revFemB;

    const netAllIn = revenue - opCost - purchaseSpend;

    cumNet += netAllIn;
    if(cumNet < worstCum){ worstCum = cumNet; worstMonth = m; }

    if(opBE===null && revenue >= opCost) opBE = m;
    if(fullBE===null && cumNet >= 0) fullBE = m;

    if(netAllIn >= 0) nonNegStreak++; else nonNegStreak = 0;
    if(selfSustain===null && nonNegStreak >= 6) selfSustain = m-5;

    // startup cash need: first 6 months (0..5)
    if(m < 6){
      startupNeed6 += (opCost + purchaseSpend); // operating + purchases inside first 6 months
      startupRev6 += revenue;
    }

    rows.push({
      m,
      monthInYear,
      does: round0(does),
      bucks: round0(bucks),
      youngF: round0(youngF),
      youngM: round0(youngM),
      herdTotal: round0(herdTotal),
      capDoes: round0(capDoes),
      revenue: round0(revenue),
      revMale: round0(revMale),
      revFemB: round0(revFemB),
      opCost: round0(opCost),
      varCost: round0(varCost),
      fixedMo: round0(p.fixedMo),
      purchaseSpend: round0(purchaseSpend),
      netAllIn: round0(netAllIn),
      cumNet: round0(cumNet),
      breedableDoes: round0(breedable),
      buckCount: round0(bucks),
      startSpend: round0(startSpend)
    });

    if(herdTotal >= p.target) break;
  }

  const reachedMonth = rows.length && rows[rows.length-1].herdTotal >= p.target ? rows[rows.length-1].m : null;

  return {
    rows,
    reachedMonth,
    opBE,
    fullBE,
    selfSustain,
    startSpend: round0(startSpend),
    startupCash6: Math.max(0, round0(startupNeed6 - startupRev6)),
    worstCum: round0(worstCum),
    worstMonth,
    totalPurchaseSpend: round0(totalPurchaseSpend),
    totalDoesBought: round0(totalDoesBought),
    totalBucksBought: round0(totalBucksBought),
  };
}

/* ---------- Monte Carlo (confidence + bands) ---------- */
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function jitter(r, base, pct, lo, hi){
  const j = base * (1 + ((r()-0.5)*2*pct));
  return Math.max(lo, Math.min(hi, j));
}
function simulateRand(p, purchaseMap, seed){
  const r = rng(seed);
  const q = {...p};
  q.kidsPerBirth = jitter(r, p.kidsPerBirth, 0.12, 1, 3.5);
  q.kidSurvival  = jitter(r, p.kidSurvival, 0.10, 0.4, 1);
  q.breedSuccess = jitter(r, p.breedSuccess, 0.08, 0.4, 1);
  // keep other params deterministic; no prices randomized
  return simulateDeterministic(q, purchaseMap);
}
function percentile(sorted, q){
  if(!sorted.length) return null;
  const idx = Math.floor(q*(sorted.length-1));
  return sorted[idx];
}
function monteCarloSummary(p, purchaseMap){
  const runs = p.mcRuns;
  const tf = p.timeframe;
  const reached = [];
  let hitByTF = 0;

  // for bands: store herdTotal per month across runs
  const storeBands = (p.bandsOn==="on");
  let series = null; // array of arrays per month
  let maxLen = 0;

  for(let i=0;i<runs;i++){
    const sim = simulateRand(p, purchaseMap, 123456 + i*99991);
    const rm = sim.reachedMonth;
    if(rm!==null){
      reached.push(rm);
      if(rm <= tf) hitByTF++;
    }
    if(storeBands){
      const rows = sim.rows;
      maxLen = Math.max(maxLen, rows.length);
      if(!series) series = [];
      for(let m=0;m<rows.length;m++){
        if(!series[m]) series[m] = [];
        series[m].push(rows[m].herdTotal);
      }
    }
  }

  reached.sort((a,b)=>a-b);
  const pct = Math.round((hitByTF / runs) * 100);
  const p50 = percentile(reached, 0.50);
  const p90 = percentile(reached, 0.90);

  let bands = null;
  if(storeBands && series){
    bands = {
      p10: [],
      p50: [],
      p90: []
    };
    for(let m=0;m<series.length;m++){
      const arr = (series[m]||[]).slice().sort((a,b)=>a-b);
      bands.p10[m] = round0(percentile(arr, 0.10) ?? null);
      bands.p50[m] = round0(percentile(arr, 0.50) ?? null);
      bands.p90[m] = round0(percentile(arr, 0.90) ?? null);
    }
  }

  return { pct, p50, p90, bands };
}

/* ---------- charts ---------- */
let chHerd=null, chCons=null, chMonthly=null, chCum=null, chRevBreak=null, chNet=null, chWater=null;

function makeLineChart(canvasId, labels, datasets, extraOptions={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#111", font: { weight: "800" } } },
        tooltip: { callbacks:{
          label: (ctx)=>{
            const v = ctx.parsed.y;
            return `${ctx.dataset.label}: ${round0(v).toLocaleString()}`;
          }
        }}
      },
      scales: {
        x: { ticks: { color:"#111" }, grid: { color:"rgba(0,0,0,.08)" } },
        y: { ticks: { color:"#111", callback:(v)=>round0(v).toLocaleString() }, grid: { color:"rgba(0,0,0,.08)" } }
      },
      ...extraOptions
    }
  });
}

function makeBarChart(canvasId, labels, datasets, extraOptions={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx, {
    type: "bar",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color:"#111", font:{weight:"800"} } },
        tooltip: { callbacks:{
          label: (ctx)=> `${ctx.dataset.label}: ${round0(ctx.parsed.y).toLocaleString()}`
        }}
      },
      scales: {
        x: { ticks: { color:"#111" }, grid: { color:"rgba(0,0,0,.08)" } },
        y: { ticks: { color:"#111", callback:(v)=>round0(v).toLocaleString() }, grid: { color:"rgba(0,0,0,.08)" } }
      },
      ...extraOptions
    }
  });
}

/* ---------- compute + render ---------- */
function computePurchaseTotals(p, purchaseMap){
  let does = p.startDoes, bucks = p.startBucks;
  let spend = p.startDoes*p.buyF + p.startBucks*p.buyM;
  for(const m of PURCHASE_MONTHS){
    const pur = purchaseMap[m] || {f:0,b:0};
    does += pur.f||0; bucks += pur.b||0;
    spend += (pur.f||0)*p.buyF + (pur.b||0)*p.buyM;
  }
  return {does:round0(does), bucks:round0(bucks), total:round0(does+bucks), spend:round0(spend)};
}

function renderAll(){
  const p = getParams();
  const purchaseMap = getPurchaseInputs();

  // deterministic
  const det = simulateDeterministic(p, purchaseMap);
  const rows = det.rows;
  const labels = rows.map(r=>`M${r.m}`);

  // monte carlo summary + bands
  let mc = { pct:"—", p50:null, p90:null, bands:null };
  if(p.mcOn==="on"){
    mc = monteCarloSummary(p, purchaseMap);
  }

  // KPIs (Purchases totals)
  const totals = computePurchaseTotals(p, purchaseMap);
  $("k_totalBought").textContent = `${totals.total.toLocaleString()}`;
  $("k_totalBoughtD").textContent = `${totals.does.toLocaleString()}`;
  $("k_totalBoughtB").textContent = `${totals.bucks.toLocaleString()}`;
  $("k_totalSpend").textContent = money(det.totalPurchaseSpend);

  // Charts: Herd (in Purchases tab) + optional bands
  chHerd?.destroy();
  const herdDs = [
    { label:"Breeding does", data: rows.map(r=>r.does), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Young females", data: rows.map(r=>r.youngF), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Bucks", data: rows.map(r=>r.bucks), borderWidth:2, tension:.25, pointRadius:0, fill:true },
    { label:"Young males", data: rows.map(r=>r.youngM), borderWidth:2, tension:.25, pointRadius:0, fill:true },
  ];

  // Confidence bands: add p10/p90 around total herd as two lines (simple, not fancy shading)
  if(p.mcOn==="on" && p.bandsOn==="on" && mc.bands){
    herdDs.unshift(
      { label:"Herd p10", data: mc.bands.p10, borderWidth:2, tension:.25, pointRadius:0, borderDash:[6,4], fill:false },
      { label:"Herd p90", data: mc.bands.p90, borderWidth:2, tension:.25, pointRadius:0, borderDash:[6,4], fill:false },
    );
  }

  chHerd = makeLineChart("chartHerd", labels, herdDs);

  // Constraint chart (Growth tab): does vs capacity, plus bucks on 2nd axis
  chCons?.destroy();
  chCons = makeLineChart("chartConstraint", labels, [
    { label:"Breedable does", data: rows.map(r=>r.breedableDoes), borderWidth:3, tension:.25, pointRadius:0 },
    { label:"Buck capacity (bucks×ratio)", data: rows.map(r=>r.capDoes), borderWidth:3, tension:.25, pointRadius:0, borderDash:[6,4] },
    { label:"Bucks (count)", data: rows.map(r=>r.buckCount), borderWidth:3, tension:.25, pointRadius:0, yAxisID:"y2" },
  ], {
    scales:{
      y: { position:"left" },
      y2: { position:"right", grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=>round0(v).toLocaleString() } }
    }
  });

  // Money: monthly revenue vs total costs
  const revenue = rows.map(r=>r.revenue);
  const totalCosts = rows.map(r=>r.opCost + r.purchaseSpend);
  const purchases = rows.map(r=>r.purchaseSpend + (r.m===0 ? det.startSpend : 0)); // Month 0 startup cost included here too if you want to see it as spike
  // Note: startSpend is already accounted in net/cum; for chart clarity we also show it as Month 0 purchase component.

  chMonthly?.destroy();
  chMonthly = makeLineChart("chartMonthly", labels, [
    { label:"Revenue", data: revenue, borderWidth:3, tension:.25, pointRadius:0 },
    { label:"Total costs (operating + purchases)", data: totalCosts.map((c,i)=>round0(c + (i===0?det.startSpend:0))), borderWidth:3, tension:.25, pointRadius:0 },
  ]);

  // Money: cumulative revenue vs cumulative total costs (startup cost included at Month 0) — requested
  const cumRev = cumulative(revenue);
  const cumCosts = cumulative(totalCosts.map((c,i)=> round0(c + (i===0?det.startSpend:0))));
  chCum?.destroy();
  chCum = makeLineChart("chartCum", labels, [
    { label:"Cumulative revenue", data: cumRev, borderWidth:3, tension:.25, pointRadius:0 },
    { label:"Cumulative total costs", data: cumCosts, borderWidth:3, tension:.25, pointRadius:0 },
  ]);

  // Revenue breakdown bar
  const revMale = rows.map(r=>r.revMale);
  const revFemB = rows.map(r=>r.revFemB);
  chRevBreak?.destroy();
  chRevBreak = makeBarChart("chartRevBreak", labels, [
    { label:"Male sales", data: revMale, borderWidth:1 },
    { label:"Female breeding sales", data: revFemB, borderWidth:1 },
  ], { scales:{ x:{ stacked:true }, y:{ stacked:true } } });

  // Monthly net (all-in)
  const netAllIn = rows.map(r=>r.netAllIn);
  chNet?.destroy();
  chNet = makeLineChart("chartNet", labels, [
    { label:"Monthly net (all-in)", data: netAllIn, borderWidth:3, tension:.25, pointRadius:0 }
  ]);

  // Money KPIs
  $("m_startcash").textContent = money(det.startupCash6);
  $("m_opbe").textContent = (det.opBE===null) ? "Never" : `Month ${det.opBE}`;
  $("m_fullbe").textContent = (det.fullBE===null) ? "Never" : `Month ${det.fullBE}`;
  $("m_self").textContent = (det.selfSustain===null) ? "Never" : `Month ${det.selfSustain}`;

  // Snapshot KPIs
  $("s_det").textContent = (det.reachedMonth===null) ? "Never" : `Month ${det.reachedMonth}`;
  if(p.mcOn==="on"){
    $("s_conf").textContent = `${mc.pct}%`;
    $("s_p50").textContent = mc.p50===null ? "—" : `Month ${mc.p50}`;
    $("s_p90").textContent = mc.p90===null ? "—" : `Month ${mc.p90}`;
  }else{
    $("s_conf").textContent = "—";
    $("s_p50").textContent = "—";
    $("s_p90").textContent = "—";
  }

  // Totals at "target month" = last row in the run (either target reached or max simulated)
  const last = rows[rows.length-1];
  const totRev = round0(cumRev[cumRev.length-1] || 0);
  const totCosts = round0(cumCosts[cumCosts.length-1] || 0);
  const netPos = round0(totRev - totCosts);

  $("s_purchSpend").textContent = money(det.totalPurchaseSpend);
  $("s_rev").textContent = money(totRev);
  $("s_cost").textContent = money(totCosts);
  $("s_net").textContent = money(netPos);

  // Herd comp at target
  $("h_does").textContent = `${last.does.toLocaleString()}`;
  $("h_bucks").textContent = `${last.bucks.toLocaleString()}`;
  $("h_yf").textContent = `${last.youngF.toLocaleString()}`;
  $("h_ym").textContent = `${last.youngM.toLocaleString()}`;

  // Waterfall-ish totals bar
  chWater?.destroy();
  chWater = makeBarChart("chartWater", ["Totals"], [
    { label:"Total Revenue", data:[totRev] },
    { label:"Total Operating Costs", data:[round0(rows.reduce((a,r)=>a+(r.opCost||0),0))] },
    { label:"Total Purchase Spend", data:[det.totalPurchaseSpend] },
  ], { scales:{ x:{ stacked:true }, y:{ stacked:true } } });

  // Copy analysis prompt payload (full monthly series)
  $("copyPromptBtn").onclick = ()=>{
    const payload = {
      inputs: {
        target: p.target,
        timeframe: p.timeframe,
        maxMonths: p.maxMonths,
        doesPerBuck: p.doesPerBuck,
        land: { acres: p.acres, goatsPerAcre: p.goatsPerAcre, cap: p.cap },
        startingHerd: { does: p.startDoes, bucks: p.startBucks, maturityMonths: MAT, boughtAtMonthsOld: 3 },
        purchases: PURCHASE_MONTHS.map(m=>({ month:m, does: purchaseMap[m]?.f||0, bucks: purchaseMap[m]?.b||0 })),
        growth: {
          gestationMonths: GEST,
          kiddingIntervalMonths: p.kiddingInt,
          breedSuccess: p.breedSuccess,
          kidsPerBirth: p.kidsPerBirth,
          pctFemale: p.pctFemale,
          kidSurvival: p.kidSurvival,
          breedAgeMonths: p.breedAge,
          retainFemalePct: p.retainF,
          maleSaleAgeMonths: p.maleSaleAge,
          seasonality: { on:p.seasonOn==="on", offSeasonPenalty:p.seasonPenalty }
        },
        money: {
          buyF:p.buyF, buyM:p.buyM, sellM:p.sellM, sellFb:p.sellFb,
          feed:p.feed, med:p.med, othVar:p.othVar,
          fixedMo:p.fixedMo,
          fixedBreakdown: { propYr:N("propYr"), laborMo:N("laborMo"), vetMo:N("vetMo"), secMo:N("secMo"), trMo:N("trMo"), adMo:N("adMo") },
          drySeason: { on:p.dryOn==="on", months:p.dryMonths, pct:N("dryPct")/100 },
          priceSeason: { on:p.priceOn==="on", months:p.priceMonths, pct:N("pricePct")/100 }
        },
        monteCarlo: { on:p.mcOn==="on", runs:p.mcRuns, bands:p.bandsOn==="on" }
      },
      outputs: {
        reachedMonth: det.reachedMonth,
        operatingBE: det.opBE,
        farmBE: det.fullBE,
        selfSustaining: det.selfSustain,
        startupCash6: det.startupCash6
      },
      monthlySeries: rows
    };

    const prompt =
`You are my farm analyst. Use the JSON below.

Tasks:
1) Explain what drives my time-to-target and where the bottleneck is (buck capacity vs land cap vs maturity delays).
2) Recommend the smallest purchase changes (by month 4/8/12/16/20/24/28) to hit the target by my timeframe.
3) Explain cash needs: startup cash (6 months), break-even months, and what months drive high costs or low revenue.
4) Give 3 “best next tweaks” and estimate impact on time-to-target.

JSON:
${JSON.stringify(payload)}`;

    navigator.clipboard.writeText(prompt).then(()=>{
      $("copyOut").style.display="block";
      $("copyOut").className="banner small good";
      $("copyOut").textContent="Copied analysis prompt + full monthly series to clipboard.";
      setTimeout(()=>{$("copyOut").style.display="none";}, 2500);
    }).catch(()=>{
      $("copyOut").style.display="block";
      $("copyOut").className="banner small bad";
      $("copyOut").textContent="Copy failed. Your browser may block clipboard access.";
    });
  };
}

/* ---------- simple purchase suggestions (not complicated) ---------- */
function suggestPurchases(){
  const p = getParams();
  const original = getPurchaseInputs();

  // start with current plan
  const plan = JSON.parse(JSON.stringify(original));

  // helper: compute buck tightness at end
  const runWith = (pl)=>{
    const det = simulateDeterministic(p, pl);
    return det;
  };

  // If already hits target by timeframe, just nudge for buck capacity safety
  let det = runWith(plan);

  // Simple loop: add does early if short, and add bucks if constraint tight.
  // Keep small steps to avoid “complicated”.
  const maxPasses = 40;
  let passes = 0;

  while(passes < maxPasses){
    det = runWith(plan);

    // If reached by timeframe, stop
    if(det.reachedMonth !== null && det.reachedMonth <= p.timeframe) break;

    // If not reached or late, add does to earliest purchase month (prefer Month 4, then 8, then 12...)
    const order = [4,8,12,16,20,24,28];
    const addMonth = order[passes % order.length];
    plan[addMonth].f = (plan[addMonth].f||0) + 5; // add 5 does
    passes++;

    // After adding does, ensure buck capacity doesn't choke: if end-of-run utilization > 1, add a buck to next purchase month
    det = runWith(plan);
    const last = det.rows[det.rows.length-1];
    const capDoes = Math.max(1, last.capDoes);
    const util = last.does / capDoes;
    if(util > 1.05){
      // add 1 buck at earliest month that still exists
      const buckMonth = order[Math.min(order.length-1, Math.floor(passes/6))];
      plan[buckMonth].b = (plan[buckMonth].b||0) + 1;
    }
  }

  setPurchaseInputs(plan);

  // show message
  const out = $("suggestOut");
  out.style.display="block";
  out.className = "banner small";
  const det2 = simulateDeterministic(p, plan);
  const status = (det2.reachedMonth!==null && det2.reachedMonth<=p.timeframe) ? "good" : "warn";
  out.classList.add(status);
  out.innerHTML =
    `<b>Suggested plan applied.</b> Projected time-to-target: <b>${det2.reachedMonth===null?"Never":("Month "+det2.reachedMonth)}</b>. ` +
    `Target timeframe: <b>Month ${p.timeframe}</b>. ` +
    `Tip: If you're still late, increase does in Month 4/8 first, then add bucks if the constraint chart shows does above capacity.`;
}

/* ---------- Run button spinner (no explanatory wording) ---------- */
function runWithSpinner(){
  const spin = $("spin");
  spin.style.display="block";
  // Compute immediately, but keep spinner for 1.5 seconds as requested
  renderAll();
  setTimeout(()=>{ spin.style.display="none"; }, 1500);
}

$("runBtn").addEventListener("click", runWithSpinner);
$("suggestBtn").addEventListener("click", ()=>{
  suggestPurchases();
  runWithSpinner();
});

/* ---------- initial render ---------- */
runWithSpinner();
</script>
</body>
</html>
