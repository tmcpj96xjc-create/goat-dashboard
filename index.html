<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Goat Farm Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --fs:16px; --bg:#e6e6e6; --card:#f7f7f7; --ink:#111; --muted:#444; --line:#c8c8c8; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);font-size:var(--fs)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:1.25rem}
    .small{color:var(--muted);font-size:.9rem;line-height:1.35}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;align-items:center;margin:10px 0}
    label{font-weight:800}
    input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:1rem}
    button{cursor:pointer;font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tabBtn{width:auto;padding:8px 10px}
    .tabBtn.active{outline:2px solid rgba(0,0,0,.18)}
    .tab{display:none}
    .tab.active{display:block}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi small{display:block;color:var(--muted);font-weight:900}
    .kpi .v{font-size:1.05rem;font-weight:1000;margin-top:6px}
    .banner{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .good{border-color:rgba(0,140,0,.35);background:rgba(0,140,0,.07)}
    .warn{border-color:rgba(200,150,0,.35);background:rgba(200,150,0,.08)}
    .bad{border-color:rgba(180,0,0,.35);background:rgba(180,0,0,.08)}
    .canvasBox{margin-top:10px}
    canvas{display:block;width:100% !important;height:280px !important;max-height:280px !important;background:#fff;border:1px solid var(--line);border-radius:14px;padding:8px}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .spinWrap{display:flex;gap:10px;align-items:center}
    .spinner{width:18px;height:18px;border:3px solid rgba(0,0,0,.18);border-top-color:rgba(0,0,0,.75);border-radius:50%;display:none;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Goat Farm Planner <span class="small">— reach your target herd + understand money + save scenarios</span></h1>

  <div class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label title="Simulation stops as soon as total herd on-farm reaches this number.">Target herd size</label>
          <input id="target" type="number" value="200" min="10"/>
        </div>
        <div class="row">
          <label title="Used for Target Confidence (chance to reach target by this month).">Timeframe (months)</label>
          <input id="timeframe" type="number" value="60" min="6"/>
        </div>
        <div class="row">
          <label title="Safety cap so charts don’t run forever.">Max months (safety)</label>
          <input id="maxMonths" type="number" value="120" min="24" step="12"/>
        </div>
        <div class="row">
          <label title="Your land carrying capacity. If herd exceeds this, we scale births down.">Land acres / goats per acre</label>
          <div style="display:flex;gap:10px">
            <input id="acres" type="number" value="20" min="1"/>
            <input id="goatsPerAcre" type="number" value="10" min="1"/>
          </div>
        </div>
      </div>

      <div>
        <div class="row">
          <label title="Monte Carlo estimates uncertainty (P50/P90 time-to-target + confidence bands).">Monte Carlo</label>
          <select id="mcOn"><option value="off">Off</option><option value="on" selected>On</option></select>
        </div>
        <div class="row">
          <label title="How many random simulations to estimate confidence. 150–300 is a good balance.">Monte Carlo runs</label>
          <input id="mcRuns" type="number" value="200" min="50" step="50"/>
        </div>
        <div class="row">
          <label title="Show/hide confidence bands on charts (requires Monte Carlo ON).">Confidence bands</label>
          <select id="bandsOn"><option value="off">Hide</option><option value="on" selected>Show</option></select>
        </div>

        <div class="spinWrap">
          <button id="runBtn">Run</button>
          <div id="spinner" class="spinner" aria-label="running"></div>
        </div>
      </div>
    </div>
    <div class="small">Gestation is fixed at <b>5 months (150 days)</b>. Retained female kids can only start breeding at <b>8+ months</b>.</div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" data-tab="tabPurch">Purchases</button>
    <button class="tabBtn" data-tab="tabGrowth">Goat Growth</button>
    <button class="tabBtn" data-tab="tabMoney">Money</button>
    <button class="tabBtn" data-tab="tabSnap">Snapshot</button>
    <button class="tabBtn" data-tab="tabAdv">Advisory</button>
    <button class="tabBtn" data-tab="tabSave">Save/Load (F)</button>
  </div>

  <!-- Purchases -->
  <div id="tabPurch" class="tab active">
    <div class="card">
      <b class="small">Starting herd (Month 0) — mix of young + adult (E)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="banner small">
            <b>Young</b> means purchased at ~3 months old, and becomes active after <b>5 months</b> (at ~8 months).
          </div>
          <div class="row"><label title="Young does at Month 0 (3 months old).">Start young does</label><input id="sYd" type="number" value="4" min="0"/></div>
          <div class="row"><label title="Young bucks at Month 0 (3 months old).">Start young bucks</label><input id="sYb" type="number" value="1" min="0"/></div>
        </div>
        <div>
          <div class="banner small">
            <b>Adult</b> means ready to breed immediately (subject to buck capacity + schedule).
          </div>
          <div class="row"><label title="Adult breeding does at Month 0.">Start adult does</label><input id="sAd" type="number" value="0" min="0"/></div>
          <div class="row"><label title="Adult breeding bucks at Month 0.">Start adult bucks</label><input id="sAb" type="number" value="0" min="0"/></div>
        </div>
      </div>

      <hr/>

      <b class="small">Expansion purchases (young) — Month 4/8/12/16/20/24/28</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Month 4: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p4d" type="number" value="0" min="0"/><input id="p4b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 8: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p8d" type="number" value="0" min="0"/><input id="p8b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 12: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p12d" type="number" value="0" min="0"/><input id="p12b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 16: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p16d" type="number" value="0" min="0"/><input id="p16b" type="number" value="0" min="0"/></div></div>
        </div>
        <div>
          <div class="row"><label>Month 20: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p20d" type="number" value="0" min="0"/><input id="p20b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 24: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p24d" type="number" value="0" min="0"/><input id="p24b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label>Month 28: buy young does / young bucks</label><div style="display:flex;gap:10px"><input id="p28d" type="number" value="0" min="0"/><input id="p28b" type="number" value="0" min="0"/></div></div>
          <div class="row"><label title="These young purchases become active after 5 months (at ~8 months).">Young maturity delay</label><input value="5 months (fixed)" disabled/></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Startup goats bought</small><div class="v" id="k_startBought">—</div></div>
        <div class="kpi"><small>Total goats bought (to target)</small><div class="v" id="k_totalBought">—</div></div>
        <div class="kpi"><small>Startup purchase spend (Month 0)</small><div class="v" id="k_startSpend">—</div></div>
        <div class="kpi"><small>Total purchase spend (to target)</small><div class="v" id="k_totalSpend">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartHerdPurch"></canvas>
        <div class="small">
          Purchases tab: Herd composition with <b>Total herd</b> overlaid (A). All values are whole numbers.
        </div>
      </div>
    </div>
  </div>

  <!-- Goat Growth -->
  <div id="tabGrowth" class="tab">
    <div class="card">
      <b class="small">Breeding / growth inputs</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label title="Buck constraint ratio.">Does per buck</label><input id="doesPerBuck" type="number" value="20" min="5" max="50"/></div>
          <div class="row"><label title="All eligible does breed together at this interval.">Kidding interval (months)</label><input id="kiddingInt" type="number" value="12" min="6" max="18"/></div>
          <div class="row"><label title="Percent of bred does that get pregnant.">Breeding success %</label><input id="breedSuccess" type="number" value="90" min="40" max="100"/></div>
          <div class="row"><label title="Average litter size.">Kids per birth</label><input id="kidsPerBirth" type="number" value="1.8" min="1" max="3.5" step="0.1"/></div>
        </div>
        <div>
          <div class="row"><label title="Female share of newborn kids.">Female kids %</label><input id="pctFemale" type="number" value="50" min="40" max="60"/></div>
          <div class="row"><label title="Survival from birth through early life.">Kid survival %</label><input id="kidSurvival" type="number" value="90" min="40" max="100"/></div>
          <div class="row"><label title="Annual breeding doe loss (health, mortality).">Breeding doe loss %/year</label><input id="doeLoss" type="number" value="3" min="0" max="25" step="0.5"/></div>
          <div class="row"><label title="Retained female kids join breeding pool at 8+ months (fixed).">First breeding age</label><input value="8 months (fixed)" disabled/></div>
        </div>
      </div>

      <hr/>

      <b class="small">Sales freeze (optional)</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row">
            <label title="If you want growth first, freeze ALL sales for this many months from Month 0.">Freeze sales for months</label>
            <input id="freezeSalesMo" type="number" value="0" min="0" max="36"/>
          </div>
          <div class="banner small">During the freeze, we keep all kids on-farm (no sales revenue, higher costs, faster growth).</div>
        </div>
        <div>
          <div class="row"><label title="Male kids are sold at this age (after freeze ends).">Male sale age (months)</label><input id="maleSaleAge" type="number" value="6" min="1" max="12"/></div>
          <div class="row"><label title="Female kids: keep % for growth, sell the rest for breeding at 6 months (after freeze ends).">Retain female kids %</label><input id="retainF" type="number" value="85" min="0" max="100"/></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (det.)</small><div class="v" id="g_det">—</div></div>
        <div class="kpi"><small>P50 / P90 time (MC)</small><div class="v" id="g_p50p90">—</div></div>
        <div class="kpi"><small>Target confidence by timeframe</small><div class="v" id="g_conf">—</div></div>
        <div class="kpi"><small>Herd at target (B)</small><div class="v" id="g_atTarget">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartConstraint"></canvas>
        <div class="small">Constraint: breedable does vs buck capacity (capacity = bucks × does-per-buck). Bucks are shown too (2nd axis line).</div>
      </div>
    </div>
  </div>

  <!-- Money -->
  <div id="tabMoney" class="tab">
    <div class="card">
      <b class="small">Prices & costs</b>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Currency label</label><input id="cur" value="UGX"/></div>
          <div class="row"><label title="Young purchase prices (3 months old).">Buy price (young): doe / buck</label>
            <div style="display:flex;gap:10px"><input id="buyYd" type="number" value="400000" min="0"/><input id="buyYb" type="number" value="400000" min="0"/></div>
          </div>
          <div class="row"><label title="Adult purchase prices (ready to breed).">Buy price (adult): doe / buck</label>
            <div style="display:flex;gap:10px"><input id="buyAd" type="number" value="400000" min="0"/><input id="buyAb" type="number" value="400000" min="0"/></div>
          </div>
          <div class="row"><label>Sell price: male kid / female (breeding)</label>
            <div style="display:flex;gap:10px"><input id="sellM" type="number" value="250000" min="0"/><input id="sellFb" type="number" value="400000" min="0"/></div>
          </div>
        </div>

        <div>
          <div class="row"><label>Feed / goat / month</label><input id="feed" type="number" value="2500" min="0"/></div>
          <div class="row"><label>Vet/med / goat / month</label><input id="med" type="number" value="0" min="0"/></div>
          <div class="row"><label>Other variable / goat / month</label><input id="othVar" type="number" value="0" min="0"/></div>
          <div class="row"><label title="Fixed costs are constant monthly.">Fixed costs / month (total)</label><input id="fixedMo" type="number" value="0" min="0"/></div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Operating break-even</small><div class="v" id="m_opbe">—</div></div>
        <div class="kpi"><small>Farm break-even (cum.)</small><div class="v" id="m_fullbe">—</div></div>
        <div class="kpi"><small>Self-sustaining (6 mo ≥0)</small><div class="v" id="m_self">—</div></div>
        <div class="kpi"><small>Net position at target</small><div class="v" id="m_netAtTarget">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartCum"></canvas>
        <div class="small">
          Money tab (C): <b>Cumulative revenue</b> vs <b>cumulative costs</b> (costs include operating + purchases + startup herd purchase at Month 0).
        </div>
      </div>

      <div class="canvasBox">
        <canvas id="chartNet"></canvas>
        <div class="small">Monthly net (all-in) including Month 0 startup purchase. Line turns green when net ≥ 0.</div>
      </div>

      <div class="canvasBox">
        <canvas id="chartRevCostMo"></canvas>
        <div class="small">Monthly revenue vs monthly total costs (operating + purchases). Helps you see when revenue consistently beats costs.</div>
      </div>
    </div>
  </div>

  <!-- Snapshot -->
  <div id="tabSnap" class="tab">
    <div class="card">
      <b class="small">Snapshot (D)</b>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><small>Time to target (det.)</small><div class="v" id="s_det">—</div></div>
        <div class="kpi"><small>P50 / P90 (MC)</small><div class="v" id="s_p50p90">—</div></div>
        <div class="kpi"><small>Target confidence</small><div class="v" id="s_conf">—</div></div>
        <div class="kpi"><small>Net revenue at target month</small><div class="v" id="s_net">—</div></div>
      </div>

      <hr/>

      <div class="kpis">
        <div class="kpi"><small>Total purchase spend (lifetime)</small><div class="v" id="s_purchSpend">—</div></div>
        <div class="kpi"><small>Total revenue (to target month)</small><div class="v" id="s_revTo">—</div></div>
        <div class="kpi"><small>Total costs (to target month)</small><div class="v" id="s_costTo">—</div></div>
        <div class="kpi"><small>Herd composition at target</small><div class="v" id="s_herdAt">—</div></div>
      </div>

      <div class="canvasBox">
        <canvas id="chartWater"></canvas>
        <div class="small">By target month (or end): Total Revenue vs Total Operating Costs vs Total Purchases → Net position.</div>
      </div>

      <div class="banner small" style="margin-top:10px">
        <b>Model assumptions (plain English):</b><br/>
        • Gestation fixed at 5 months (150 days).<br/>
        • Starting young goats are bought at ~3 months and become active after 5 months (≈ 8 months old).<br/>
        • Retained female kids can only start breeding at 8+ months.<br/>
        • Breeding happens in “events”: all eligible does attempt breeding together every kidding interval.<br/>
        • Breeding limited by buck capacity = bucks × does-per-buck.<br/>
        • Kid survival + breeding success are applied as averages.<br/>
        • Sales: male kids sold at your age; female kids retained % vs sold for breeding at 6 months (unless sales are frozen).<br/>
        • Money: variable cost = feed + vet/med + other per goat per month; fixed costs are constant monthly.<br/>
        • Break-evens: Operating BE = revenue ≥ operating costs; Farm BE = cumulative revenue ≥ cumulative costs (incl. purchases + startup). Self-sustaining = monthly net ≥ 0 for 6 consecutive months.<br/>
        • Monte Carlo (if ON): we randomize biological rates slightly (not prices).
      </div>
    </div>
  </div>

  <!-- Advisory -->
  <div id="tabAdv" class="tab">
    <div class="card">
      <b class="small">Advisory</b>
      <div class="banner small" id="advHints">Run the model to see sensitivity hints here.</div>

      <div class="grid" style="margin-top:10px">
        <div>
          <button id="btnCopyPrompt">Copy analysis prompt</button>
          <div class="small">Copies a prompt + your results so you can paste into ChatGPT for analysis.</div>
        </div>
        <div>
          <textarea id="analysisText" class="mono" rows="7" placeholder="(This will fill after Run)"></textarea>
          <div class="small">This text is what gets copied.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save/Load -->
  <div id="tabSave" class="tab">
    <div class="card">
      <b class="small">Save / Load scenarios (F) — saved to your computer</b>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="row"><label>Scenario name</label><input id="scName" value="My Scenario"/></div>
          <button id="btnSaveScenario">Save scenario (.json)</button>
          <div class="small">Downloads a file you can keep in any folder.</div>
        </div>
        <div>
          <div class="row"><label>Load scenario (.json)</label><input id="fileLoadScenario" type="file" accept="application/json"/></div>
          <button id="btnLoadLast">Load last saved (browser)</button>
          <div class="small">Optional convenience: loads last saved scenario from this browser.</div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
const N = (id)=>Number($(id)?.value ?? 0);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const roundInt=(x)=>Math.round(Number(x||0));
const money=(n)=>{
  const cur = ($("cur")?.value || "UGX").trim();
  const v = Math.round(Number(n||0));
  return `${cur} ${v.toLocaleString()}`;
};
const moFmt=(mo)=>{
  if(mo===null || mo===undefined) return "Never";
  const y = Math.floor(mo/12), m = mo%12;
  return y ? `${y}y ${m}m` : `${m} months`;
};

function initTabs(){
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      $(b.dataset.tab).classList.add("active");
    };
  });
}
initTabs();

/* =========================
   Purchases schedule
========================= */
const START_AGE_YOUNG = 3; // months old
const MAT_DELAY = 5;       // months until active (young => active)
const GEST = 5;            // gestation (months)
const F_BREED_AGE = 8;     // retained females can start breeding at 8+ months
const F_BREED_SALE_AGE = 6;// females sold for breeding at 6 months

const BUY_MONTHS = [4,8,12,16,20,24,28]; // after Month 0 only
function getYoungBuyAt(m){
  const map = {
    4:{d:N("p4d"), b:N("p4b")},
    8:{d:N("p8d"), b:N("p8b")},
    12:{d:N("p12d"), b:N("p12b")},
    16:{d:N("p16d"), b:N("p16b")},
    20:{d:N("p20d"), b:N("p20b")},
    24:{d:N("p24d"), b:N("p24b")},
    28:{d:N("p28d"), b:N("p28b")}
  };
  return map[m] || {d:0,b:0};
}

/* =========================
   Model parameters
========================= */
function getParams(){
  const cap = Math.max(0, N("acres") * N("goatsPerAcre"));

  return {
    target: N("target"),
    timeframe: N("timeframe"),
    maxMonths: N("maxMonths"),
    cap,

    // starting herd (E)
    sYd: N("sYd"), sYb: N("sYb"),
    sAd: N("sAd"), sAb: N("sAb"),

    // biology
    doesPerBuck: N("doesPerBuck"),
    kiddingInt: N("kiddingInt"),
    breedSuccess: N("breedSuccess")/100,
    kidsPerBirth: N("kidsPerBirth"),
    pctFemale: N("pctFemale")/100,
    kidSurvival: N("kidSurvival")/100,
    doeLossYr: N("doeLoss")/100,

    // sales rules
    freezeSalesMo: N("freezeSalesMo"),
    maleSaleAge: clamp(N("maleSaleAge"),1,12),
    retainF: clamp(N("retainF"),0,100)/100,

    // money
    buyYd: N("buyYd"), buyYb: N("buyYb"),
    buyAd: N("buyAd"), buyAb: N("buyAb"),
    sellM: N("sellM"), sellFb: N("sellFb"),
    feed: N("feed"), med: N("med"), othVar: N("othVar"),
    fixedMo: N("fixedMo"),

    // toggles
    mcOn: $("mcOn").value,
    mcRuns: N("mcRuns"),
    bandsOn: $("bandsOn").value
  };
}

function capFactor(herd, cap){
  if(cap<=0) return 1;
  if(herd<=cap) return 1;
  return cap / herd;
}

/* =========================
   Deterministic simulation
========================= */
function simulateDet(p){
  // Active breeders
  let does = 0;
  let bucks = 0;

  // Young start (month 0) pipelines into active after MAT_DELAY
  let youngDoePipe = Array(MAT_DELAY).fill(0);
  let youngBuckPipe = Array(MAT_DELAY).fill(0);

  // Cohorts for retained female kids until breeding age 8+
  let fToBreed = Array(F_BREED_AGE).fill(0);

  // Male kids held until sale age
  let mHold = Array(p.maleSaleAge).fill(0);

  // Female kids held for breeding sale at 6 months
  let fHoldForSale = Array(F_BREED_SALE_AGE).fill(0);

  // pregnancies: preg[m] = number of does pregnant initiated at month m (births at m+GEST)
  let preg = Array(p.maxMonths + GEST + 2).fill(0);

  // Money tracking
  let cumRev=0, cumCost=0;
  let monthlyRev=[], monthlyCost=[], monthlyNet=[];
  let cumRevSeries=[], cumCostSeries=[];
  let purchSpendSeries=[], purchCountSeries=[];
  let totPurchSpend=0, totPurchCount=0;

  // Month 0 startup purchases (young + adult) — adult immediately active; young goes into pipeline
  const startYoungDoes = p.sYd, startYoungBucks = p.sYb;
  const startAdultDoes = p.sAd, startAdultBucks = p.sAb;

  // book startup spend at month 0 (cost)
  const startSpend = (startYoungDoes*p.buyYd) + (startYoungBucks*p.buyYb) + (startAdultDoes*p.buyAd) + (startAdultBucks*p.buyAb);
  totPurchSpend += startSpend;
  totPurchCount += (startYoungDoes+startYoungBucks+startAdultDoes+startAdultBucks);

  // adult goes active immediately
  does += startAdultDoes;
  bucks += startAdultBucks;

  // young goes to pipeline now
  youngDoePipe[0] += startYoungDoes;
  youngBuckPipe[0] += startYoungBucks;

  // month-by-month
  let reachedMonth = null;
  let opBE = null, fullBE = null, selfSust = null;
  let selfRun=0;

  // helper: herd on farm includes all live animals we hold (active + young pipelines + held kids)
  function herdTotal(){
    const yD = youngDoePipe.reduce((a,b)=>a+b,0);
    const yB = youngBuckPipe.reduce((a,b)=>a+b,0);
    const yf = fToBreed.reduce((a,b)=>a+b,0) + fHoldForSale.reduce((a,b)=>a+b,0);
    const ym = mHold.reduce((a,b)=>a+b,0);
    return does + bucks + yD + yB + yf + ym;
  }

  // record month 0 net with startup spend included
  {
    const herd = herdTotal();
    const opCost = herd * (p.feed + p.med + p.othVar) + p.fixedMo;
    const cost = opCost + startSpend;
    const rev = 0;
    const net = rev - cost;

    cumRev += rev;
    cumCost += cost;

    monthlyRev.push(rev);
    monthlyCost.push(cost);
    monthlyNet.push(net);
    cumRevSeries.push(cumRev);
    cumCostSeries.push(cumCost);
    purchSpendSeries.push(startSpend);
    purchCountSeries.push(totPurchCount);

    if(opBE===null && rev >= opCost) opBE = 0;
    if(fullBE===null && cumRev >= cumCost) fullBE = 0;
    selfRun = (net>=0) ? 1 : 0;
    if(selfSust===null && selfRun>=6) selfSust = 0;
  }

  const rows=[]; // rows for charts
  rows.push(snapshotRow(0));

  function snapshotRow(m){
    const yD = youngDoePipe.reduce((a,b)=>a+b,0);
    const yB = youngBuckPipe.reduce((a,b)=>a+b,0);
    const yf = fToBreed.reduce((a,b)=>a+b,0) + fHoldForSale.reduce((a,b)=>a+b,0);
    const ym = mHold.reduce((a,b)=>a+b,0);
    const herd = does + bucks + yD + yB + yf + ym;
    return {
      m,
      does: roundInt(does),
      bucks: roundInt(bucks),
      youngD: roundInt(yD),
      youngB: roundInt(yB),
      youngF: roundInt(yf),
      youngM: roundInt(ym),
      total: roundInt(herd),
      buckCap: roundInt(bucks * p.doesPerBuck),
      buckCount: roundInt(bucks),
      cumRev: roundInt(cumRev),
      cumCost: roundInt(cumCost),
      netPos: roundInt(cumRev - cumCost),
      monthRev: roundInt(monthlyRev[m]||0),
      monthCost: roundInt(monthlyCost[m]||0),
      monthNet: roundInt(monthlyNet[m]||0),
      purchSpend: roundInt(purchSpendSeries[m]||0),
      purchCount: roundInt(purchCountSeries[m]||0),
    };
  }

  for(let m=1; m<=p.maxMonths; m++){
    // mature young pipelines into active after MAT_DELAY
    const ydTo = youngDoePipe[MAT_DELAY-1] || 0;
    const ybTo = youngBuckPipe[MAT_DELAY-1] || 0;
    for(let i=MAT_DELAY-1;i>=1;i--){ youngDoePipe[i]=youngDoePipe[i-1]; youngBuckPipe[i]=youngBuckPipe[i-1]; }
    youngDoePipe[0]=0; youngBuckPipe[0]=0;
    does += ydTo;
    bucks += ybTo;

    // breeding doe loss (monthly)
    const lossM = p.doeLossYr/12;
    does = Math.max(0, does*(1-lossM));

    // births from pregnancies initiated GEST months ago
    const pregDoes = (m-GEST>=0) ? (preg[m-GEST] || 0) : 0;
    let births = pregDoes * p.kidsPerBirth * p.kidSurvival;

    // apply carrying capacity scaling on births
    const herdBeforeBirth = herdTotal();
    births *= capFactor(herdBeforeBirth, p.cap);

    const fBorn = births * p.pctFemale;
    const mBorn = births - fBorn;

    // sales freeze logic
    const freezeOn = (m <= p.freezeSalesMo);

    // female split: retain% vs sold for breeding at 6 months (unless frozen)
    const fRet = fBorn * p.retainF;
    const fSale = fBorn - fRet;

    // add newborns into cohorts
    // retained females go into fToBreed[0], then join does at age 8 months
    fToBreed[0] += fRet;

    // males go into holding until sale age
    if(mHold.length>0) mHold[0] += mBorn;

    // females intended for breeding-sale go into 6-month hold
    fHoldForSale[0] += fSale;

    // age cohorts forward (fToBreed)
    const toDoes = fToBreed[fToBreed.length-1] || 0;
    for(let i=fToBreed.length-1;i>=1;i--) fToBreed[i]=fToBreed[i-1];
    fToBreed[0]=0;
    does += toDoes; // now 8+ months, can breed

    // age males to sale
    let maleSold = 0;
    if(mHold.length>0){
      maleSold = mHold[mHold.length-1] || 0;
      for(let i=mHold.length-1;i>=1;i--) mHold[i]=mHold[i-1];
      mHold[0]=0;
    }

    // age females for breeding sale
    let fBreedSold = fHoldForSale[F_BREED_SALE_AGE-1] || 0;
    for(let i=F_BREED_SALE_AGE-1;i>=1;i--) fHoldForSale[i]=fHoldForSale[i-1];
    fHoldForSale[0]=0;

    if(freezeOn){
      // no sales during freeze: keep them on-farm instead of selling
      // males that would be sold remain held (simple: push them back to youngest bucket)
      if(maleSold>0 && mHold.length>0) mHold[0] += maleSold;
      maleSold = 0;

      if(fBreedSold>0) fToBreed[0] += fBreedSold; // keep females for growth
      fBreedSold = 0;
    }

    // Expansion purchases at this month (young)
    const buy = getYoungBuyAt(m);
    const buyYoungDoes = buy.d;
    const buyYoungBucks = buy.b;

    // add to pipeline (young)
    if(buyYoungDoes>0) youngDoePipe[0] += buyYoungDoes;
    if(buyYoungBucks>0) youngBuckPipe[0] += buyYoungBucks;

    const purchSpend = (buyYoungDoes*p.buyYd) + (buyYoungBucks*p.buyYb);
    totPurchSpend += purchSpend;
    totPurchCount += (buyYoungDoes + buyYoungBucks);

    // breeding event (all eligible does attempt together)
    if(m % p.kiddingInt === 0){
      const capDoes = Math.max(0, bucks * p.doesPerBuck);
      const attempt = Math.min(does, capDoes);
      preg[m] = attempt * p.breedSuccess;
    } else {
      preg[m] = 0;
    }

    // money for this month
    const herd = herdTotal();
    const opCost = herd * (p.feed + p.med + p.othVar) + p.fixedMo;
    const rev = (maleSold * p.sellM) + (fBreedSold * p.sellFb);
    const cost = opCost + purchSpend;
    const net = rev - cost;

    cumRev += rev;
    cumCost += cost;

    monthlyRev.push(rev);
    monthlyCost.push(cost);
    monthlyNet.push(net);
    cumRevSeries.push(cumRev);
    cumCostSeries.push(cumCost);
    purchSpendSeries.push(purchSpend);
    purchCountSeries.push(totPurchCount);

    if(opBE===null && rev >= opCost) opBE = m;
    if(fullBE===null && cumRev >= cumCost) fullBE = m;

    selfRun = (net>=0) ? (selfRun+1) : 0;
    if(selfSust===null && selfRun>=6) selfSust = m;

    // record chart row
    rows.push(snapshotRow(m));

    if(reachedMonth===null && herd >= p.target){
      reachedMonth = m;
      break; // stop at target for clarity
    }
  }

  const endM = (reachedMonth===null) ? Math.min(p.maxMonths, rows.length-1) : reachedMonth;
  const endRow = rows[endM];

  // totals to target month
  const totalRevTo = cumRevSeries[endM] || 0;
  const totalCostTo = cumCostSeries[endM] || 0;
  const netTo = totalRevTo - totalCostTo;

  return {
    rows,
    reachedMonth,
    endM,
    endRow,
    startSpend,
    totPurchSpend,
    totPurchCount,
    totalRevTo,
    totalCostTo,
    netTo,
    opBE,
    fullBE,
    selfSust
  };
}

/* =========================
   Monte Carlo (bands + P50/P90 + confidence)
========================= */
function rng(seed){let s=seed>>>0;return ()=>{s^=s<<13;s>>>=0;s^=s>>17;s>>>=0;s^=s<<5;s>>>=0;return (s>>>0)/4294967296;};}
function jitter(r, base, pct, lo=null, hi=null){
  const v = base * (1 + ((r()-0.5)*2*pct));
  if(lo!==null || hi!==null){
    return clamp(v, lo??-Infinity, hi??Infinity);
  }
  return v;
}

function runMC(p, detEndCapMonths){
  const runs = Math.max(50, Math.floor(p.mcRuns));
  const rseed = 123456;
  const reached = [];
  const seriesTotals = []; // totals by month across runs (for bands)
  let hitTF = 0;

  for(let i=0;i<runs;i++){
    const r = rng(rseed + i*99991);

    // randomize biology only (not prices)
    const pp = {...p};
    pp.kidsPerBirth = jitter(r, p.kidsPerBirth, 0.12, 1, 3.5);
    pp.kidSurvival  = jitter(r, p.kidSurvival, 0.10, 0.4, 1.0);
    pp.breedSuccess = jitter(r, p.breedSuccess, 0.08, 0.4, 1.0);
    pp.doeLossYr    = jitter(r, p.doeLossYr, 0.15, 0.0, 0.25);

    const sim = simulateDet(pp);

    if(sim.reachedMonth !== null){
      reached.push(sim.reachedMonth);
      if(sim.reachedMonth <= p.timeframe) hitTF++;
    }

    // collect totals for bands up to a common horizon (detEndCapMonths)
    const maxM = Math.min(detEndCapMonths, sim.rows.length-1);
    for(let m=0;m<=maxM;m++){
      if(!seriesTotals[m]) seriesTotals[m]=[];
      seriesTotals[m].push(sim.rows[m].total);
    }
  }

  reached.sort((a,b)=>a-b);
  const pct = Math.round((hitTF / runs) * 100);
  const pctile=(q)=>{
    if(!reached.length) return null;
    return reached[Math.floor(q*(reached.length-1))];
  };

  // bands: p10/p50/p90 for totals by month
  const bands = seriesTotals.map(arr=>{
    if(!arr || !arr.length) return {p10:null,p50:null,p90:null};
    arr.sort((a,b)=>a-b);
    const pick=(q)=>arr[Math.floor(q*(arr.length-1))];
    return {p10:pick(0.10), p50:pick(0.50), p90:pick(0.90)};
  });

  return {runs, pct, p50:pctile(0.50), p90:pctile(0.90), best:(reached[0]??null), bands};
}

/* =========================
   Charts
========================= */
let chHerdPurch=null, chCons=null, chCum=null, chNet=null, chRevCostMo=null, chWater=null;

function makeLine(canvasId, labels, datasets, extraOptions={}){
  const ctx = $(canvasId).getContext("2d");
  return new Chart(ctx,{
    type:"line",
    data:{labels, datasets},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      aspectRatio:3.2,
      interaction:{mode:"index", intersect:false},
      plugins:{
        legend:{labels:{color:"#111", font:{weight:"800"}}},
        tooltip:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}, beginAtZero:true}
      },
      ...extraOptions
    }
  });
}

function renderCharts(p, det, mc){
  const rows = det.rows;
  const endM = det.endM;
  const slice = rows.slice(0, endM+1);
  const labels = slice.map(r=>r.m);

  // Purchases tab: herd composition + TOTAL line (A)
  const dsDoes = slice.map(r=>r.does);
  const dsBucks = slice.map(r=>r.bucks);
  const dsYoungF = slice.map(r=>r.youngF);
  const dsYoungM = slice.map(r=>r.youngM);
  const dsTotal = slice.map(r=>r.total);

  chHerdPurch?.destroy();
  chHerdPurch = makeLine("chartHerdPurch", labels, [
    {label:"Does (active)", data:dsDoes, borderWidth:2, pointRadius:0, tension:.25, fill:true, backgroundColor:"rgba(0,140,0,.12)", borderColor:"rgba(0,140,0,.85)", stack:"herd"},
    {label:"Bucks (active)", data:dsBucks, borderWidth:2, pointRadius:0, tension:.25, fill:true, backgroundColor:"rgba(0,90,180,.10)", borderColor:"rgba(0,90,180,.85)", stack:"herd"},
    {label:"Young females", data:dsYoungF, borderWidth:2, pointRadius:0, tension:.25, fill:true, backgroundColor:"rgba(0,0,0,.06)", borderColor:"rgba(0,0,0,.55)", stack:"herd"},
    {label:"Young males", data:dsYoungM, borderWidth:2, pointRadius:0, tension:.25, fill:true, backgroundColor:"rgba(180,0,0,.06)", borderColor:"rgba(180,0,0,.55)", stack:"herd"},
    {label:"TOTAL herd", data:dsTotal, borderWidth:3, pointRadius:0, tension:.2, fill:false, borderColor:"rgba(0,0,0,.85)"}
  ], {scales:{y:{stacked:true}}});

  // Growth tab: constraint + bucks on 2nd axis
  const dsCap = slice.map(r=>r.buckCap);
  const dsBLine = slice.map(r=>r.buckCount);

  chCons?.destroy();
  chCons = new Chart($("chartConstraint").getContext("2d"),{
    type:"line",
    data:{labels, datasets:[
      {label:"Breedable does", data:dsDoes, borderWidth:3, pointRadius:0, tension:.25, borderColor:"rgba(180,0,0,.85)"},
      {label:"Buck capacity (bucks×ratio)", data:dsCap, borderWidth:3, pointRadius:0, tension:.25, borderDash:[6,4], borderColor:"rgba(0,140,0,.85)"},
      {label:"Bucks (count)", data:dsBLine, yAxisID:"y2", borderWidth:2, pointRadius:0, tension:.25, borderColor:"rgba(0,90,180,.85)"}
    ]},
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:3.2,
      interaction:{mode:"index", intersect:false},
      plugins:{legend:{labels:{color:"#111", font:{weight:"800"}}}},
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}, beginAtZero:true, title:{display:true,text:"Does / Capacity"}},
        y2:{position:"right", ticks:{color:"#111"}, grid:{drawOnChartArea:false}, beginAtZero:true, title:{display:true,text:"Bucks"}}
      }
    }
  });

  // Money tab (C): cumulative revenue vs cumulative costs
  const dsCumRev = slice.map(r=>r.cumRev);
  const dsCumCost = slice.map(r=>r.cumCost);

  chCum?.destroy();
  chCum = makeLine("chartCum", labels, [
    {label:"Cumulative revenue", data:dsCumRev, borderWidth:3, pointRadius:0, tension:.15, borderColor:"rgba(0,140,0,.9)"},
    {label:"Cumulative costs", data:dsCumCost, borderWidth:3, pointRadius:0, tension:.15, borderColor:"rgba(180,0,0,.9)"}
  ]);

  // Monthly net all-in (turn green when >=0)
  const dsNet = slice.map(r=>r.monthNet);
  chNet?.destroy();
  chNet = new Chart($("chartNet").getContext("2d"),{
    type:"line",
    data:{labels, datasets:[{
      label:"Monthly net (all-in)",
      data:dsNet,
      borderWidth:3,
      pointRadius:0,
      tension:.2,
      segment:{
        borderColor: ctx => (ctx.p0.parsed.y >= 0 && ctx.p1.parsed.y >= 0) ? "rgba(0,140,0,.9)" : "rgba(180,0,0,.9)"
      }
    }]},
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:3.2,
      interaction:{mode:"index", intersect:false},
      plugins:{legend:{labels:{color:"#111", font:{weight:"800"}}}},
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}, beginAtZero:false}
      }
    }
  });

  // Monthly revenue vs monthly total costs
  const dsMoRev = slice.map(r=>r.monthRev);
  const dsMoCost = slice.map(r=>r.monthCost);
  chRevCostMo?.destroy();
  chRevCostMo = makeLine("chartRevCostMo", labels, [
    {label:"Monthly revenue", data:dsMoRev, borderWidth:3, pointRadius:0, tension:.2, borderColor:"rgba(0,140,0,.9)"},
    {label:"Monthly total costs", data:dsMoCost, borderWidth:3, pointRadius:0, tension:.2, borderColor:"rgba(180,0,0,.9)"}
  ]);

  // Snapshot waterfall (simple stacked bars)
  const totalRev = det.totalRevTo;
  const totalCostOp = Math.max(0, det.totalCostTo - det.totPurchSpend); // rough split: costs excluding purchases (includes fixed+variable+startup op in M0)
  const totalPurch = det.totPurchSpend;
  const net = det.netTo;

  chWater?.destroy();
  chWater = new Chart($("chartWater").getContext("2d"),{
    type:"bar",
    data:{
      labels:["To target month"],
      datasets:[
        {label:"Total revenue", data:[roundInt(totalRev)], backgroundColor:"rgba(0,140,0,.22)", borderColor:"rgba(0,140,0,.85)", borderWidth:2},
        {label:"Total operating costs", data:[roundInt(totalCostOp)], backgroundColor:"rgba(180,0,0,.18)", borderColor:"rgba(180,0,0,.85)", borderWidth:2},
        {label:"Total purchases", data:[roundInt(totalPurch)], backgroundColor:"rgba(0,0,0,.10)", borderColor:"rgba(0,0,0,.65)", borderWidth:2},
        {label:"Net position", data:[roundInt(net)], backgroundColor:"rgba(0,90,180,.16)", borderColor:"rgba(0,90,180,.85)", borderWidth:2}
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:true, aspectRatio:3.2,
      plugins:{legend:{labels:{color:"#111", font:{weight:"800"}}}, tooltip:{enabled:true}},
      scales:{
        x:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}},
        y:{ticks:{color:"#111"}, grid:{color:"rgba(0,0,0,.08)"}, beginAtZero:true}
      }
    }
  });

  // Optional bands: overlay on Purchases herd chart as extra datasets (p10/p50/p90 of total)
  if(p.mcOn==="on" && p.bandsOn==="on" && mc && mc.bands && mc.bands.length){
    const bSlice = mc.bands.slice(0, endM+1);
    const p10 = bSlice.map(x=>x.p10===null?null:roundInt(x.p10));
    const p50 = bSlice.map(x=>x.p50===null?null:roundInt(x.p50));
    const p90 = bSlice.map(x=>x.p90===null?null:roundInt(x.p90));

    // add bands: p90 + p10 fill
    chHerdPurch.data.datasets.push(
      {label:"Total (P90)", data:p90, borderWidth:2, pointRadius:0, tension:.2, borderColor:"rgba(0,0,0,.35)", backgroundColor:"rgba(0,0,0,.05)", fill:false},
      {label:"Total (P10)", data:p10, borderWidth:2, pointRadius:0, tension:.2, borderColor:"rgba(0,0,0,.35)", backgroundColor:"rgba(0,0,0,.05)", fill:"-1"},
      {label:"Total (P50)", data:p50, borderWidth:2, pointRadius:0, tension:.2, borderColor:"rgba(0,0,0,.55)", borderDash:[4,4], fill:false}
    );
    chHerdPurch.update();
  }
}

/* =========================
   KPIs + advisory text
========================= */
function setKPI(det, mc, p){
  // Purchases KPIs
  const startupBought = (p.sYd + p.sYb + p.sAd + p.sAb);
  $("k_startBought").textContent = `${roundInt(startupBought)} goats`;
  $("k_totalBought").textContent = `${roundInt(det.totPurchCount)} goats`;
  $("k_startSpend").textContent = money(det.startSpend);
  $("k_totalSpend").textContent = money(det.totPurchSpend);

  // Growth KPIs
  $("g_det").textContent = det.reachedMonth===null ? `Not reached in ${p.maxMonths} months` : moFmt(det.reachedMonth);

  if(p.mcOn==="on" && mc){
    $("g_p50p90").textContent = `${moFmt(mc.p50)} / ${moFmt(mc.p90)}`;
    $("g_conf").textContent = `${mc.pct}%`;
  } else {
    $("g_p50p90").textContent = "—";
    $("g_conf").textContent = "—";
  }

  // Herd at target includes TOTAL herd (B)
  const r = det.endRow;
  $("g_atTarget").textContent =
    `Does ${r.does.toLocaleString()} • Bucks ${r.bucks.toLocaleString()} • YoungF ${r.youngF.toLocaleString()} • YoungM ${r.youngM.toLocaleString()} • Total ${r.total.toLocaleString()}`;

  // Money KPIs (compute to max months if not reached already)
  $("m_opbe").textContent   = det.opBE===null ? "Never" : `Month ${det.opBE}`;
  $("m_fullbe").textContent = det.fullBE===null ? "Never" : `Month ${det.fullBE}`;
  $("m_self").textContent   = det.selfSust===null ? "Never" : `Month ${det.selfSust}`;
  $("m_netAtTarget").textContent = money(det.netTo);

  // Snapshot KPIs (D)
  $("s_det").textContent = det.reachedMonth===null ? "Never" : moFmt(det.reachedMonth);
  $("s_p50p90").textContent = (p.mcOn==="on" && mc) ? `${moFmt(mc.p50)} / ${moFmt(mc.p90)}` : "—";
  $("s_conf").textContent = (p.mcOn==="on" && mc) ? `${mc.pct}%` : "—";
  $("s_net").textContent = money(det.netTo);

  $("s_purchSpend").textContent = money(det.totPurchSpend);
  $("s_revTo").textContent = money(det.totalRevTo);
  $("s_costTo").textContent = money(det.totalCostTo);

  $("s_herdAt").textContent =
    `Does ${r.does.toLocaleString()} • Bucks ${r.bucks.toLocaleString()} • YoungF ${r.youngF.toLocaleString()} • YoungM ${r.youngM.toLocaleString()} • Total ${r.total.toLocaleString()}`;

  // Advisory (simple sensitivity hint: +2 does at Month 4)
  const baseMonths = det.reachedMonth;
  let hint = "Run the model to see hints.";

  if(baseMonths !== null){
    const p2 = {...p};
    // temporarily bump month 4 young does by +2 for sensitivity
    const orig = N("p4d");
    const tmp = orig + 2;

    // quick hack: simulate by overriding DOM? safer: compute extra in sim by changing input for that run only
    // We'll do a local simulate with a patched getYoungBuyAt by temporarily swapping value.
    const save = $("p4d").value;
    $("p4d").value = String(tmp);
    const det2 = simulateDet(p2);
    $("p4d").value = save;

    const newMonths = det2.reachedMonth;
    if(newMonths !== null){
      const delta = baseMonths - newMonths;
      hint = delta>0
        ? `Sensitivity: adding <b>+2 young does</b> at <b>Month 4</b> saves about <b>${delta}</b> month(s) to target in the deterministic run.`
        : `Sensitivity: adding <b>+2 young does</b> at <b>Month 4</b> does not speed up time-to-target with current constraints (likely buck capacity or costs).`;
    } else {
      hint = `Sensitivity: adding <b>+2 young does</b> at <b>Month 4</b> still didn’t reach target within max months (constraints likely binding).`;
    }
  }
  $("advHints").innerHTML = hint;

  // Analysis prompt text
  const payload = {
    inputs: getAllInputs().inputs,
    results:{
      reachedMonth: det.reachedMonth,
      timeframe: p.timeframe,
      netAtTarget: det.netTo,
      purchasesSpend: det.totPurchSpend,
      revenueToTarget: det.totalRevTo,
      costsToTarget: det.totalCostTo,
      herdAtTarget: det.endRow
    },
    monteCarlo: (p.mcOn==="on" && mc) ? {runs:mc.runs, confidencePct:mc.pct, p50:mc.p50, p90:mc.p90} : null
  };

  const txt =
`You are my farm analyst. Using the JSON below:
1) Tell me if this plan reaches my target herd in time and if not, what’s the bottleneck (buck capacity, maturity, costs).
2) Suggest a simple Month 4/8/12/16/20/24/28 purchase plan (young does/bucks) to hit target sooner WITHOUT making final net position negative.
3) Point out the top 3 levers that improve net position (prices, costs, sales-freeze, buck ratio).
4) Explain any risks you see in the assumptions.

JSON:
${JSON.stringify(payload, null, 2)}
`;
  $("analysisText").value = txt;
}

/* =========================
   Save / Load (F)
========================= */
function getAllInputs(){
  const els = Array.from(document.querySelectorAll("input, select, textarea"))
    .filter(el => el.id && !el.disabled);

  const inputs = {};
  for(const el of els){
    if(el.type === "file") continue;
    if(el.type === "checkbox") inputs[el.id] = !!el.checked;
    else inputs[el.id] = el.value;
  }
  return {inputs};
}

function setAllInputs(data){
  for(const [id,val] of Object.entries(data || {})){
    const el = $(id);
    if(!el) continue;
    if(el.type === "checkbox") el.checked = !!val;
    else el.value = val;
  }
}

function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 700);
}

const LS_KEY = "goatFarmScenarioLast";

$("btnSaveScenario").onclick = ()=>{
  const name = ($("scName").value || "scenario").trim().replace(/\s+/g,"_");
  const payload = {
    name,
    savedAt: new Date().toISOString(),
    ...getAllInputs()
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
  downloadJSON(`goatfarm_${name}.json`, payload);
};

$("btnLoadLast").onclick = ()=>{
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return alert("No saved scenario in this browser yet.");
  const payload = JSON.parse(raw);
  if(!payload?.inputs) return alert("Saved scenario is invalid.");
  setAllInputs(payload.inputs);
};

$("fileLoadScenario").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  const payload = JSON.parse(text);
  if(!payload?.inputs) return alert("That file doesn't look like a scenario export.");
  setAllInputs(payload.inputs);
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
});

/* =========================
   Copy analysis prompt
========================= */
$("btnCopyPrompt").onclick = async ()=>{
  const txt = $("analysisText").value || "";
  if(!txt.trim()) return alert("Run the model first.");
  try{
    await navigator.clipboard.writeText(txt);
    alert("Copied.");
  } catch(e){
    alert("Could not copy automatically. You can select + copy the text manually.");
  }
};

/* =========================
   Run
========================= */
async function runAll(){
  // spinner always 1.5 seconds
  $("spinner").style.display = "inline-block";

  const p = getParams();

  // deterministic
  const det = simulateDet(p);

  // MC if on
  let mc = null;
  if(p.mcOn==="on"){
    // common horizon for bands: up to det.endM (stop at target)
    mc = runMC(p, det.endM);
  }

  // render
  renderCharts(p, det, mc);
  setKPI(det, mc, p);

  // stop spinner after 1.5s (even if fast)
  setTimeout(()=>{$("spinner").style.display="none";}, 1500);
}

$("runBtn").onclick = runAll;

// Run once on load (so you see something immediately)
runAll();
</script>
</body>
</html>
